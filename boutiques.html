<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B00">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="/oda1.png">
    <title>ODA Market ‚Äî Boutiques</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="oda1.png">
    <link rel="stylesheet" href="boutiques.css">
</head>
<style>
    /* ================================================================
   ODA BOUTIQUES ‚Äî SNAPCHAT STYLE ‚Äî CSS3
   Fonts: Syne (display) + DM Sans (body)
   ================================================================ */

/* ‚ïê‚ïê VARIABLES ‚ïê‚ïê */
:root {
    --primary:        #FF6B00;
    --primary-dark:   #D45B00;
    --primary-glow:   rgba(255, 107, 0, 0.4);
    --primary-soft:   rgba(255, 107, 0, 0.12);
    --bg:             #0C0E14;
    --bg-2:           #13161F;
    --bg-card:        #181C28;
    --surface:        #1E2235;
    --surface-2:      #252A3E;
    --border:         rgba(255,255,255,0.07);
    --border-accent:  rgba(255, 107, 0, 0.35);
    --text-1:         #F0F4FF;
    --text-2:         #8896B3;
    --text-3:         #4A556B;
    --gold:           #F5A623;
    --silver:         #9BB3CC;
    --bronze:         #C47D4A;
    --success:        #00D68F;
    --error:          #FF4D6D;
    --snap-yellow:    #FFFC00;
    --snap-black:     #000000;
    --story-ring-1:   #FF6B00;
    --story-ring-2:   #FF9500;
    --radius-s:       10px;
    --radius-m:       16px;
    --radius-l:       22px;
    --radius-xl:      30px;
    --radius-full:    9999px;
    --hdr-h:          112px;
    --font-display:   'Syne', sans-serif;
    --font-body:      'DM Sans', sans-serif;
    --ease-bounce:    cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease-out:       cubic-bezier(0.4, 0, 0.2, 1);
    --t-fast:         0.18s var(--ease-out);
    --t-norm:         0.28s var(--ease-out);
    --t-bounce:       0.38s var(--ease-bounce);
    --shadow-card:    0 8px 32px rgba(0,0,0,0.5);
    --shadow-glow:    0 0 30px var(--primary-glow);
}

/* ‚ïê‚ïê RESET ‚ïê‚ïê */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
    -webkit-font-smoothing: antialiased;
}

html {
    scroll-behavior: smooth;
    overflow-x: hidden;
}

body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text-1);
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: env(safe-area-inset-bottom, 20px);
}

a { text-decoration: none; color: inherit; }

/* ‚ïê‚ïê PAGE LOADER ‚ïê‚ïê */
.page-loader {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
    transition: opacity 0.55s var(--ease-out), visibility 0.55s;
}

.page-loader.fade-out {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

.loader-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    width: 200px;
}

.loader-ring {
    position: relative;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loader-emoji {
    font-size: 2rem;
    position: absolute;
    z-index: 2;
    animation: emojiBounce 1.6s ease-in-out infinite;
}

@keyframes emojiBounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

.loader-svg {
    width: 80px;
    height: 80px;
    position: absolute;
    top: 0; left: 0;
    transform: rotate(-90deg);
}

.loader-track {
    fill: none;
    stroke: rgba(255,255,255,0.08);
    stroke-width: 5;
}

.loader-fill {
    fill: none;
    stroke: var(--primary);
    stroke-width: 5;
    stroke-linecap: round;
    stroke-dasharray: 226;
    stroke-dashoffset: 226;
    animation: loaderSpin 1.8s ease-in-out infinite;
    filter: drop-shadow(0 0 6px var(--primary));
}

@keyframes loaderSpin {
    0%   { stroke-dashoffset: 226; }
    50%  { stroke-dashoffset: 56; }
    100% { stroke-dashoffset: 226; }
}

.loader-label {
    font-family: var(--font-display);
    font-size: 0.8rem;
    color: var(--text-3);
    letter-spacing: 0.06em;
    text-transform: uppercase;
}

.loader-bar-wrap {
    width: 100%;
    height: 3px;
    background: rgba(255,255,255,0.07);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.loader-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--primary), #FF9500);
    border-radius: var(--radius-full);
    transition: width 0.3s var(--ease-out);
    box-shadow: 0 0 10px var(--primary-glow);
}

/* ‚ïê‚ïê OVERLAY ‚ïê‚ïê */
.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 1999;
    opacity: 0;
    visibility: hidden;
    transition: all var(--t-norm);
}

.overlay.active { opacity: 1; visibility: visible; }

/* ‚ïê‚ïê SIDE MENU ‚ïê‚ïê */
.side-menu {
    position: fixed;
    top: 0; left: 0;
    width: 270px;
    height: 100vh;
    height: 100dvh;
    background: #0F121A;
    border-right: 1px solid var(--border);
    z-index: 2000;
    transform: translateX(-100%);
    transition: transform 0.32s var(--ease-out);
    display: flex;
    flex-direction: column;
    padding: env(safe-area-inset-top, 0) 0 0;
    box-shadow: 6px 0 40px rgba(0,0,0,0.6);
}

.side-menu.active { transform: translateX(0); }

.side-menu-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 18px 18px;
    border-bottom: 1px solid var(--border);
}

.side-menu-logo {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--text-1);
    letter-spacing: -0.02em;
}

.side-menu-close {
    width: 34px; height: 34px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-s);
    color: var(--text-2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--t-fast);
}

.side-menu-close:hover { background: var(--error); color: white; border-color: var(--error); }

.side-menu-nav {
    padding: 16px 12px;
    flex: 1;
    overflow-y: auto;
}

.side-nav-label {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
    padding: 0 8px;
    margin-bottom: 10px;
}

.side-nav-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 12px;
    border-radius: var(--radius-s);
    color: var(--text-2);
    font-size: 0.9rem;
    font-weight: 500;
    transition: all var(--t-fast);
    margin-bottom: 4px;
}

.side-nav-link:hover,
.side-nav-link.active {
    background: var(--primary-soft);
    color: var(--primary);
}

/* ‚ïê‚ïê HEADER ‚ïê‚ïê */
.app-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    background: rgba(12, 14, 20, 0.92);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding-top: env(safe-area-inset-top, 0);
    transition: box-shadow var(--t-norm);
}

.app-header.scrolled {
    box-shadow: 0 4px 30px rgba(0,0,0,0.5);
}

.app-header-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px 6px;
}

.hdr-btn {
    width: 38px; height: 38px;
    border: none;
    background: rgba(255,255,255,0.05);
    border-radius: var(--radius-s);
    color: var(--text-1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--t-fast);
}

.hdr-btn:hover { background: rgba(255,255,255,0.1); }

.hdr-center {
    display: flex;
    align-items: center;
    gap: 7px;
}

.hdr-logo-icon { font-size: 1.4rem; }

.hdr-logo-text {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--text-1);
    letter-spacing: -0.03em;
}

.hdr-right { display: flex; gap: 6px; align-items: center; }

/* Search */
.hdr-search {
    padding: 0 14px 10px;
}

.search-box {
    display: flex;
    align-items: center;
    gap: 9px;
    background: rgba(255,255,255,0.06);
    border: 1.5px solid rgba(255,255,255,0.09);
    border-radius: var(--radius-full);
    padding: 9px 14px;
    transition: all var(--t-norm);
}

.search-box:focus-within {
    background: rgba(255,255,255,0.1);
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(255,107,0,0.12);
}

.search-ico { color: var(--text-3); flex-shrink: 0; transition: color var(--t-fast); }
.search-box:focus-within .search-ico { color: var(--primary); }

#shopSearchInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    font-family: var(--font-body);
    font-size: 0.88rem;
    font-weight: 500;
    color: var(--text-1);
}

#shopSearchInput::placeholder { color: var(--text-3); }

.search-clear {
    display: none;
    width: 24px; height: 24px;
    border: none;
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
    color: var(--text-2);
    cursor: pointer;
    align-items: center;
    justify-content: center;
    transition: all var(--t-fast);
    flex-shrink: 0;
}

.search-clear.visible { display: flex; }
.search-clear:hover { background: var(--error); color: white; }

.hdr-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 4px 0;
}

.meta-pill { font-size: 0.72rem; color: var(--text-3); font-weight: 500; }
.meta-pill b { color: var(--primary); font-weight: 700; }
.meta-dot { color: var(--text-3); font-size: 0.72rem; }

/* ‚ïê‚ïê MAIN LAYOUT ‚ïê‚ïê */
.snap-main {
    padding-top: var(--hdr-h);
    min-height: 100vh;
}

/* ‚ïê‚ïê STORIES BAR ‚ïê‚ïê */
.stories-bar-wrap {
    padding: 16px 0 0;
    background: var(--bg);
}

.stories-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 16px 10px;
}

.stories-label-icon { font-size: 1rem; }

.stories-label-txt {
    font-family: var(--font-display);
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
}

.stories-bar {
    display: flex;
    gap: 14px;
    padding: 4px 16px 18px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
}

.stories-bar::-webkit-scrollbar { display: none; }

/* ‚îÄ‚îÄ Story Item ‚îÄ‚îÄ */
.story-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    cursor: pointer;
    scroll-snap-align: start;
    animation: storyIn 0.5s var(--ease-bounce) backwards;
}

@keyframes storyIn {
    from { opacity: 0; transform: scale(0.7) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
}

.story-ring-outer {
    width: 70px; height: 70px;
    border-radius: 50%;
    background: conic-gradient(var(--primary) 0%, var(--snap-yellow) 50%, var(--primary) 100%);
    padding: 3px;
    position: relative;
    transition: transform var(--t-bounce);
}

.story-item:hover .story-ring-outer,
.story-item:active .story-ring-outer {
    transform: scale(1.08);
}

.story-ring-outer.rank-1 {
    background: conic-gradient(#F5A623, #FFD700, #F5A623, #A07000, #F5A623);
    box-shadow: 0 0 14px rgba(245, 166, 35, 0.6);
}

.story-ring-outer.rank-2 {
    background: conic-gradient(#9BB3CC, #CDD8E3, #9BB3CC);
    box-shadow: 0 0 10px rgba(155, 179, 204, 0.4);
}

.story-ring-outer.rank-3 {
    background: conic-gradient(#C47D4A, #E8A87C, #C47D4A);
    box-shadow: 0 0 10px rgba(196, 125, 74, 0.4);
}

.story-ring-inner {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 3px solid var(--bg);
    overflow: hidden;
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.6rem;
}

.story-ring-inner img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.story-rank-badge {
    position: absolute;
    bottom: -2px; right: -2px;
    width: 22px; height: 22px;
    border-radius: 50%;
    border: 2px solid var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
    font-weight: 900;
    font-family: var(--font-display);
    z-index: 2;
}

.story-rank-badge.gold   { background: linear-gradient(135deg, #F5A623, #D4820A); color: white; }
.story-rank-badge.silver { background: linear-gradient(135deg, #9BB3CC, #6B8AA5); color: white; }
.story-rank-badge.bronze { background: linear-gradient(135deg, #C47D4A, #9A5A2A); color: white; }
.story-rank-badge.other  { background: var(--surface-2); color: var(--text-3); font-size: 0.55rem; }

.story-name {
    font-family: var(--font-body);
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-2);
    text-align: center;
    max-width: 64px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.story-subs {
    font-size: 0.6rem;
    color: var(--primary);
    font-weight: 700;
}

/* ‚îÄ‚îÄ Story Skeleton ‚îÄ‚îÄ */
.story-skel {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
}

.story-skel-ring {
    width: 70px; height: 70px;
    border-radius: 50%;
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
}

.story-skel-name {
    width: 50px; height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
}

@keyframes shimmer {
    0%   { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* ‚ïê‚ïê SNAP DIVIDER ‚ïê‚ïê */
.snap-divider {
    padding: 6px 16px 14px;
    background: var(--bg);
}

.snap-divider-line {
    height: 1px;
    background: var(--border);
    margin-bottom: 12px;
}

.snap-divider-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.snap-divider-txt {
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-3);
}

.snap-sort-wrap {
    position: relative;
}

.snap-sort {
    appearance: none;
    -webkit-appearance: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    padding: 6px 30px 6px 12px;
    font-family: var(--font-body);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-2);
    cursor: pointer;
    outline: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%238896B3' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    transition: all var(--t-fast);
}

.snap-sort:focus {
    border-color: var(--primary);
    color: var(--primary);
}

/* ‚ïê‚ïê DISCOVER GRID (Snapchat Tiles) ‚ïê‚ïê */
.discover-section {
    padding: 0 10px 32px;
    background: var(--bg);
}

/* Masonry-style: 2 columns on mobile, adapts to content */
.discover-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

/* Featured card (first of every 5) takes full width */
.discover-grid .tile-card:nth-child(5n+1) {
    grid-column: 1 / -1;
}

@media (min-width: 480px) {
    .discover-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
}

@media (min-width: 720px) {
    .discover-grid { grid-template-columns: repeat(3, 1fr); gap: 14px; }
    .discover-grid .tile-card:nth-child(5n+1) { grid-column: span 1; }
    .discover-grid .tile-card:nth-child(7n+1) { grid-column: 1 / -1; }
}

@media (min-width: 1024px) {
    .discover-section { padding: 0 16px 40px; }
    .discover-grid { grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .discover-grid .tile-card:nth-child(7n+1) { grid-column: span 1; }
    .discover-grid .tile-card:nth-child(9n+1) { grid-column: span 2; }
}

/* ‚îÄ‚îÄ Tile Card ‚îÄ‚îÄ */
.tile-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-l);
    overflow: hidden;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    transition: transform var(--t-bounce), box-shadow var(--t-norm), border-color var(--t-norm);
    animation: tileIn 0.45s var(--ease-bounce) backwards;
}

@keyframes tileIn {
    from { opacity: 0; transform: scale(0.88) translateY(16px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
}

.tile-card:hover {
    transform: translateY(-4px) scale(1.01);
    border-color: var(--border-accent);
    box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,107,0,0.08);
}

.tile-card:active { transform: scale(0.97); }

/* Rank borders */
.tile-card.rank-1 { border-color: rgba(245, 166, 35, 0.45); }
.tile-card.rank-2 { border-color: rgba(155, 179, 204, 0.35); }
.tile-card.rank-3 { border-color: rgba(196, 125, 74, 0.35); }

/* ‚îÄ‚îÄ Tile Cover (image/color zone) ‚îÄ‚îÄ */
.tile-cover {
    height: 90px;
    position: relative;
    overflow: hidden;
    background: var(--surface);
    flex-shrink: 0;
}

/* Full-width featured card gets taller cover */
.tile-card:nth-child(5n+1) .tile-cover,
.tile-card.tile-featured .tile-cover {
    height: 140px;
}

.tile-cover-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    transition: transform 0.5s var(--ease-out);
}

.tile-card:hover .tile-cover-bg { transform: scale(1.06); }

.tile-cover-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom,
        rgba(0,0,0,0) 0%,
        rgba(0,0,0,0.6) 100%
    );
}

/* Cover top badges */
.tile-cover-badges {
    position: absolute;
    top: 8px; left: 8px;
    display: flex;
    gap: 5px;
    z-index: 2;
}

.tile-badge {
    font-size: 0.62rem;
    font-weight: 700;
    font-family: var(--font-display);
    padding: 3px 8px;
    border-radius: var(--radius-full);
    backdrop-filter: blur(8px);
    letter-spacing: 0.04em;
}

.tile-badge-rank {
    background: rgba(0,0,0,0.6);
    color: white;
    border: 1px solid rgba(255,255,255,0.15);
}

.tile-badge-rank.gold   { background: rgba(245, 166, 35, 0.85); color: #000; border: none; }
.tile-badge-rank.silver { background: rgba(155, 179, 204, 0.85); color: #000; border: none; }
.tile-badge-rank.bronze { background: rgba(196, 125, 74, 0.85); color: #fff; border: none; }

.tile-badge-verified {
    background: rgba(0, 214, 143, 0.2);
    color: var(--success);
    border: 1px solid rgba(0, 214, 143, 0.3);
}

/* Subscribe badge on cover */
.tile-cover-sub {
    position: absolute;
    top: 8px; right: 8px;
    z-index: 2;
}

.tile-sub-btn {
    width: 30px; height: 30px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.9rem;
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.55);
    color: var(--text-2);
    transition: all var(--t-bounce);
    line-height: 1;
}

.tile-sub-btn:hover,
.tile-sub-btn.subbed {
    background: rgba(0, 214, 143, 0.25);
    color: var(--success);
    transform: scale(1.15);
}

.tile-sub-btn.loading { opacity: 0.5; pointer-events: none; }

/* ‚îÄ‚îÄ Tile Body ‚îÄ‚îÄ */
.tile-body {
    padding: 11px 12px 13px;
    display: flex;
    flex-direction: column;
    gap: 9px;
    flex: 1;
}

.tile-top-row {
    display: flex;
    align-items: center;
    gap: 9px;
}

.tile-avatar {
    width: 38px; height: 38px;
    border-radius: var(--radius-s);
    object-fit: cover;
    border: 1.5px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
    transition: transform var(--t-bounce);
}

.tile-card:hover .tile-avatar { transform: scale(1.08) rotate(2deg); }

.tile-avatar-placeholder {
    width: 38px; height: 38px;
    border-radius: var(--radius-s);
    background: var(--surface-2);
    border: 1.5px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
    transition: transform var(--t-bounce);
}

.tile-card:hover .tile-avatar-placeholder { transform: scale(1.08) rotate(2deg); }

.tile-name-wrap { flex: 1; min-width: 0; }

.tile-name {
    font-family: var(--font-display);
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--text-1);
    letter-spacing: -0.01em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
    margin-bottom: 2px;
}

.tile-slug {
    font-size: 0.67rem;
    color: var(--text-3);
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ‚îÄ‚îÄ Stats chips ‚îÄ‚îÄ */
.tile-stats {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: var(--radius-full);
    font-size: 0.66rem;
    font-weight: 700;
    white-space: nowrap;
    line-height: 1;
}

.chip svg { width: 11px; height: 11px; flex-shrink: 0; }

.chip-likes {
    background: rgba(255, 77, 109, 0.1);
    border: 1px solid rgba(255, 77, 109, 0.2);
    color: #FF4D6D;
}

.chip-products {
    background: rgba(96, 165, 250, 0.1);
    border: 1px solid rgba(96, 165, 250, 0.2);
    color: #60A5FA;
}

.chip-subs {
    background: var(--primary-soft);
    border: 1px solid rgba(255, 107, 0, 0.2);
    color: var(--primary);
}

/* ‚îÄ‚îÄ Description preview ‚îÄ‚îÄ */
.tile-desc {
    font-size: 0.71rem;
    color: var(--text-2);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* ‚îÄ‚îÄ Action bar ‚îÄ‚îÄ */
.tile-actions {
    display: flex;
    gap: 6px;
    margin-top: auto;
}

.tile-btn-sub {
    flex: 1;
    padding: 8px 10px;
    border-radius: var(--radius-s);
    border: 1.5px solid rgba(255,255,255,0.09);
    background: var(--surface);
    color: var(--text-2);
    font-family: var(--font-body);
    font-size: 0.74rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: all var(--t-bounce);
    position: relative;
    overflow: hidden;
}

.tile-btn-sub::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    opacity: 0;
    transition: opacity var(--t-fast);
}

.tile-btn-sub:hover::after { opacity: 0.12; }

.tile-btn-sub.subscribed {
    border-color: rgba(0, 214, 143, 0.35);
    color: var(--success);
    background: rgba(0, 214, 143, 0.08);
}

.tile-btn-sub.loading { opacity: 0.55; pointer-events: none; }

.tile-btn-visit {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 8px 14px;
    border-radius: var(--radius-s);
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-family: var(--font-body);
    font-size: 0.74rem;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
    transition: all var(--t-bounce);
}

.tile-btn-visit:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 18px rgba(255, 107, 0, 0.45);
}

/* ‚îÄ‚îÄ Tile Skeleton ‚îÄ‚îÄ */
.tile-skel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-l);
    overflow: hidden;
    animation: tileIn 0.45s var(--ease-bounce) backwards;
}

.tile-skel-cover {
    height: 90px;
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
}

.tile-skel-body { padding: 11px 12px; display: flex; flex-direction: column; gap: 9px; }
.tile-skel-row { display: flex; gap: 9px; align-items: center; }
.tile-skel-av { width: 38px; height: 38px; border-radius: var(--radius-s); flex-shrink: 0; background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.4s ease-in-out infinite; }
.tile-skel-lines { flex: 1; display: flex; flex-direction: column; gap: 5px; }
.tile-skel-line { height: 10px; border-radius: 4px; background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.4s ease-in-out infinite; }
.tile-skel-line.w70 { width: 70%; }
.tile-skel-line.w45 { width: 45%; }
.tile-skel-chips { display: flex; gap: 5px; }
.tile-skel-chip { height: 22px; width: 60px; border-radius: var(--radius-full); background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.4s ease-in-out infinite; }
.tile-skel-btns { display: flex; gap: 6px; }
.tile-skel-btn { height: 34px; flex: 1; border-radius: var(--radius-s); background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%); background-size: 200% 100%; animation: shimmer 1.4s ease-in-out infinite; }

/* ‚ïê‚ïê EMPTY STATE ‚ïê‚ïê */
.snap-empty {
    padding: 60px 24px;
    text-align: center;
}

.snap-empty-icon {
    font-size: 3.5rem;
    margin-bottom: 16px;
    display: block;
}

.snap-empty h3 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--text-2);
    margin-bottom: 8px;
    letter-spacing: -0.02em;
}

.snap-empty p {
    font-size: 0.85rem;
    color: var(--text-3);
    margin-bottom: 20px;
}

.snap-btn-reset {
    padding: 10px 22px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    color: var(--text-2);
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--t-fast);
}

.snap-btn-reset:hover { border-color: var(--primary); color: var(--primary); }

/* ‚ïê‚ïê LOAD MORE ‚ïê‚ïê */
.snap-load-more-wrap {
    padding: 20px 0 10px;
    text-align: center;
}

.snap-load-more-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-full);
    color: var(--text-2);
    font-family: var(--font-body);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--t-bounce);
}

.snap-load-more-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--primary-soft);
    transform: translateY(-2px);
}

/* ‚ïê‚ïê TOAST ‚ïê‚ïê */
.toast-container {
    position: fixed;
    bottom: calc(20px + env(safe-area-inset-bottom, 0));
    right: 14px;
    left: 14px;
    z-index: 99998;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
    pointer-events: none;
}

.toast {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: var(--radius-m);
    padding: 12px 16px;
    font-size: 0.84rem;
    font-weight: 600;
    color: var(--text-1);
    box-shadow: 0 8px 30px rgba(0,0,0,0.55);
    pointer-events: all;
    animation: toastIn 0.4s var(--ease-bounce);
    max-width: 380px;
    width: fit-content;
    margin: 0 auto;
    backdrop-filter: blur(14px);
}

@keyframes toastIn {
    from { opacity: 0; transform: translateY(20px) scale(0.9); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
}

.toast.fade-out { animation: toastOut 0.3s ease forwards; }
@keyframes toastOut { to { opacity: 0; transform: translateY(10px) scale(0.92); } }

.toast.success { border-color: rgba(0, 214, 143, 0.4); }
.toast.error   { border-color: rgba(255, 77, 109, 0.4); }
.toast.info    { border-color: rgba(255, 107, 0, 0.4); }
.toast-icon    { font-size: 1.1rem; }

/* ‚ïê‚ïê MODAL (bottom sheet style) ‚ïê‚ïê */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 5000;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all var(--t-norm);
}

.modal-overlay.active { opacity: 1; visibility: visible; }

.modal-sheet {
    background: var(--bg-card);
    border-top-left-radius: 28px;
    border-top-right-radius: 28px;
    border: 1px solid var(--border);
    border-bottom: none;
    width: 100%;
    max-width: 520px;
    max-height: 90vh;
    max-height: 90dvh;
    overflow-y: auto;
    position: relative;
    transform: translateY(100%);
    transition: transform 0.4s var(--ease-bounce);
    box-shadow: 0 -20px 60px rgba(0,0,0,0.6);
    padding-bottom: env(safe-area-inset-bottom, 20px);
}

.modal-overlay.active .modal-sheet { transform: translateY(0); }

.modal-drag-handle {
    width: 40px; height: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: var(--radius-full);
    margin: 12px auto 0;
}

.modal-close {
    position: absolute;
    top: 12px; right: 14px;
    width: 32px; height: 32px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 50%;
    color: var(--text-2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--t-fast);
    z-index: 2;
}

.modal-close:hover { background: var(--error); color: white; border-color: var(--error); }

/* Modal inner content */
.modal-shop-cover {
    height: 8px;
    width: 100%;
    background: linear-gradient(90deg, var(--shop-color, var(--primary)), transparent);
}

.modal-body-inner { padding: 20px 20px 24px; }

.modal-shop-header {
    display: flex;
    gap: 14px;
    align-items: center;
    margin-bottom: 20px;
    padding-top: 4px;
}

.modal-shop-avatar {
    width: 72px; height: 72px;
    border-radius: var(--radius-m);
    object-fit: cover;
    border: 2px solid var(--border);
    flex-shrink: 0;
}

.modal-shop-avatar-ph {
    width: 72px; height: 72px;
    border-radius: var(--radius-m);
    background: var(--surface-2);
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    flex-shrink: 0;
}

.modal-shop-info { flex: 1; min-width: 0; }

.modal-shop-name {
    font-family: var(--font-display);
    font-size: 1.3rem;
    font-weight: 800;
    color: var(--text-1);
    letter-spacing: -0.03em;
    margin-bottom: 4px;
    word-break: break-word;
}

.modal-shop-slug {
    font-size: 0.77rem;
    color: var(--text-3);
    font-weight: 500;
}

.modal-verified {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-size: 0.68rem;
    font-weight: 700;
    color: var(--success);
    background: rgba(0, 214, 143, 0.12);
    border: 1px solid rgba(0, 214, 143, 0.2);
    border-radius: var(--radius-full);
    padding: 2px 8px;
    margin-top: 4px;
}

.modal-stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 20px;
}

.modal-stat-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-m);
    padding: 12px 8px;
    text-align: center;
}

.modal-stat-num {
    font-family: var(--font-display);
    font-size: 1.3rem;
    font-weight: 900;
    color: var(--text-1);
    letter-spacing: -0.03em;
    line-height: 1;
    margin-bottom: 4px;
}

.modal-stat-label {
    font-size: 0.66rem;
    color: var(--text-3);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.modal-desc {
    font-size: 0.84rem;
    color: var(--text-2);
    line-height: 1.6;
    margin-bottom: 18px;
}

.modal-actions { display: flex; gap: 10px; }

.modal-btn-sub {
    flex: 1;
    padding: 13px;
    border-radius: var(--radius-s);
    border: 1.5px solid rgba(255,255,255,0.1);
    background: var(--surface);
    color: var(--text-2);
    font-family: var(--font-body);
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all var(--t-bounce);
}

.modal-btn-sub.subscribed {
    border-color: rgba(0, 214, 143, 0.4);
    color: var(--success);
    background: rgba(0, 214, 143, 0.08);
}

.modal-btn-visit {
    flex: 1;
    padding: 13px;
    border-radius: var(--radius-s);
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-family: var(--font-body);
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 16px rgba(255,107,0,0.3);
    transition: all var(--t-bounce);
}

.modal-btn-visit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 22px rgba(255,107,0,0.5);
}

/* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface-2); border-radius: 99px; }
::-webkit-scrollbar-thumb:hover { background: var(--primary); }

/* ‚ïê‚ïê UTILITIES ‚ïê‚ïê */
.sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
}
</style>
<body>

<!-- ‚ïê‚ïê PAGE LOADER ‚ïê‚ïê -->
<div class="page-loader" id="pageLoader">
    <div class="loader-inner">
        <div class="loader-ring">
            <span class="loader-emoji">üõçÔ∏è</span>
            <svg class="loader-svg" viewBox="0 0 80 80">
                <circle class="loader-track" cx="40" cy="40" r="36"/>
                <circle class="loader-fill" cx="40" cy="40" r="36"/>
            </svg>
        </div>
        <p class="loader-label" id="loaderText">Chargement...</p>
        <div class="loader-bar-wrap">
            <div class="loader-bar" id="loaderBarFill"></div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê SIDE MENU ‚ïê‚ïê -->
<div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
        <span class="side-menu-logo">üõçÔ∏è ODA</span>
        <button class="side-menu-close" id="closeMenuBtn" onclick="closeMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>
    <nav class="side-menu-nav">
        <p class="side-nav-label">Navigation</p>
        <a href="oda-achats.html" class="side-nav-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2"/></svg>
            Accueil
        </a>
        <a href="favorie.html" class="side-nav-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2"/></svg>
            Mes Favoris
        </a>
        <a href="boutiques.html" class="side-nav-link active">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z" stroke="currentColor" stroke-width="2"/><path d="M3 9l1.5-5h15L21 9" stroke="currentColor" stroke-width="2"/></svg>
            Boutiques
        </a>
    </nav>
</div>
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header class="app-header" id="mainHeader">
    <div class="app-header-inner">
        <button class="hdr-btn" id="menuBtn" onclick="openMenu()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="15" y2="18"/>
            </svg>
        </button>

        <div class="hdr-center">
            <span class="hdr-logo-icon">üõçÔ∏è</span>
            <span class="hdr-logo-text">Odamarket</span>
        </div>

        <div class="hdr-right">
            <button class="hdr-btn" onclick="window.location.href='favorie.html'" title="Favoris">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                </svg>
            </button>
            <button class="hdr-btn vendor-btn" id="vendorBtn" title="Espace Vendeur">
                <img src="oda-logo.png" alt="ODA" style="width:22px;height:22px;border-radius:5px;object-fit:cover;">
            </button>
        </div>
    </div>

    <!-- Search -->
    <div class="hdr-search">
        <div class="search-box" id="searchWrapper">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="search-ico">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="text" id="shopSearchInput" placeholder="Rechercher une boutique..." autocomplete="off" spellcheck="false">
            <button class="search-clear" id="searchClear">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>

        <div class="hdr-meta">
            <span class="meta-pill"><b id="totalShopsNum">‚Äì</b> boutiques</span>
            <span class="meta-dot">¬∑</span>
            <span class="meta-pill"><b id="totalSubscribedNum">‚Äì</b> abonnements</span>
        </div>
    </div>
</header>

<!-- ‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê -->
<main class="snap-main" id="snapMain">

    <!-- ‚îÄ‚îÄ STORIES BAR (Top 10) ‚îÄ‚îÄ -->
    <section class="stories-bar-wrap" id="top10Section">
        <div class="stories-label">
            <span class="stories-label-icon">üèÜ</span>
            <span class="stories-label-txt">Top Boutiques</span>
        </div>
        <div class="stories-bar" id="top10Grid">
            <!-- Stories remplies par JS -->
        </div>
    </section>

    <!-- ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ -->
    <div class="snap-divider">
        <div class="snap-divider-line"></div>
        <div class="snap-divider-controls">
            <span class="snap-divider-txt">Toutes les boutiques</span>
            <div class="snap-sort-wrap">
                <select class="snap-sort" id="sortSelect">
                    <option value="random">‚ú® Al√©atoire</option>
                    <option value="products">üì¶ Produits</option>
                    <option value="subscribers">üîî Abonn√©s</option>
                    <option value="likes">‚ù§Ô∏è Likes</option>
                    <option value="name">üî§ A‚ÄìZ</option>
                </select>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ DISCOVER TILES GRID ‚îÄ‚îÄ -->
    <section class="discover-section" id="allShopsSection">
        <div class="discover-grid" id="allShopsGrid">
            <!-- Tiles remplies par JS -->
        </div>

        <!-- Empty State -->
        <div class="snap-empty" id="emptyState" style="display:none;">
            <div class="snap-empty-icon">üîç</div>
            <h3>Aucune boutique trouv√©e</h3>
            <p>Essayez un autre terme de recherche</p>
            <button class="snap-btn-reset" onclick="resetSearch()">R√©initialiser</button>
        </div>

        <!-- Load More -->
        <div class="snap-load-more-wrap" id="loadMoreWrap" style="display:none;">
            <button class="snap-load-more-btn" id="btnLoadMore">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                Voir plus
            </button>
        </div>
    </section>

</main>

<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div class="toast-container" id="toastContainer"></div>

<!-- ‚ïê‚ïê MODAL BOUTIQUE ‚ïê‚ïê -->
<div class="modal-overlay" id="shopModalOverlay" onclick="closeShopModal()">
    <div class="modal-sheet" id="shopModal" onclick="event.stopPropagation()">
        <div class="modal-drag-handle"></div>
        <button class="modal-close" onclick="closeShopModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
        <div id="shopModalContent"></div>
    </div>
</div>

<script>
    /**
 * ODA BOUTIQUES ‚Äî boutiques.js
 * Layout Snapchat : Stories bar (Top10) + Discover tiles grid
 */
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG & SUPABASE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SUPABASE_URL      = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const CFG = {
    PAGE_SIZE:       12,
    TOP_COUNT:       10,
    DEBOUNCE_MS:     260,
    CACHE_KEY:       'oda_boutiques_v4_snap',
    CACHE_DURATION:  7 * 24 * 60 * 60 * 1000,
    DEFAULT_COLORS:  ['#FF6B00','#6366F1','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4','#EC4899'],
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STATE = {
    currentUser:          null,
    allShops:             [],
    top10:                [],
    rest:                 [],
    restFiltered:         [],
    visibleCount:         CFG.PAGE_SIZE,
    searchTerm:           '',
    sortBy:               'random',
    subscribedShops:      new Set(),
    shopLikes:            {},
    shopProductCounts:    {},
    shopSubscriberCounts: {},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DOM HELPERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $  = id => document.getElementById(id);
const dom = {
    loader:            () => $('pageLoader'),
    loaderBar:         () => $('loaderBarFill'),
    loaderText:        () => $('loaderText'),
    header:            () => $('mainHeader'),
    searchInput:       () => $('shopSearchInput'),
    searchClear:       () => $('searchClear'),
    top10Grid:         () => $('top10Grid'),
    allShopsGrid:      () => $('allShopsGrid'),
    emptyState:        () => $('emptyState'),
    loadMoreWrap:      () => $('loadMoreWrap'),
    btnLoadMore:       () => $('btnLoadMore'),
    sortSelect:        () => $('sortSelect'),
    totalShopsNum:     () => $('totalShopsNum'),
    totalSubscribedNum:() => $('totalSubscribedNum'),
    toastContainer:    () => $('toastContainer'),
    shopModalOverlay:  () => $('shopModalOverlay'),
    shopModalContent:  () => $('shopModalContent'),
    sideMenu:          () => $('sideMenu'),
    overlay:           () => $('overlay'),
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CACHE MANAGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
class CacheManager {
    constructor() { this.KEY = CFG.CACHE_KEY; this.DUR = CFG.CACHE_DURATION; }

    save(data) {
        try {
            localStorage.setItem(this.KEY, JSON.stringify({
                data, timestamp: Date.now(), expiresAt: Date.now() + this.DUR
            }));
            return true;
        } catch (e) {
            console.warn('Cache save failed:', e.message);
            return false;
        }
    }

    load() {
        try {
            const raw = localStorage.getItem(this.KEY);
            if (!raw) return null;
            const entry = JSON.parse(raw);
            if (!entry?.data) return null;
            const now   = Date.now();
            const fresh = now < entry.expiresAt;
            const stale = (now - entry.timestamp) < this.DUR * 2;
            if (!fresh && !stale) { localStorage.removeItem(this.KEY); return null; }
            return { data: entry.data, fresh, stale };
        } catch {
            localStorage.removeItem(this.KEY);
            return null;
        }
    }

    clear() { localStorage.removeItem(this.KEY); }
}

const cacheManager = new CacheManager();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const loader = {
    _pct: 0,
    start() { this.update(2, 'Connexion...'); },
    update(pct, txt) {
        this._pct = pct;
        const bar = dom.loaderBar(); if (bar) bar.style.width = pct + '%';
        const lbl = dom.loaderText(); if (lbl) lbl.textContent = txt || '';
    },
    async simulate(from, to, ms = 400) {
        const steps = 20;
        const step  = (to - from) / steps;
        const delay = ms / steps;
        for (let i = 0; i < steps; i++) {
            await this.delay(delay);
            this.update(Math.round(from + step * i), null);
        }
        this.update(to, null);
    },
    delay(ms) { return new Promise(r => setTimeout(r, ms)); },
    complete() {
        this.update(100, 'Pr√™t !');
        setTimeout(() => dom.loader()?.classList.add('fade-out'), 300);
    },
    showError(msg) {
        const lbl = dom.loaderText();
        if (lbl) lbl.textContent = '‚ùå ' + msg;
    }
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DATA LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadFromNetwork(withProgress = false) {
    if (withProgress) loader.update(10, 'Chargement boutiques...');

    // ‚úÖ Vraie table : parametres_boutique (donn√©es en JSONB dans config)
    const { data: rawShops, error } = await db
        .from('parametres_boutique')
        .select('user_id, config, created_at')
        .order('created_at', { ascending: false });

    if (error) throw error;
    if (!rawShops?.length) return { shops: [], likes: {}, products: {}, subscribers: {} };

    // Normaliser le sch√©ma JSONB vers le format plat attendu par le reste du code
    const shops = rawShops.map(row => ({
        id:          row.user_id,
        name:        row.config?.general?.nom || row.config?.nom || 'Boutique',
        description: row.config?.general?.description || row.config?.description || '',
        slug:        row.config?.identifiant?.slug || row.config?.slug || null,
        logo_url:    row.config?.apparence?.logoUrl || row.config?.logo_url || null,
        cover_url:   row.config?.apparence?.coverUrl || row.config?.cover_url || null,
        color:       row.config?.apparence?.couleurPrimaire || row.config?.color || null,
        verified:    row.config?.verified || false,
        created_at:  row.created_at,
    }));

    if (withProgress) loader.update(35, 'Statistiques...');

    const ids = shops.map(s => s.id);

    // ‚úÖ produits remplace products (li√© au shop via user_id)
    const [prodsRes] = await Promise.all([
        db.from('produits').select('user_id').in('user_id', ids),
    ]);

    const products    = aggregateCount(prodsRes.data, 'user_id');
    const likes       = {}; // product_likes est li√© √† product_id, pas shop_id
    const subscribers = {}; // shop_subscriptions n'existe pas encore

    if (withProgress) loader.update(72, 'Organisation...');

    const result = { shops, likes, products, subscribers };
    cacheManager.save(result);
    return result;
}

function aggregateCount(rows, key) {
    if (!rows) return {};
    return rows.reduce((acc, r) => {
        acc[r[key]] = (acc[r[key]] || 0) + 1;
        return acc;
    }, {});
}

function applyToState(data) {
    STATE.shopLikes            = data.likes       || {};
    STATE.shopProductCounts    = data.products    || {};
    STATE.shopSubscriberCounts = data.subscribers || {};

    const shops = (data.shops || []).map(s => ({
        ...s,
        likeCount:       STATE.shopLikes[s.id]            || 0,
        productCount:    STATE.shopProductCounts[s.id]     || 0,
        subscriberCount: STATE.shopSubscriberCounts[s.id]  || 0,
        color:           s.color || CFG.DEFAULT_COLORS[Math.floor(Math.random() * CFG.DEFAULT_COLORS.length)],
    }));

    shops.sort((a, b) => b.likeCount - a.likeCount);
    STATE.top10    = shops.slice(0, CFG.TOP_COUNT);
    STATE.rest     = shops.slice(CFG.TOP_COUNT);
    STATE.allShops = shops;
    STATE.restFiltered = [...STATE.rest];
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH & SUBSCRIPTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function initAuth() {
    try {
        const { data: { session } } = await db.auth.getSession();
        STATE.currentUser = session?.user || null;
    } catch { STATE.currentUser = null; }
}

async function loadSubscriptions() {
    // shop_subscriptions n'existe pas encore en base
    // Fonctionnalit√© d√©sactiv√©e ‚Äî √† activer quand la table sera cr√©√©e
    console.info('Abonnements : table shop_subscriptions non disponible');
}

async function toggleSubscribe(shopId, btnEl) {
    if (!STATE.currentUser) {
        showToast('Connectez-vous pour vous abonner', 'info');
        return;
    }
    btnEl.classList.add('loading');
    const was = STATE.subscribedShops.has(shopId);
    try {
        // Gestion locale jusqu'√† ce que shop_subscriptions soit cr√©√© en base
        if (was) {
            STATE.subscribedShops.delete(shopId);
            showToast('Abonnement retir√©', 'info');
        } else {
            STATE.subscribedShops.add(shopId);
            showToast('Abonnement ajout√© ! üîî', 'success');
        }
        updateAllSubscribeButtons();
        updateHeaderStats();
    } catch (e) {
        showToast('Erreur : ' + e.message, 'error');
    } finally {
        btnEl.classList.remove('loading');
    }
}

function updateAllSubscribeButtons() {
    document.querySelectorAll('[data-subscribe]').forEach(btn => {
        const sid = btn.dataset.subscribe;
        const subbed = STATE.subscribedShops.has(sid);
        if (btn.classList.contains('tile-btn-sub')) {
            btn.classList.toggle('subscribed', subbed);
            btn.innerHTML = subbed
                ? `<span>‚úì</span><span>Abonn√©</span>`
                : `<span>üîî</span><span>S'abonner</span>`;
        } else if (btn.classList.contains('tile-sub-btn')) {
            btn.classList.toggle('subbed', subbed);
            btn.innerHTML = subbed ? '‚úì' : 'üîî';
        } else if (btn.classList.contains('modal-btn-sub')) {
            btn.classList.toggle('subscribed', subbed);
            btn.textContent = subbed ? '‚úì Abonn√©' : "üîî S'abonner";
        }
    });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER ‚Äî STORIES (Top 10)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderStorySkeletons(container, n = 5) {
    container.innerHTML = Array.from({ length: n }, () => `
        <div class="story-skel">
            <div class="story-skel-ring"></div>
            <div class="story-skel-name"></div>
        </div>
    `).join('');
}

function renderTop10() {
    const container = dom.top10Grid();
    if (!container) return;
    if (!STATE.top10.length) { container.innerHTML = ''; return; }

    container.innerHTML = STATE.top10.map((shop, i) => {
        const rank  = i + 1;
        const cls   = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
        const badgeCls = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : 'other';
        const badgeTxt = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
        const delay = i * 60;

        const avatarHtml = shop.logo_url
            ? `<img src="${escHtml(shop.logo_url)}" alt="${escHtml(shop.name)}" class="story-ring-inner" style="object-fit:cover;">`
            : `<div class="story-ring-inner">${getShopEmoji(shop)}</div>`;

        return `
        <div class="story-item ${cls}" style="animation-delay:${delay}ms"
             onclick="openShopModal('${shop.id}')">
            <div class="story-ring-outer ${cls}" style="--shop-color:${shop.color}">
                ${avatarHtml}
                <div class="story-rank-badge ${badgeCls}">${badgeTxt}</div>
            </div>
            <span class="story-name">${escHtml(shop.name)}</span>
            <span class="story-subs">${formatNum(shop.subscriberCount)} üîî</span>
        </div>`;
    }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RENDER ‚Äî DISCOVER TILES (Toutes boutiques)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderTileSkeletons(container, n = 6) {
    container.innerHTML = Array.from({ length: n }, (_, i) => `
        <div class="tile-skel" style="animation-delay:${i * 55}ms">
            <div class="tile-skel-cover"></div>
            <div class="tile-skel-body">
                <div class="tile-skel-row">
                    <div class="tile-skel-av"></div>
                    <div class="tile-skel-lines">
                        <div class="tile-skel-line w70"></div>
                        <div class="tile-skel-line w45"></div>
                    </div>
                </div>
                <div class="tile-skel-chips">
                    <div class="tile-skel-chip"></div>
                    <div class="tile-skel-chip"></div>
                    <div class="tile-skel-chip"></div>
                </div>
                <div class="tile-skel-btns">
                    <div class="tile-skel-btn"></div>
                    <div class="tile-skel-btn" style="max-width:80px"></div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderAllShops() {
    const container = dom.allShopsGrid();
    if (!container) return;

    const visible = STATE.restFiltered.slice(0, STATE.visibleCount);
    const hasMore = STATE.restFiltered.length > STATE.visibleCount;
    const empty   = STATE.restFiltered.length === 0;

    dom.emptyState().style.display   = empty ? 'block' : 'none';
    const lmw = dom.loadMoreWrap();
    if (lmw) lmw.style.display = hasMore ? 'block' : 'none';

    if (empty) { container.innerHTML = ''; return; }

    container.innerHTML = visible.map((shop, i) => buildTileCard(shop, i)).join('');
}

function buildTileCard(shop, i) {
    const subbed = STATE.subscribedShops.has(shop.id);
    const delay  = (i % 12) * 45;

    // Cover background
    const coverBg = shop.cover_url
        ? `background-image:url('${escHtml(shop.cover_url)}')`
        : `background: linear-gradient(135deg, ${shop.color}33, ${shop.color}08)`;

    // Avatar
    const avatarHtml = shop.logo_url
        ? `<img src="${escHtml(shop.logo_url)}" alt="${escHtml(shop.name)}" class="tile-avatar" loading="lazy">`
        : `<div class="tile-avatar-placeholder">${getShopEmoji(shop)}</div>`;

    // Description preview (only if not empty)
    const descHtml = shop.description
        ? `<p class="tile-desc">${escHtml(shop.description)}</p>`
        : '';

    // Verified badge
    const verifiedHtml = shop.verified
        ? `<span class="tile-badge tile-badge-verified">‚úì V√©rifi√©</span>`
        : '';

    return `
    <div class="tile-card" style="animation-delay:${delay}ms; --shop-color:${shop.color}"
         onclick="openShopModal('${shop.id}')">

        <!-- Cover -->
        <div class="tile-cover">
            <div class="tile-cover-bg" style="${coverBg}"></div>
            <div class="tile-cover-gradient"></div>
            <div class="tile-cover-badges">
                ${verifiedHtml}
            </div>
            <div class="tile-cover-sub">
                <button class="tile-sub-btn ${subbed ? 'subbed' : ''}"
                    data-subscribe="${shop.id}"
                    onclick="event.stopPropagation(); toggleSubscribe('${shop.id}', this)">
                    ${subbed ? '‚úì' : 'üîî'}
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="tile-body">
            <div class="tile-top-row">
                ${avatarHtml}
                <div class="tile-name-wrap">
                    <div class="tile-name">${escHtml(shop.name)}</div>
                    <div class="tile-slug">
                        ${shop.slug ? '@' + escHtml(shop.slug) : ''}
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="tile-stats">
                <span class="chip chip-likes">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09A6.065 6.065 0 0 1 16.5 3C19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    ${formatNum(shop.likeCount)}
                </span>
                <span class="chip chip-products">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    ${formatNum(shop.productCount)}
                </span>
                <span class="chip chip-subs">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    ${formatNum(shop.subscriberCount)}
                </span>
            </div>

            ${descHtml}

            <!-- Actions -->
            <div class="tile-actions" onclick="event.stopPropagation()">
                <button class="tile-btn-sub ${subbed ? 'subscribed' : ''}"
                    data-subscribe="${shop.id}"
                    onclick="toggleSubscribe('${shop.id}', this)">
                    ${subbed
                        ? `<span>‚úì</span><span>Abonn√©</span>`
                        : `<span>üîî</span><span>S'abonner</span>`}
                </button>
                <button class="tile-btn-visit"
                    onclick="visitShop('${shop.id}','${escHtml(shop.slug || '')}')">
                    Visiter ‚Üí
                </button>
            </div>
        </div>
    </div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILTER & SORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function filterAndSort() {
    let list = [...STATE.rest];

    // Search
    const q = STATE.searchTerm.toLowerCase().trim();
    if (q) {
        list = list.filter(s =>
            s.name?.toLowerCase().includes(q) ||
            s.slug?.toLowerCase().includes(q) ||
            s.description?.toLowerCase().includes(q)
        );
    }

    // Sort
    switch (STATE.sortBy) {
        case 'likes':       list.sort((a, b) => b.likeCount - a.likeCount); break;
        case 'products':    list.sort((a, b) => b.productCount - a.productCount); break;
        case 'subscribers': list.sort((a, b) => b.subscriberCount - a.subscriberCount); break;
        case 'name':        list.sort((a, b) => a.name.localeCompare(b.name, 'fr')); break;
        case 'random':      shuffleArr(list); break;
    }

    STATE.restFiltered = list;
    STATE.visibleCount = CFG.PAGE_SIZE;
    renderAllShops();
}

/* ‚îÄ‚îÄ Search (debounced) ‚îÄ‚îÄ */
let _searchTimer = null;
function onSearch(val) {
    const clear = dom.searchClear();
    if (clear) clear.classList.toggle('visible', val.length > 0);
    clearTimeout(_searchTimer);
    _searchTimer = setTimeout(() => {
        STATE.searchTerm = val;
        STATE.visibleCount = CFG.PAGE_SIZE;
        filterAndSort();
    }, CFG.DEBOUNCE_MS);
}

function resetSearch() {
    const inp = dom.searchInput();
    if (inp) inp.value = '';
    dom.searchClear()?.classList.remove('visible');
    STATE.searchTerm = '';
    STATE.visibleCount = CFG.PAGE_SIZE;
    filterAndSort();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODAL DETAIL BOUTIQUE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openShopModal(shopId) {
    const shop = STATE.allShops.find(s => s.id === shopId);
    if (!shop) return;

    const isSubbed  = STATE.subscribedShops.has(shopId);
    const content   = dom.shopModalContent();
    if (!content) return;

    const avatarHtml = shop.logo_url
        ? `<img src="${escHtml(shop.logo_url)}" class="modal-shop-avatar" alt="${escHtml(shop.name)}">`
        : `<div class="modal-shop-avatar-ph">${getShopEmoji(shop)}</div>`;

    const verifiedHtml = shop.verified
        ? `<span class="modal-verified">‚úì Boutique V√©rifi√©e</span>` : '';

    const descHtml = shop.description
        ? `<p class="modal-desc">${escHtml(shop.description)}</p>` : '';

    content.innerHTML = `
        <div class="modal-shop-cover" style="--shop-color:${shop.color}"></div>
        <div class="modal-body-inner">
            <div class="modal-shop-header">
                ${avatarHtml}
                <div class="modal-shop-info">
                    <div class="modal-shop-name">${escHtml(shop.name)}</div>
                    ${shop.slug ? `<div class="modal-shop-slug">@${escHtml(shop.slug)}</div>` : ''}
                    ${verifiedHtml}
                </div>
            </div>

            <div class="modal-stats-grid">
                <div class="modal-stat-box">
                    <div class="modal-stat-num" style="color:#FF4D6D">${formatNum(shop.likeCount)}</div>
                    <div class="modal-stat-label">‚ù§Ô∏è Likes</div>
                </div>
                <div class="modal-stat-box">
                    <div class="modal-stat-num" style="color:#60A5FA">${formatNum(shop.productCount)}</div>
                    <div class="modal-stat-label">üì¶ Produits</div>
                </div>
                <div class="modal-stat-box">
                    <div class="modal-stat-num" style="color:var(--primary)">${formatNum(shop.subscriberCount)}</div>
                    <div class="modal-stat-label">üîî Abonn√©s</div>
                </div>
            </div>

            ${descHtml}

            <div class="modal-actions">
                <button class="modal-btn-sub ${isSubbed ? 'subscribed' : ''}"
                    data-subscribe="${shop.id}"
                    onclick="toggleSubscribe('${shop.id}', this)">
                    ${isSubbed ? '‚úì Abonn√©' : "üîî S'abonner"}
                </button>
                <button class="modal-btn-visit"
                    onclick="visitShop('${shop.id}','${escHtml(shop.slug || '')}')">
                    Visiter ‚Üí
                </button>
            </div>
        </div>`;

    dom.shopModalOverlay()?.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeShopModal() {
    dom.shopModalOverlay()?.classList.remove('active');
    document.body.style.overflow = '';
}

function visitShop(shopId, slug) {
    window.location.href = slug
        ? `shop.html?s=${encodeURIComponent(slug)}`
        : `shop.html?id=${encodeURIComponent(shopId)}`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MENU
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openMenu() {
    dom.sideMenu()?.classList.add('active');
    dom.overlay()?.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeMenu() {
    dom.sideMenu()?.classList.remove('active');
    dom.overlay()?.classList.remove('active');
    document.body.style.overflow = '';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateHeaderStats() {
    const t = dom.totalShopsNum();
    const s = dom.totalSubscribedNum();
    if (t) t.textContent = formatNum(STATE.allShops.length);
    if (s) s.textContent = formatNum(STATE.subscribedShops.size);
}

function loadMore() {
    STATE.visibleCount += CFG.PAGE_SIZE;
    renderAllShops();
}

function shuffleArr(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

function formatNum(n) {
    if (!n) return '0';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(1) + 'k';
    return String(n);
}

function escHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function getShopEmoji(shop) {
    const emojis = ['üõçÔ∏è','üè™','üéÅ','üíé','üëó','üëü','üçï','üì±','üåø','üíÑ','üé®','üè∫'];
    const idx = (shop.name?.charCodeAt(0) || 0) % emojis.length;
    return emojis[idx];
}

function showToast(msg, type = 'info') {
    const c = dom.toastContainer();
    if (!c) return;
    const icons = { success: '‚úÖ', error: '‚ùå', info: 'üí¨' };
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<span class="toast-icon">${icons[type] || 'üí¨'}</span><span>${escHtml(msg)}</span>`;
    c.appendChild(t);
    setTimeout(() => {
        t.classList.add('fade-out');
        setTimeout(() => t.remove(), 350);
    }, 3200);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT LISTENERS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initEventListeners() {
    $('menuBtn')?.addEventListener('click', openMenu);
    $('closeMenuBtn')?.addEventListener('click', closeMenu);
    dom.overlay()?.addEventListener('click', closeMenu);

    const si = dom.searchInput();
    if (si) {
        si.addEventListener('input', e => onSearch(e.target.value));
        si.addEventListener('keydown', e => {
            if (e.key === 'Escape') { resetSearch(); si.blur(); }
        });
    }

    dom.searchClear()?.addEventListener('click', () => {
        if (dom.searchInput()) dom.searchInput().value = '';
        resetSearch();
        dom.searchInput()?.focus();
    });

    dom.sortSelect()?.addEventListener('change', e => {
        STATE.sortBy = e.target.value;
        filterAndSort();
    });

    dom.btnLoadMore()?.addEventListener('click', loadMore);

    window.addEventListener('scroll', () => {
        dom.header()?.classList.toggle('scrolled', window.scrollY > 30);
    }, { passive: true });

    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeShopModal();
    });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function init() {
    const t0 = performance.now();

    // Afficher skeletons imm√©diatement
    renderStorySkeletons(dom.top10Grid(), 5);
    renderTileSkeletons(dom.allShopsGrid(), 6);

    initEventListeners();
    loader.start();

    const cached = cacheManager.load();

    if (cached?.fresh) {
        loader.update(10, 'Cache d√©tect√©...');
        await loader.delay(60);
        loader.update(45, 'Chargement boutiques...');
        applyToState(cached.data);
        renderTop10();
        await loader.delay(60);
        loader.update(75, 'Affichage...');
        filterAndSort();
        updateHeaderStats();
        await loader.simulate(75, 100, 250);
        loader.complete();
        console.log(`‚ö° Charg√© depuis cache en ${(performance.now()-t0).toFixed(0)}ms`);

        initAuth().then(() => { if (STATE.currentUser) loadSubscriptions(); });
        setTimeout(async () => {
            try {
                const fresh = await loadFromNetwork(false);
                applyToState(fresh);
                renderTop10();
                filterAndSort();
                updateHeaderStats();
                if (STATE.currentUser) updateAllSubscribeButtons();
            } catch (e) { console.warn('Refresh silencieux √©chou√©:', e.message); }
        }, 3000);
        return;
    }

    if (cached?.stale) {
        loader.update(20, 'Cache (actualisation...)');
        applyToState(cached.data);
        renderTop10();
        filterAndSort();
        updateHeaderStats();
        loader.complete();
        console.log(`üì¶ Cache expir√© utilis√© ‚Äî refresh`);

        initAuth().then(() => { if (STATE.currentUser) loadSubscriptions(); });
        setTimeout(async () => {
            try {
                const fresh = await loadFromNetwork(false);
                cacheManager.save(fresh);
                applyToState(fresh);
                renderTop10();
                filterAndSort();
                updateHeaderStats();
                if (STATE.currentUser) updateAllSubscribeButtons();
            } catch (e) { console.warn('Refresh √©chou√©:', e.message); }
        }, 500);
        return;
    }

    // Premi√®re visite ‚Äî r√©seau
    try {
        const [shops] = await Promise.all([
            loadFromNetwork(true),
            initAuth(),
        ]);
        loader.update(90, 'Affichage final...');
        applyToState(shops);
        renderTop10();
        filterAndSort();
        updateHeaderStats();
        if (STATE.currentUser) await loadSubscriptions();
        loader.complete();
        console.log(`üåê Charg√© depuis r√©seau en ${(performance.now()-t0).toFixed(0)}ms`);
    } catch (err) {
        console.error('‚ùå Init error:', err);
        loader.showError(err.message || 'Erreur de chargement');
        showToast('‚ùå Erreur : ' + (err.message || 'V√©rifiez votre connexion'), 'error');
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GLOBALS & START
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.toggleSubscribe = toggleSubscribe;
window.visitShop       = visitShop;
window.openShopModal   = openShopModal;
window.closeShopModal  = closeShopModal;
window.closeMenu       = closeMenu;
window.openMenu        = openMenu;
window.resetSearch     = resetSearch;

window.ODA_BOUTIQUES = {
    state:        () => STATE,
    cacheFlush:   () => { cacheManager.clear(); location.reload(); },
    forceRefresh: async () => { cacheManager.clear(); await init(); },
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
} else {
    init();
}

console.log('üè™ ODA Boutiques Snap ‚Äî JS v4 charg√©');
</script>
</body>
</html>

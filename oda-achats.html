
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B00">
    <link rel="manifest" href="manifest.json">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <link rel="apple-touch-icon" href="/oda.png">
    <title>ODA Marketplace - Tous les produits</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="oda-shop-styles.css">
    <link rel="icon" type="image/png" href="oda.png">
    <link rel="icon" type="image/png" href="oda.png">

<!-- PWA Manager Script -->

</head>
<style>
    /* ==================== VARIABLES ==================== */
:root {
    --primary-color: #FF6B00;
    --primary-dark: #E55D00;
    --secondary-color: #1A1A1A;
    --bg-primary: #FFFFFF;
    --bg-secondary: #F8F9FA;
    --text-primary: #1A1A1A;
    --text-secondary: #6B7280;
    --border-color: #E5E7EB;
    --success-color: #10B981;
    --error-color: #EF4444;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg-secondary);
    color: var(--text-primary);
    overflow-x: hidden;
}

/* ==================== HEADER ==================== */
.main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #2C3E50;
    box-shadow: var(--shadow-md);
    z-index: 1000;
    padding: 12px 16px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1400px;
    margin: 0 auto;
}

.menu-btn {
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.menu-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.3rem;
    font-weight: 800;
    color: white;
}

.header-icons {
    display: flex;
    gap: 12px;
    align-items: center;
}

.icon-btn {
    position: relative;
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.icon-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.icon-btn .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--primary-color);
    color: white;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}

.search-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 12px 0 0;
}

.search-box {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255, 255, 255, 0.15);
    padding: 10px 16px;
    border-radius: 24px;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.search-box:focus-within {
    background: rgba(255, 255, 255, 0.25);
    border-color: var(--primary-color);
}

.search-box svg {
    color: rgba(255, 255, 255, 0.7);
    flex-shrink: 0;
}

.search-box input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.95rem;
    color: white;
    outline: none;
}

.search-box input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

/* ==================== CAROUSEL BANNI√àRE ARRONDIE ==================== */
.hero-carousel {
    margin-top: 140px;
    height: 400px;
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #f8f8f8 0%, #020202 100%);
    border-radius: 24px;
    margin-left: 16px;
    margin-right: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.carousel-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 24px;
    overflow: hidden;
}

.carousel-container {
    display: flex;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    height: 100%;
}

.carousel-item {
    min-width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.carousel-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

.carousel-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    padding: 40px;
    color: white;
}

.carousel-info h2 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 8px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.carousel-info .shop-name {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 4px;
}

.carousel-info .product-price {
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--primary-color);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

/* Message de d√©couverte */
.hero-message {
    position: absolute;
    top: 40px;
    left: 40px;
    right: 40px;
    text-align: center;
    z-index: 5;
    color: rgb(5, 5, 5);
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
}

.hero-message h2 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 8px;
}

.hero-message p {
    font-size: 1.1rem;
    opacity: 0.95;
}

/* Boutons transparents sur la banni√®re */
.banner-actions {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    z-index: 10;
}

.banner-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 16px;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    min-width: 100px;
}

.banner-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.banner-icon {
    font-size: 2rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.carousel-btn:hover {
    background: white;
    transform: translateY(-50%) scale(1.1);
}

.carousel-btn.prev {
    left: 20px;
}

.carousel-btn.next {
    right: 20px;
}

.carousel-dots {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
}

.dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.dot:hover {
    background: rgba(255, 255, 255, 0.8);
}

.dot.active {
    background: white;
    width: 32px;
    border-radius: 5px;
}



/* ==================== GRID PRODUITS (D√âFILEMENT GAUCHE-DROITE & HAUT-BAS) ==================== */
.products-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.section-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.product-count {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    animation: fadeIn 0.5s ease;
}

.product-card {
    background: var(--bg-primary);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
    opacity: 1;
}

/* Animation de gauche √† droite */
@keyframes slideInFromLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}


/* Animation de haut en bas (altern√©e) */
.product-card:nth-child(even) {
    animation: slideInFromTop 0.5s ease backwards;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.product-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    border-color: var(--primary-color);
}

.product-image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%;
    background: #f8f8f8;
    overflow: hidden;
}

.product-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}

.btn-favorite {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.1rem;
    z-index: 5;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.btn-favorite:hover {
    transform: scale(1.15);
}

.btn-favorite.active {
    background: var(--error-color);
}

.product-info {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
}

.shop-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 0.7rem;
    color: var(--text-secondary);
    font-weight: 600;
    width: fit-content;
}

.product-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
    min-height: 2.8em;
}

.product-price {
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--primary-color);
    margin-top: auto;
}

.product-stock {
    font-size: 0.75rem;
    color: var(--success-color);
    font-weight: 500;
}
/* ==================== SCROLL HORIZONTAL CATEGORIES ==================== */
.horizontal-scroll::-webkit-scrollbar {
    height: 8px;
}

.horizontal-scroll::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 4px;
}

.horizontal-scroll::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 4px;
}

.horizontal-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* ==================== ANIMATIONS ==================== */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ==================== LOADER ==================== */
.loader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    gap: 16px;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loader p {
    font-weight: 600;
    color: var(--text-secondary);
}

/* ==================== EMPTY STATE ==================== */
.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: var(--text-secondary);
}

.empty-state svg {
    width: 100px;
    height: 100px;
    margin-bottom: 20px;
    opacity: 0.3;
}

/* ==================== TOAST NOTIFICATIONS ==================== */
.toast-container {
    position: fixed;
    top: 90px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 350px;
}

.toast {
    background: white;
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideInRight 0.3s ease;
    border-left: 4px solid var(--primary-color);
}

.toast.success {
    border-left-color: var(--success-color);
}

.toast.error {
    border-left-color: var(--error-color);
}

@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .main-header {
        padding: 10px 12px;
    }

    .logo {
        font-size: 1.1rem;
    }

    .icon-btn {
        width: 36px;
        height: 36px;
    }

    .search-container {
        padding: 8px 0 0;
    }

    .hero-carousel {
        height: 350px;
        margin-top: 130px;
        border-radius: 16px;
        margin-left: 12px;
        margin-right: 12px;
    }

    .hero-message {
        top: 20px;
        left: 20px;
        right: 20px;
    }

    .hero-message h2 {
        font-size: 1.3rem;
    }

    .hero-message p {
        font-size: 0.9rem;
    }

    .banner-actions {
        bottom: 60px;
        gap: 12px;
    }

    .banner-btn {
        padding: 12px 16px;
        min-width: 80px;
        font-size: 0.8rem;
    }

    .banner-icon {
        font-size: 1.5rem;
    }

    .carousel-overlay {
        padding: 20px;
    }

    .carousel-info h2 {
        font-size: 1.3rem;
    }

    .carousel-info .product-price {
        font-size: 1.3rem;
    }

    .carousel-btn {
        width: 40px;
        height: 40px;
    }

    .carousel-btn.prev {
        left: 10px;
    }

    .carousel-btn.next {
        right: 10px;
    }

    .products-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .tabs-nav {
        overflow-x: auto;
        justify-content: flex-start;
        padding: 12px 16px;
        top: 130px;
        margin: 16px 12px;
    }

    .tab-btn {
        padding: 10px 20px;
        font-size: 0.85rem;
        white-space: nowrap;
    }
}

@media (max-width: 480px) {
    .hero-carousel {
        height: 300px;
        margin-top: 120px;
    }

    .banner-actions {
        flex-direction: row;
        gap: 8px;
        bottom: 50px;
    }

    .banner-btn {
        padding: 10px 12px;
        min-width: 70px;
        font-size: 0.75rem;
    }

    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}
/* ==================== LIKES ET COMMENTAIRES ==================== */

/* Engagement buttons sur les cartes produits */
.product-engagement {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 8px 0;
}

.btn-like,
.btn-comments {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-like:hover,
.btn-comments:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn-like.liked {
    background: #FFE5E5;
    border-color: var(--error-color);
    color: var(--error-color);
}

.btn-like .like-icon {
    font-size: 1rem;
}

.product-rating {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-left: auto;
}

/* ==================== MODAL COMMENTAIRES ==================== */
.comments-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(50px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-header h3 {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.btn-close {
    width: 40px;
    height: 40px;
    border: none;
    background: var(--bg-secondary);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.btn-close:hover {
    background: var(--border-color);
    transform: rotate(90deg);
}

/* Stats du produit */
.modal-stats {
    display: flex;
    justify-content: space-around;
    padding: 20px;
    background: var(--bg-secondary);
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.stat-icon {
    font-size: 1.5rem;
}

.stat-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

/* Formulaire de commentaire */
.comment-form {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
}

.comment-form h4 {
    margin-bottom: 16px;
    font-size: 1.1rem;
    font-weight: 600;
}

.rating-input {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.rating-input input[type="radio"] {
    display: none;
}

.rating-input label {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.rating-input label:hover {
    transform: scale(1.1);
}

.rating-input input:checked + .star {
    filter: drop-shadow(0 2px 4px rgba(255, 107, 0, 0.5));
}

.rating-input .star {
    font-size: 0.9rem;
}

.comment-form textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    font-size: 0.95rem;
    resize: vertical;
    min-height: 80px;
    margin-bottom: 12px;
    transition: border-color 0.3s ease;
}

.comment-form textarea:focus {
    outline: none;
    border-color: var(--primary-color);
}

.btn-submit {
    width: 100%;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-submit:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
}

.btn-submit:active {
    transform: translateY(0);
}

/* Liste des commentaires */
.comments-list {
    padding: 20px;
}

.comments-list h4 {
    margin-bottom: 16px;
    font-size: 1.1rem;
    font-weight: 600;
}

.empty-comments {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.empty-comments p:first-child {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
}

.comment-item {
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
}

.comment-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-2px);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.comment-user {
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
}

.user-name {
    font-weight: 600;
    color: var(--text-primary);
}

.comment-rating {
    font-size: 0.85rem;
}

.comment-text {
    margin: 8px 0;
    line-height: 1.6;
    color: var(--text-primary);
}

.comment-date {
    font-size: 0.8rem;
    color: var(--text-secondary);
}
/* ==================== MODAL PARAM√àTRES ==================== */
.settings-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
}

.settings-modal.active {
    display: flex;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: transparent;
}

.settings-modal-content {
    position: relative;
    background: white;
    border-radius: 20px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
    z-index: 1;
}

.settings-header {
    background: linear-gradient(135deg, #FF6B00, #E55D00);
    color: white;
    padding: 24px;
    border-radius: 20px 20px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 10;
}

.settings-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0;
}

.settings-header .btn-close {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.settings-header .btn-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.settings-body {
    padding: 24px;
    background: white;
}

.settings-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 2px solid var(--border-color);
}

.settings-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.section-icon {
    font-size: 1.5rem;
}

.section-header h3 {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

.label-badge {
    padding: 4px 12px;
    background: var(--success-color);
    color: white;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    transition: all 0.3s ease;
}

.label-badge.disabled {
    background: var(--error-color);
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 0.95rem;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
    color: var(--text-primary);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 4px rgba(255, 107, 0, 0.1);
}

.form-input:read-only {
    background: var(--bg-secondary);
    cursor: not-allowed;
}

.form-hint {
    display: block;
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.btn-primary {
    padding: 12px 24px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    background: #ccc;
}

.btn-danger {
    width: 100%;
    padding: 14px 20px;
    background: var(--error-color);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-danger:hover {
    background: #DC2626;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-danger:active {
    transform: translateY(0);
}

/* Toggle Switch */
.settings-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
}

.settings-toggle:hover {
    background: var(--border-color);
    transform: translateX(4px);
}

.toggle-info {
    flex: 1;
}

.toggle-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
    font-size: 0.95rem;
}

.toggle-desc {
    font-size: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

.switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
    flex-shrink: 0;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(24px);
}

/* Scrollbar personnalis√©e pour le modal */
.settings-modal-content::-webkit-scrollbar {
    width: 8px;
}

.settings-modal-content::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 0 0 20px 0;
}

.settings-modal-content::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 10px;
}

.settings-modal-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* Responsive */
@media (max-width: 768px) {
    .settings-modal {
        padding: 0;
        align-items: flex-end;
    }
    
    .settings-modal-content {
        max-height: 95vh;
        border-radius: 20px 20px 0 0;
        animation: slideUpModal 0.3s ease;
    }
    
    .settings-header {
        border-radius: 20px 20px 0 0;
        padding: 20px;
    }
    
    .settings-header h2 {
        font-size: 1.2rem;
    }
    
    .settings-body {
        padding: 20px 16px;
    }
    
    .settings-section {
        margin-bottom: 24px;
        padding-bottom: 20px;
    }
    
    .settings-toggle {
        padding: 14px;
    }
}

@keyframes slideUpModal {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Mode sombre (optionnel) */
body.dark-mode {
    background: #1a1a1a;
    color: #ffffff;
}

body.dark-mode .settings-modal-content {
    background: #2d2d2d;
}

body.dark-mode .settings-body {
    background: #2d2d2d;
}

body.dark-mode .settings-toggle {
    background: #3a3a3a;
}

body.dark-mode .settings-toggle:hover {
    background: #4a4a4a;
}

body.dark-mode .form-input {
    background: #3a3a3a;
    border-color: #4a4a4a;
    color: white;
}

body.dark-mode .form-input:read-only {
    background: #2a2a2a;
}

body.dark-mode .toggle-title {
    color: white;
}

body.dark-mode .toggle-desc {
    color: #aaa;
}

body.dark-mode .section-header h3 {
    color: white;
}
/* ==================== MENU LAT√âRAL OPTIMIS√â (SCROLLABLE) ==================== */
.side-menu {
    position: fixed;
    top: 0;
    left: -100%;
    width: 85%;
    max-width: 320px;
    height: 100vh;
    background: var(--bg-primary);
    box-shadow: var(--shadow-lg);
    z-index: 2000;
    transition: left 0.3s ease;
    overflow: hidden; /* IMPORTANT: Pas de scroll sur le menu lui-m√™me */
    -webkit-overflow-scrolling: touch;
    display: flex;
    flex-direction: column; /* IMPORTANT: Layout vertical */
}

.side-menu.active {
    left: 0;
}

.menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    background: var(--primary-color);
    color: white;
    flex-shrink: 0; /* Ne pas r√©tr√©cir */
}

.menu-header h2 {
    font-size: 1.25rem;
    font-weight: 700;
}

.menu-content {
    padding: 20px;
    overflow-y: auto; /* IMPORTANT: Le scroll est ICI, pas sur le menu */
    overflow-x: hidden;
    flex: 1; /* Prendre tout l'espace disponible */
    -webkit-overflow-scrolling: touch;
}

/* Scrollbar du menu-content */
.menu-content::-webkit-scrollbar {
    width: 8px;
}

.menu-content::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 10px;
}

.menu-content::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 10px;
}

.menu-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* Pour Firefox */
.menu-content {
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) var(--bg-secondary);
}

.menu-section {
    margin-bottom: 32px;
}

.menu-section h3 {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 12px;
    position: sticky; /* Sticky pour les titres de section */
    top: -20px;
    background: var(--bg-primary);
    padding: 8px 0;
    z-index: 1;
}

/* Liste de cat√©gories (scrollable √† l'int√©rieur) */
.category-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    /* Le scroll sera g√©r√© par le JS dans improved_menu */
}

/* Liens du menu */
.menu-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    text-decoration: none;
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.menu-link:hover {
    background: linear-gradient(90deg, rgba(255, 107, 0, 0.1), rgba(255, 107, 0, 0.05));
    border-left: 4px solid var(--primary-color);
    padding-left: 12px;
}

.menu-link:active {
    transform: scale(0.98);
    background: var(--border-color);
}

.menu-link svg {
    flex-shrink: 0;
}

/* Responsive */
@media (min-width: 640px) {
    .side-menu {
        max-width: 400px;
    }
}

@media (max-width: 768px) {
    .side-menu {
        width: 90%;
        max-width: 350px;
    }
    
    .menu-header {
        padding: 16px;
    }
    
    .menu-content {
        padding: 16px;
    }
}

@media (max-height: 600px) {
    /* Pour les petits √©crans en hauteur */
    .menu-header {
        padding: 12px 16px;
    }
    
    .menu-header h2 {
        font-size: 1.1rem;
    }
    
    .menu-section {
        margin-bottom: 20px;
    }
}

/* Animation d'ouverture */
@keyframes slideInFromLeft {
    from {
        left: -100%;
    }
    to {
        left: 0;
    }
}

.side-menu.active {
    animation: slideInFromLeft 0.3s ease;
}

/* Effet de glissement fluide */
.side-menu {
    will-change: left;
}

/* Indicateur de scroll en bas (optionnel) */
.menu-content::after {
    content: '';
    display: block;
    height: 20px;
    pointer-events: none;
}
</style>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p>Chargement des produits...</p>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <button class="menu-btn" id="menuBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
            
            <div class="logo">
                üõçÔ∏è Odamarket
            </div>
            
            <div class="header-icons">
                <button class="icon-btn" onclick="window.location.href='favorie.html'">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span class="badge" id="favBadge">0</span>
                </button>
                
                <!-- NOUVEAU BOUTON PARAM√àTRES -->
                <button class="icon-btn" id="settingsBtn" title="Param√®tres">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
                <button class="icon-btn" id="notifBtn" title="Notifications">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                </button>
                
               
            </div>
        </div>
        
        <!-- Barre de recherche -->
        <div class="search-container">
            <div class="search-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" placeholder="Rechercher des produits, boutiques..." id="searchInput">
            </div>
        </div>
    </header>
    <!-- Menu Lat√©ral -->
<div class="side-menu" id="sideMenu">
    <div class="menu-header">
        <h2>Menu</h2>
        <button class="btn-close" id="closeMenuBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </button>
    </div>
    
    <div class="menu-content">
        <!-- Section Cat√©gories -->
        <div class="menu-section">
            <h3>Cat√©gories</h3>
            <div class="category-list" id="categoryList">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
        
        <!-- Section Navigation -->
        <div class="menu-section">
            <h3>Navigation</h3>
            <a href="oda-achats.html" class="menu-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="9 22 9 12 15 12 15 22" stroke="currentColor" stroke-width="2"/>
                </svg>
                Accueil
            </a>
            <a href="favorie.html" class="menu-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2"/>
                </svg>
                Mes Favoris
            </a>
            <a href="boutique.html" class="menu-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z" stroke="currentColor" stroke-width="2"/>
                    <path d="M3 9l1.5-5h15L21 9M9 13v4m6-4v4" stroke="currentColor" stroke-width="2"/>
                </svg>
                Boutiques
            </a>
        </div>
        
        <!-- Section Informations -->
        <div class="menu-section">
            <h3>Informations</h3>
            <a href="#" class="menu-link" id="aboutLink">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 16v-4M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                √Ä propos
            </a>
            <a href="#" class="menu-link" id="contactLink">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Contact
            </a>
            <a href="#" class="menu-link" id="helpLink">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3m.08 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Aide
            </a>
        </div>
    </div>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>


    <!-- Carousel Produits Populaires avec boutons transparents -->
    <section class="hero-carousel" id="heroCarousel">
        <div class="carousel-wrapper">
            <button class="carousel-btn prev" id="btnPrev" aria-label="Pr√©c√©dent">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M15 18l-6-6 6-6"/>
                </svg>
            </button>
            
            <div class="carousel-container" id="carouselContainer">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
            
            <button class="carousel-btn next" id="btnNext" aria-label="Suivant">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </button>
        </div>
        
        <!-- Message de d√©couverte -->
       
        
        <!-- Boutons transparents sur la banni√®re -->
        <div class="banner-actions">
            <button class="banner-btn" onclick="scrollToProducts()">
                <div class="banner-icon">üéÅ</div>
                <span>produits</span>
            </button>
            <button class="banner-btn" onclick="window.location.href='favorie.html'">
                <div class="banner-icon">‚ù§Ô∏è</div>
                <span>favoris</span>
            </button>
            <button class="banner-btn" onclick="window.location.href='boutique.html'">
                <div class="banner-icon">üè™</div>
                <span>boutique</span>
            </button>
        </div>
        
        <div class="carousel-dots" id="carouselDots"></div>
    </section>

   

    <!-- Grid Produits -->
    <main class="products-container">
        <div class="section-header">
            <h2>Tous les produits</h2>
            <span class="product-count" id="productCount">0 produits</span>
        </div>
        
        <div class="products-grid" id="productsGrid">
            <!-- G√©n√©r√© dynamiquement -->
        </div>
        
        <div class="empty-state" id="emptyState" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="8"/>
                <path d="M21 21l-4.35-4.35"/>
            </svg>
            <h3>Aucun produit trouv√©</h3>
            <p>Revenez plus tard pour d√©couvrir nos nouveaux produits</p>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Modal Param√®tres -->
<div class="settings-modal" id="settingsModal">
    <div class="modal-backdrop" onclick="document.getElementById('settingsModal').classList.remove('active')"></div>
    <div class="settings-modal-content">
        <div class="settings-header">
            <h2>‚öôÔ∏è Param√®tres</h2>
            <button class="btn-close" onclick="document.getElementById('settingsModal').classList.remove('active')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
            <button class="icon-btn" id="notifBtn" title="Notifications">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
                <span class="badge" id="notifBadge" style="display: none;">0</span>
            </button>
        </div>
        
        <div class="settings-body">
            <!-- Section Profil -->
            <div class="settings-section">
                <div class="section-header">
                    <span class="section-icon">üë§</span>
                    <h3>Profil utilisateur</h3>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <span>Nom d'utilisateur</span>
                        <span class="label-badge" id="nameChangeBadge">Modifiable</span>
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="userNameInput" placeholder="Votre nom" readonly>
                        <button class="btn-primary" id="changeNameBtn" onclick="ouvrirChangementNom()">
                            Modifier
                        </button>
                    </div>
                    <small class="form-hint" id="nameChangeHint">Changement de nom autoris√© tous les 3 mois</small>
                </div>
            </div>
            
            <!-- Section Notifications -->
            
<div class="settings-section">
    <div class="section-header">
        <span class="section-icon">üîî</span>
        <h3>Notifications Push</h3>
    </div>
    
    <div id="notificationStatus" style="
        background: var(--bg-secondary);
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    ">
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">Statut des notifications</div>
            <div id="notifStatusText" style="font-size: 0.9rem; color: var(--text-secondary);">
                Chargement...
            </div>
        </div>
        <button class="btn-primary" id="enableNotifBtn" onclick="activerNotifications()">
            Activer
        </button>
    </div>
    
    <div class="settings-toggle">
        <div class="toggle-info">
            <div class="toggle-title">Nouveaux produits</div>
            <div class="toggle-desc">√ätre notifi√© des nouveaux produits</div>
        </div>
        <label class="switch">
            <input type="checkbox" id="notifNewProducts" checked>
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="settings-toggle">
        <div class="toggle-info">
            <div class="toggle-title">Promotions</div>
            <div class="toggle-desc">Recevoir les offres sp√©ciales</div>
        </div>
        <label class="switch">
            <input type="checkbox" id="notifPromotions" checked>
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="settings-toggle">
        <div class="toggle-info">
            <div class="toggle-title">Nouveaux commentaires</div>
            <div class="toggle-desc">Sur les produits que vous suivez</div>
        </div>
        <label class="switch">
            <input type="checkbox" id="notifComments" checked>
            <span class="slider"></span>
        </label>
    </div>
    
    <div class="settings-toggle">
        <div class="toggle-info">
            <div class="toggle-title">Produits populaires</div>
            <div class="toggle-desc">Vos favoris qui deviennent populaires</div>
        </div>
        <label class="switch">
            <input type="checkbox" id="notifPopular" checked>
            <span class="slider"></span>
        </label>
    </div>
</div>
            
            <!-- Section Pr√©f√©rences -->
            <div class="settings-section">
                <div class="section-header">
                    <span class="section-icon">üé®</span>
                    <h3>Pr√©f√©rences</h3>
                </div>
                
                <div class="settings-toggle">
                    <div class="toggle-info">
                        <div class="toggle-title">Mode sombre</div>
                        <div class="toggle-desc">Activer le th√®me sombre</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="darkMode">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-toggle">
                    <div class="toggle-info">
                        <div class="toggle-title">Sons</div>
                        <div class="toggle-desc">Activer les sons de l'application</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="appSounds" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- Section Donn√©es -->
            <div class="settings-section">
                <div class="section-header">
                    <span class="section-icon">üóëÔ∏è</span>
                    <h3>Donn√©es</h3>
                </div>
                
                <button class="btn-danger" onclick="effacerDonnees()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Effacer toutes mes donn√©es
                </button>
            </div>
        </div>
    </div>
</div>
<script src="pwa-manager.js"></script>
<script type="module">
    // ==================== CONFIGURATION SUPABASE ====================
const SUPABASE_URL = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ==================== VARIABLES GLOBALES ====================
let allProducts = [];
let favoriteProducts = new Set();
let productLikes = {};
let productComments = {};
let currentFilter = 'all';
let carouselInterval;
let currentSlide = 0;
let popularProducts = [];
let currentUserId = getUserId();

// ==================== 1. CACHE MANAGER ====================
class CacheManager {
    constructor() {
        this.CACHE_KEYS = {
            PRODUCTS: 'oda_products_v2',
            LIKES: 'oda_likes_v2',
            COMMENTS: 'oda_comments_v2',
            SHOPS: 'oda_shops_v2',
            TIMESTAMP: 'oda_cache_timestamp'
        };
        this.CACHE_DURATION = 60 * 60 * 1000; // 1 heure
    }

    saveToCache(key, data) {
        try {
            const cacheData = { data, timestamp: Date.now() };
            localStorage.setItem(key, JSON.stringify(cacheData));
            console.log(`üíæ Cache sauvegard√©: ${key}`);
            return true;
        } catch (e) {
            console.error(`‚ùå Erreur cache ${key}:`, e);
            if (e.name === 'QuotaExceededError') {
                this.clearOldCaches();
                try {
                    localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
                    return true;
                } catch (e2) {
                    console.error('‚ùå √âchec apr√®s nettoyage:', e2);
                }
            }
            return false;
        }
    }

    loadFromCache(key) {
        try {
            const cached = localStorage.getItem(key);
            if (!cached) return null;
            const { data, timestamp } = JSON.parse(cached);
            const age = Date.now() - timestamp;
            if (age < this.CACHE_DURATION) {
                console.log(`üì¶ Cache charg√©: ${key} (√¢ge: ${Math.round(age/1000)}s)`);
                return data;
            }
            localStorage.removeItem(key);
            return null;
        } catch (e) {
            return null;
        }
    }

    saveAll(products, likes, comments, shops) {
        const results = {
            products: this.saveToCache(this.CACHE_KEYS.PRODUCTS, products),
            likes: this.saveToCache(this.CACHE_KEYS.LIKES, likes),
            comments: this.saveToCache(this.CACHE_KEYS.COMMENTS, comments),
            shops: this.saveToCache(this.CACHE_KEYS.SHOPS, shops)
        };
        localStorage.setItem(this.CACHE_KEYS.TIMESTAMP, Date.now().toString());
        return Object.values(results).every(r => r);
    }

    loadAll() {
        return {
            products: this.loadFromCache(this.CACHE_KEYS.PRODUCTS),
            likes: this.loadFromCache(this.CACHE_KEYS.LIKES),
            comments: this.loadFromCache(this.CACHE_KEYS.COMMENTS),
            shops: this.loadFromCache(this.CACHE_KEYS.SHOPS)
        };
    }

    hasCompleteCache() {
        return Object.values(this.CACHE_KEYS).slice(0, 4).every(key => {
            const item = localStorage.getItem(key);
            if (!item) return false;
            try {
                const { timestamp } = JSON.parse(item);
                return (Date.now() - timestamp) < this.CACHE_DURATION;
            } catch { return false; }
        });
    }

    clearAll() {
        Object.values(this.CACHE_KEYS).forEach(key => localStorage.removeItem(key));
        console.log('üóëÔ∏è Cache vid√©');
    }

    clearOldCaches() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('oda_') && !Object.values(this.CACHE_KEYS).includes(key)) {
                localStorage.removeItem(key);
            }
        });
    }

    getStats() {
        const timestamp = localStorage.getItem(this.CACHE_KEYS.TIMESTAMP);
        const age = timestamp ? Date.now() - parseInt(timestamp) : 0;
        const minutes = Math.floor(age / 60000);
        const ageStr = minutes > 0 ? `${minutes}m` : `${Math.floor(age/1000)}s`;
        
        return {
            valid: this.hasCompleteCache(),
            age: ageStr,
            size: this.getCacheSize()
        };
    }

    getCacheSize() {
        let total = 0;
        Object.values(this.CACHE_KEYS).forEach(key => {
            const item = localStorage.getItem(key);
            if (item) total += item.length;
        });
        if (total < 1024) return `${total} B`;
        if (total < 1024 * 1024) return `${(total / 1024).toFixed(1)} KB`;
        return `${(total / (1024 * 1024)).toFixed(2)} MB`;
    }
}

window.cacheManager = new CacheManager();

// ==================== 2. LOADING PROGRESS ====================
class LoadingProgress {
    constructor() {
        this.currentProgress = 0;
        this.targetProgress = 0;
        this.isLoading = false;
        this.init();
    }

    init() {
        const styles = `<style>
            .loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 99999; opacity: 1; transition: opacity 0.5s; }
            .loader-overlay.fade-out { opacity: 0; pointer-events: none; }
            .loader-content { text-align: center; max-width: 400px; width: 90%; }
            .loader-logo { margin-bottom: 40px; animation: fadeInDown 0.6s; }
            .logo-icon { font-size: 4rem; margin-bottom: 16px; animation: bounce 2s infinite; }
            .logo-text { font-size: 1.8rem; font-weight: 800; color: white; text-shadow: 0 2px 20px rgba(0,0,0,0.3); }
            .progress-container { margin-bottom: 24px; animation: fadeInUp 0.6s 0.2s both; }
            .progress-bar-bg { position: relative; width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
            .progress-bar { position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(90deg, #FF6B00, #FFA500); border-radius: 10px; width: 0%; transition: width 0.3s; box-shadow: 0 0 20px rgba(255,107,0,0.5); }
            .progress-shine { position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shine 2s infinite; }
            @keyframes shine { 0% { left: -100%; } 50%, 100% { left: 100%; } }
            .progress-text { display: flex; justify-content: space-between; color: white; font-size: 0.9rem; }
            .progress-percentage { font-size: 1.5rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
            .progress-step { font-size: 0.85rem; opacity: 0.9; }
            .loading-dots { display: flex; justify-content: center; gap: 8px; animation: fadeInUp 0.6s 0.4s both; }
            .loading-dots span { width: 8px; height: 8px; background: rgba(255,255,255,0.6); border-radius: 50%; animation: dotPulse 1.4s infinite both; }
            .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
            .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
            @keyframes dotPulse { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1.2); opacity: 1; } }
            @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        </style>`;
        document.head.insertAdjacentHTML('beforeend', styles);
    }

    start() {
        this.isLoading = true;
        this.currentProgress = 0;
        this.targetProgress = 0;
        
        const html = `<div class="loader-overlay" id="loaderOverlay">
            <div class="loader-content">
                <div class="loader-logo">
                    <div class="logo-icon">üõçÔ∏è</div>
                    <div class="logo-text">ODA Marketplace</div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar" id="progressBar"></div>
                        <div class="progress-shine"></div>
                    </div>
                    <div class="progress-text">
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                        <span class="progress-step" id="progressStep">Initialisation...</span>
                    </div>
                </div>
                <div class="loading-dots"><span></span><span></span><span></span></div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('afterbegin', html);
        this.overlay = document.getElementById('loaderOverlay');
        this.progressBar = document.getElementById('progressBar');
        this.progressPercentage = document.getElementById('progressPercentage');
        this.progressStep = document.getElementById('progressStep');
        
        this.animate();
    }

    updateProgress(percentage, step) {
        this.targetProgress = Math.min(100, Math.max(0, percentage));
        if (step) this.progressStep.textContent = step;
    }

    animate() {
        if (!this.isLoading) return;
        const diff = this.targetProgress - this.currentProgress;
        this.currentProgress += diff * 0.1;
        const display = Math.round(this.currentProgress);
        this.progressBar.style.width = `${display}%`;
        this.progressPercentage.textContent = `${display}%`;
        if (Math.abs(diff) > 0.5) requestAnimationFrame(() => this.animate());
    }

    complete() {
        this.updateProgress(100, 'Chargement termin√© !');
        setTimeout(() => this.hide(), 500);
    }

    hide() {
        this.isLoading = false;
        if (this.overlay) {
            this.overlay.classList.add('fade-out');
            setTimeout(() => this.overlay.remove(), 500);
        }
    }

    showError(msg) {
        this.progressStep.textContent = `‚ùå ${msg}`;
        this.progressBar.style.background = 'linear-gradient(90deg, #EF4444, #DC2626)';
        setTimeout(() => this.hide(), 2000);
    }
}

window.loadingProgress = new LoadingProgress();

// ==================== 3. OPTIMIZED DATA LOADER ====================
class OptimizedDataLoader {
    constructor(supabase) {
        this.supabase = supabase;
        this.cache = window.cacheManager;
        this.loader = window.loadingProgress;
        this.data = { products: [], likes: {}, comments: {}, shops: {} };
    }

    async load() {
        this.loader.start();
        this.loader.updateProgress(0, 'V√©rification du cache...');

        try {
            if (this.cache.hasCompleteCache()) {
                console.log('üì¶ Chargement depuis le cache...');
                await this.loadFromCache();
                this.loader.complete();
                return this.data;
            }

            console.log('üåê Chargement depuis le serveur...');
            await this.loadFromServer();
            this.loader.complete();
            return this.data;
        } catch (error) {
            console.error('‚ùå Erreur:', error);
            this.loader.showError('√âchec du chargement');
            throw error;
        }
    }

    async loadFromCache() {
        const cached = this.cache.loadAll();
        this.data.products = cached.products || [];
        this.data.likes = cached.likes || {};
        this.data.comments = cached.comments || {};
        this.data.shops = cached.shops || {};
        await this.simulateProgress(10, 100, 500);
        console.log(`‚úÖ ${this.data.products.length} produits depuis le cache`);
        setTimeout(() => this.updateInBackground(), 2000);
    }

    async loadFromServer() {
        this.loader.updateProgress(10, 'Chargement des boutiques...');
        await this.loadShops();
        this.loader.updateProgress(30, 'Chargement des produits...');
        await this.loadProducts();
        this.loader.updateProgress(50, 'Chargement des likes...');
        await this.loadLikes();
        this.loader.updateProgress(70, 'Chargement des commentaires...');
        await this.loadComments();
        this.loader.updateProgress(85, 'Traitement des donn√©es...');
        this.processData();
        this.loader.updateProgress(95, 'Sauvegarde en cache...');
        this.saveToCache();
        this.loader.updateProgress(100);
    }

    async loadShops() {
        const { data, error } = await this.supabase
            .from('parametres_boutique')
            .select('user_id, config');
        if (error) throw error;
        data.forEach(shop => {
            const slug = shop.config?.identifiant?.slug || shop.config?.slug || null;
            this.data.shops[shop.user_id] = {
                nom: shop.config?.general?.nom || 'Boutique',
                identifiant: slug,
                couleurPrimaire: shop.config?.apparence?.couleurPrimaire || '#FF6B00'
            };
        });
        console.log(`üè™ ${Object.keys(this.data.shops).length} boutiques`);
    }

    async loadProducts() {
        const { data, error } = await this.supabase
            .from('produits')
            .select('*')
            .eq('statut', 'published')
            .gt('stock', 0);
        if (error) throw error;
        this.data.products = data.map(p => ({
            id: p.id, nom: p.nom, description: p.description,
            prix: p.prix, stock: p.stock, mainImage: p.main_image,
            categorie: p.categorie, userId: p.user_id, created_at: p.created_at
        }));
        console.log(`üì¶ ${this.data.products.length} produits`);
    }

    async loadLikes() {
        const { data, error } = await this.supabase
            .from('product_likes')
            .select('product_id, user_id');
        if (error) throw error;
        data.forEach(like => {
            if (!this.data.likes[like.product_id]) {
                this.data.likes[like.product_id] = { count: 0, users: [] };
            }
            this.data.likes[like.product_id].count++;
            this.data.likes[like.product_id].users.push(like.user_id);
        });
        console.log(`üëç ${Object.keys(this.data.likes).length} produits lik√©s`);
    }

    async loadComments() {
        const { data, error } = await this.supabase
            .from('product_comments')
            .select('*')
            .order('created_at', { ascending: false });
        if (error) throw error;
        data.forEach(comment => {
            if (!this.data.comments[comment.product_id]) {
                this.data.comments[comment.product_id] = [];
            }
            this.data.comments[comment.product_id].push(comment);
        });
        console.log(`üí¨ ${Object.keys(this.data.comments).length} produits comment√©s`);
    }

    processData() {
        this.data.products = this.data.products.map(p => ({
            ...p,
            shopName: this.data.shops[p.userId]?.nom || 'Boutique',
            shopSlug: this.data.shops[p.userId]?.identifiant,
            shopColor: this.data.shops[p.userId]?.couleurPrimaire,
            likes: this.data.likes[p.id]?.count || 0,
            commentsCount: (this.data.comments[p.id] || []).length,
            rating: this.calculateAverageRating(this.data.comments[p.id] || [])
        }));
    }

    calculateAverageRating(comments) {
        if (!comments || comments.length === 0) return '0.0';
        return (comments.reduce((acc, c) => acc + (c.rating || 0), 0) / comments.length).toFixed(1);
    }

    saveToCache() {
        this.cache.saveAll(this.data.products, this.data.likes, this.data.comments, this.data.shops);
    }

    async updateInBackground() {
        console.log('üîÑ Mise √† jour en arri√®re-plan...');
        setTimeout(async () => {
            try {
                await this.loadFromServer();
                console.log('‚úÖ Cache mis √† jour');
            } catch (error) {
                console.error('‚ùå Erreur arri√®re-plan:', error);
            }
        }, 2000);
    }

    async simulateProgress(from, to, duration) {
        const steps = 20;
        const increment = (to - from) / steps;
        const delay = duration / steps;
        for (let i = 0; i < steps; i++) {
            await new Promise(resolve => setTimeout(resolve, delay));
            this.loader.updateProgress(from + increment * (i + 1));
        }
    }

    async forceReload() {
        this.cache.clearAll();
        return this.load();
    }
}

// ==================== 4. IMPROVED MENU ====================
// ==================== MENU HAMBURGER AM√âLIOR√â ====================
class ImprovedMenu {
    constructor() {
        this.products = [];
        this.categories = new Map();
        this.isOpen = false;
    }

    // Initialiser le menu
    init(products) {
        this.products = products;
        this.generateCategories();
        this.setupEventListeners();
        this.render();
    }

    // G√©n√©rer les cat√©gories avec comptage
    generateCategories() {
        this.categories.clear();
        
        // Ajouter "Tous" en premier
        this.categories.set('Tous', this.products.length);
        
        // Compter les produits par cat√©gorie
        const categoryCounts = {};
        
        this.products.forEach(product => {
            const category = product.categorie || 'Autres';
            categoryCounts[category] = (categoryCounts[category] || 0) + 1;
        });

        // Trier les cat√©gories par nombre de produits (d√©croissant)
        const sortedCategories = Object.entries(categoryCounts)
            .sort((a, b) => b[1] - a[1]);

        sortedCategories.forEach(([category, count]) => {
            this.categories.set(category, count);
        });

        console.log(`üìÇ ${this.categories.size} cat√©gories g√©n√©r√©es`);
    }

    // Rendre le menu
    render() {
        const categoryList = document.getElementById('categoryList');
        if (!categoryList) {
            console.warn('‚ö†Ô∏è Element categoryList non trouv√©');
            return;
        }

        if (this.categories.size === 0) {
            categoryList.innerHTML = `
                <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                    <p style="font-size: 0.9rem;">Aucune cat√©gorie disponible</p>
                    <p style="font-size: 0.8rem; margin-top: 8px; opacity: 0.7;">
                        Les produits se chargent...
                    </p>
                </div>
            `;
            return;
        }

        let html = '';
        
        this.categories.forEach((count, category) => {
            const isAll = category === 'Tous';
            const icon = this.getCategoryIcon(category);
            const percentage = ((count / this.products.length) * 100).toFixed(0);
            
            html += `
                <div class="category-item ${isAll ? 'category-all' : ''}" 
                     onclick="window.improvedMenu.selectCategory('${category}')"
                     data-category="${category}">
                    <div class="category-content">
                        <div class="category-header">
                            <span class="category-icon">${icon}</span>
                            <span class="category-name">${category}</span>
                        </div>
                        <div class="category-stats">
                            <span class="category-count">${count}</span>
                            ${!isAll ? `<span class="category-percentage">${percentage}%</span>` : ''}
                        </div>
                    </div>
                    ${!isAll ? `
                        <div class="category-progress">
                            <div class="category-progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        categoryList.innerHTML = html;
        
        // Ajouter les styles pour les nouvelles cat√©gories
        this.injectStyles();
        
        console.log(`‚úÖ Menu rendu avec ${this.categories.size} cat√©gories`);
    }

    // Obtenir l'ic√¥ne de la cat√©gorie
    getCategoryIcon(category) {
        const icons = {
            'Tous': 'üè†',
            '√âlectronique': 'üì±',
            'Mode': 'üëï',
            'Maison': 'üè°',
            'Beaut√©': 'üíÑ',
            'Sport': '‚öΩ',
            'Livres': 'üìö',
            'Jouets': 'üß∏',
            'Alimentation': 'üçî',
            'Sant√©': 'üíä',
            'Auto': 'üöó',
            'Jardin': 'üå±',
            'Autres': 'üì¶'
        };
        
        // Recherche par correspondance partielle
        for (const [key, icon] of Object.entries(icons)) {
            if (category.toLowerCase().includes(key.toLowerCase())) {
                return icon;
            }
        }
        
        return icons['Autres'];
    }

    // S√©lectionner une cat√©gorie
    selectCategory(category) {
        console.log(`üìÇ Cat√©gorie s√©lectionn√©e: ${category}`);
        
        // Fermer le menu
        this.close();
        
        // Dispatch event pour filtrage
        const event = new CustomEvent('categorySelected', { 
            detail: { category } 
        });
        window.dispatchEvent(event);
        
        // Mettre √† jour l'affichage
        this.highlightCategory(category);
    }

    // Mettre en surbrillance la cat√©gorie active
    highlightCategory(category) {
        document.querySelectorAll('.category-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.category === category) {
                item.classList.add('active');
            }
        });
    }

    // Configurer les √©couteurs d'√©v√©nements
    setupEventListeners() {
        const menuBtn = document.getElementById('menuBtn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        
        if (menuBtn) {
            menuBtn.addEventListener('click', () => this.open());
        }
        
        if (closeMenuBtn) {
            closeMenuBtn.addEventListener('click', () => this.close());
        }
        
        if (overlay) {
            overlay.addEventListener('click', () => this.close());
        }

        // Fermeture au clavier
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.close();
            }
        });
    }

    // Ouvrir le menu
    open() {
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        
        if (sideMenu) {
            sideMenu.classList.add('active');
            this.isOpen = true;
        }
        
        if (overlay) {
            overlay.classList.add('active');
        }
        
        // R√©g√©n√©rer si les produits ont chang√©
        if (this.products.length > 0) {
            this.generateCategories();
            this.render();
        }
    }

    // Fermer le menu
    close() {
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        
        if (sideMenu) {
            sideMenu.classList.remove('active');
            this.isOpen = false;
        }
        
        if (overlay) {
            overlay.classList.remove('active');
        }
    }

    // Mettre √† jour avec de nouveaux produits
    update(products) {
        this.products = products;
        this.generateCategories();
        if (this.isOpen) {
            this.render();
        }
    }

    // Injecter les styles CSS
    injectStyles() {
        if (document.getElementById('improved-menu-styles')) return;
        
        const styles = `
            <style id="improved-menu-styles">
                .category-item {
                    position: relative;
                    padding: 0;
                    background: var(--bg-secondary);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid transparent;
                    overflow: hidden;
                    margin-bottom: 8px;
                }

                .category-item.active {
                    border-color: var(--primary-color);
                    background: linear-gradient(90deg, 
                        rgba(255, 107, 0, 0.1), 
                        rgba(255, 107, 0, 0.05)
                    );
                }

                .category-all {
                    background: linear-gradient(135deg, 
                        var(--primary-color), 
                        var(--primary-dark)
                    );
                    color: white;
                    font-weight: 600;
                }

                .category-all .category-name,
                .category-all .category-count {
                    color: white;
                }

                .category-content {
                    padding: 14px 16px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .category-header {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .category-icon {
                    font-size: 1.3rem;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                }

                .category-name {
                    font-weight: 600;
                    color: var(--text-primary);
                    font-size: 0.95rem;
                }

                .category-stats {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .category-count {
                    font-weight: 700;
                    color: var(--primary-color);
                    font-size: 1.1rem;
                    background: rgba(255, 107, 0, 0.1);
                    padding: 4px 10px;
                    border-radius: 12px;
                    min-width: 40px;
                    text-align: center;
                }

                .category-all .category-count {
                    background: rgba(255,255,255,0.2);
                }

                .category-percentage {
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                    font-weight: 600;
                }

                .category-progress {
                    height: 3px;
                    background: rgba(0,0,0,0.05);
                    overflow: hidden;
                }

                .category-progress-bar {
                    height: 100%;
                    background: linear-gradient(90deg, 
                        var(--primary-color), 
                        var(--primary-dark)
                    );
                    transition: width 0.5s ease;
                }

                .category-item:hover {
                    transform: translateX(4px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }

                .category-item:active {
                    transform: scale(0.98);
                }

                @media (max-width: 768px) {
                    .category-content {
                        padding: 12px 14px;
                    }
                    
                    .category-name {
                        font-size: 0.9rem;
                    }
                    
                    .category-count {
                        font-size: 1rem;
                        padding: 3px 8px;
                    }
                }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', styles);
    }

    // Obtenir les statistiques
    getStats() {
        return {
            totalCategories: this.categories.size,
            totalProducts: this.products.length,
            categories: Array.from(this.categories.entries()).map(([name, count]) => ({
                name,
                count,
                percentage: ((count / this.products.length) * 100).toFixed(1)
            }))
        };
    }
}

// Instance globale
window.improvedMenu = new ImprovedMenu();
console.log('üì± Improved Menu initialis√©');


// ==================== GESTION UTILISATEUR ====================
function getUserId() {
    let userId = localStorage.getItem('oda_user_id');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('oda_user_id', userId);
    }
    return userId;
}

function getUserName() {
    let userName = localStorage.getItem('oda_user_name');
    if (!userName) {
        userName = prompt('Entrez votre nom pour commenter:') || 'Anonyme';
        localStorage.setItem('oda_user_name', userName);
    }
    return userName;
}

// ==================== FAVORIS ====================
function loadFavorites() {
    const stored = localStorage.getItem('oda_favorites');
    if (stored) {
        try {
            favoriteProducts = new Set(JSON.parse(stored));
            console.log(`‚ù§Ô∏è ${favoriteProducts.size} favoris charg√©s`);
        } catch (e) {
            favoriteProducts = new Set();
        }
    }
}

function saveFavorites() {
    localStorage.setItem('oda_favorites', JSON.stringify([...favoriteProducts]));
}

function toggleFavorite(productId) {
    if (favoriteProducts.has(productId)) {
        favoriteProducts.delete(productId);
        showToast('Retir√© des favoris', 'info');
    } else {
        favoriteProducts.add(productId);
        showToast('Ajout√© aux favoris', 'success');
    }
    saveFavorites();
    updateBadges();
    displayProducts();
    updateCarousel();
}

function updateBadges() {
    const favBadge = document.getElementById('favBadge');
    if (favBadge) {
        const favCount = favoriteProducts.size;
        favBadge.textContent = favCount;
        favBadge.style.display = favCount > 0 ? 'flex' : 'none';
    }
}

// ==================== LIKES ====================
async function toggleLike(productId) {
    const currentLike = productLikes[productId] || { count: 0, userLiked: false };

    try {
        if (currentLike.userLiked) {
            await supabase.from('product_likes').delete()
                .eq('product_id', productId).eq('user_id', currentUserId);
            productLikes[productId] = {
                count: Math.max(0, currentLike.count - 1),
                userLiked: false
            };
            showToast('Like retir√©', 'info');
        } else {
            await supabase.from('product_likes').insert({
                product_id: productId,
                user_id: currentUserId
            });
            productLikes[productId] = {
                count: currentLike.count + 1,
                userLiked: true
            };
            showToast('Produit lik√© !', 'success');
        }
        updateLikeButton(productId);
        updateCarousel();
    } catch (error) {
        console.error('Erreur like:', error);
        showToast('Erreur lors du like', 'error');
    }
}

function updateLikeButton(productId) {
    const likeData = productLikes[productId] || { count: 0, userLiked: false };
    const likeBtns = document.querySelectorAll(`[data-like-product="${productId}"]`);
    
    likeBtns.forEach(btn => {
        const countSpan = btn.querySelector('.like-count');
        const icon = btn.querySelector('.like-icon');
        if (countSpan) countSpan.textContent = likeData.count;
        if (icon) icon.textContent = likeData.userLiked ? '‚ù§Ô∏è' : 'ü§ç';
        btn.classList.toggle('liked', likeData.userLiked);
    });
}

// ==================== COMMENTAIRES ====================
async function addComment(productId, commentText, rating) {
    if (!commentText.trim()) {
        showToast('Le commentaire ne peut pas √™tre vide', 'error');
        return;
    }

    const userName = getUserName();

    try {
        const { data, error } = await supabase.from('product_comments').insert({
            product_id: productId,
            user_id: currentUserId,
            user_name: userName,
            comment: commentText.trim(),
            rating: rating || 5
        }).select().single();

        if (error) throw error;

        if (!productComments[productId]) {
            productComments[productId] = [];
        }
        productComments[productId].unshift(data);
        showToast('Commentaire ajout√© !', 'success');
        return data;
    } catch (error) {
        console.error('Erreur commentaire:', error);
        showToast('Erreur lors de l\'ajout', 'error');
    }
}

function calculateAverageRating(comments) {
    if (!comments || comments.length === 0) return '0.0';
    const sum = comments.reduce((acc, c) => acc + (c.rating || 0), 0);
    return (sum / comments.length).toFixed(1);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Aujourd\'hui';
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return `Il y a ${diffDays} jours`;
    if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaines`;
    return date.toLocaleDateString('fr-FR');
}

// ==================== MODAL COMMENTAIRES ====================
function showCommentsModal(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;

    const comments = productComments[productId] || [];
    const likeData = productLikes[productId] || { count: 0, userLiked: false };

    const modal = document.createElement('div');
    modal.className = 'comments-modal';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>${product.nom}</h3>
                <button class="btn-close" onclick="this.closest('.comments-modal').remove()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-stats">
                <div class="stat-item">
                    <span class="stat-icon">‚ù§Ô∏è</span>
                    <span class="stat-value">${likeData.count}</span>
                    <span class="stat-label">Likes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">üí¨</span>
                    <span class="stat-value">${comments.length}</span>
                    <span class="stat-label">Commentaires</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">‚≠ê</span>
                    <span class="stat-value">${calculateAverageRating(comments)}</span>
                    <span class="stat-label">Note moyenne</span>
                </div>
            </div>
            <div class="comment-form">
                <h4>Ajouter un commentaire</h4>
                <div class="rating-input">
                    <span>Note :</span>
                    ${[5,4,3,2,1].map(star => `
                        <label>
                            <input type="radio" name="rating" value="${star}" ${star === 5 ? 'checked' : ''}>
                            <span class="star">${'‚≠ê'.repeat(star)}</span>
                        </label>
                    `).join('')}
                </div>
                <textarea id="commentInput" placeholder="Partagez votre avis..." rows="3"></textarea>
                <button class="btn-submit" onclick="submitComment(${productId})">
                    Publier le commentaire
                </button>
            </div>
            <div class="comments-list">
                <h4>Tous les commentaires (${comments.length})</h4>
                ${comments.length === 0 ? `
                    <div class="empty-comments">
                        <p>Aucun commentaire</p>
                        <p>Soyez le premier √† donner votre avis !</p>
                    </div>
                ` : comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-user">
                                <span class="user-avatar">${c.user_name.charAt(0).toUpperCase()}</span>
                                <span class="user-name">${c.user_name}</span>
                            </div>
                            <div class="comment-rating">${'‚≠ê'.repeat(c.rating)}</div>
                        </div>
                        <p class="comment-text">${c.comment}</p>
                        <span class="comment-date">${formatDate(c.created_at)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

window.submitComment = async function(productId) {
    const input = document.getElementById('commentInput');
    const ratingInput = document.querySelector('input[name="rating"]:checked');
    if (!input || !ratingInput) return;
    
    const comment = input.value;
    const rating = parseInt(ratingInput.value);

    if (comment.trim()) {
        await addComment(productId, comment, rating);
        input.value = '';
        document.querySelector('.comments-modal').remove();
        showCommentsModal(productId);
    }
};

// ==================== UTILITAIRES ====================
function formatPrice(price) {
    return `${price.toLocaleString('fr-FR')} FCFA`;
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    toast.innerHTML = `<span style="font-size:1.2rem;">${icon}</span><span>${message}</span>`;
    
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== NAVIGATION ====================
window.goToProduct = function(productId) {
    window.location.href = `produit.html?id=${productId}`;
};

window.goToShop = function(shopSlug, productId) {
    if (shopSlug) {
        window.location.href = `boutique.html?shop=${shopSlug}#product-${productId}`;
    } else {
        showToast('Boutique non disponible', 'error');
    }
};

window.scrollToProducts = function() {
    document.querySelector('.products-container')?.scrollIntoView({ 
        behavior: 'smooth', block: 'start' 
    });
};

// Exposer les fonctions globales
window.toggleFavorite = toggleFavorite;
window.toggleLike = toggleLike;
window.showCommentsModal = showCommentsModal;
// ==================== AFFICHAGE PRODUITS ====================
function displayProducts() {
    const grid = document.getElementById('productsGrid');
    const emptyState = document.getElementById('emptyState');
    const productCount = document.getElementById('productCount');
    const sectionHeader = document.querySelector('.section-header h2');

    let filteredProducts = [...allProducts];

    if (filteredProducts.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        if (productCount) productCount.textContent = '0 produits';
        return;
    }

    grid.style.display = 'block';
    emptyState.style.display = 'none';
    if (productCount) productCount.textContent = `${filteredProducts.length} produits`;
    
    displayProductsByCategories(filteredProducts);
}

function displayProductsByCategories(products) {
    const grid = document.getElementById('productsGrid');
    const sectionHeader = document.querySelector('.section-header h2');
    if (sectionHeader) sectionHeader.textContent = 'Tous les produits';
    
    const categories = {};
    products.forEach(product => {
        const cat = product.categorie || 'Autres';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(product);
    });

    let html = '';
    Object.keys(categories).forEach(category => {
        const categoryProducts = categories[category].slice(0, 20);
        
        html += `
            <div class="category-section" style="margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="font-size: 1.3rem; font-weight: 700; color: var(--text-primary);">
                        ${category}
                    </h3>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                        ${categoryProducts.length} produits
                    </span>
                </div>
                <div class="horizontal-scroll" style="
                    display: flex;
                    gap: 16px;
                    overflow-x: auto;
                    overflow-y: hidden;
                    padding-bottom: 12px;
                    scroll-snap-type: x mandatory;
                    -webkit-overflow-scrolling: touch;
                ">
                    ${categoryProducts.map(product => createProductCard(product, true)).join('')}
                </div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
    grid.style.display = 'block';
    grid.style.gridTemplateColumns = '1fr';
}

function createProductCard(product, isHorizontal = false) {
    const cardStyle = isHorizontal ? `min-width: 200px; max-width: 200px; scroll-snap-align: start;` : '';
    const likeData = productLikes[product.id] || { count: 0, userLiked: false };
    const commentsCount = (productComments[product.id] || []).length;

    return `
        <div class="product-card" style="${cardStyle}" onclick="goToProduct(${product.id})">
            <div class="product-image-wrapper">
                <button class="btn-favorite ${favoriteProducts.has(product.id) ? 'active' : ''}"
                        onclick="event.stopPropagation(); toggleFavorite(${product.id})">
                    ${favoriteProducts.has(product.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                </button>
                <img src="${product.mainImage || 'https://via.placeholder.com/300'}" 
                     class="product-image" 
                     alt="${product.nom}"
                     loading="lazy"
                     onerror="this.src='https://via.placeholder.com/300?text=Produit'">
            </div>
            <div class="product-info">
                <span class="shop-badge" style="background: ${product.shopColor}15; color: ${product.shopColor}">
                    üè™ ${product.shopName}
                </span>
                <h3 class="product-name">${product.nom}</h3>
                
                <div class="product-engagement">
                    <button class="btn-like ${likeData.userLiked ? 'liked' : ''}" 
                            data-like-product="${product.id}"
                            onclick="event.stopPropagation(); toggleLike(${product.id})">
                        <span class="like-icon">${likeData.userLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                        <span class="like-count">${likeData.count}</span>
                    </button>
                    <button class="btn-comments" onclick="event.stopPropagation(); showCommentsModal(${product.id})">
                        <span>üí¨</span>
                        <span>${commentsCount}</span>
                    </button>
                    ${product.rating && parseFloat(product.rating) > 0 ? `
                        <span class="product-rating">‚≠ê ${product.rating}</span>
                    ` : ''}
                </div>
                
                <div class="product-price" style="color: ${product.shopColor}">${formatPrice(product.prix)}</div>
                ${product.stock < 10 ? `<div class="product-stock">Plus que ${product.stock} en stock !</div>` : ''}
            </div>
        </div>
    `;
}

// ==================== FILTRAGE PAR CAT√âGORIE ====================
function filterByCategory(category) {
    const grid = document.getElementById('productsGrid');
    const emptyState = document.getElementById('emptyState');
    const productCount = document.getElementById('productCount');
    const sectionHeader = document.querySelector('.section-header h2');
    
    let filtered = allProducts;
    if (category !== 'Tous') {
        filtered = allProducts.filter(p => p.categorie === category);
    }
    
    if (sectionHeader) {
        sectionHeader.textContent = category === 'Tous' ? 'Tous les produits' : category;
    }
    
    if (filtered.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        if (productCount) productCount.textContent = '0 produits';
    } else {
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
        if (productCount) productCount.textContent = `${filtered.length} produits`;
        
        if (category === 'Tous') {
            displayProductsByCategories(filtered);
        } else {
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
            grid.innerHTML = filtered.map(product => createProductCard(product, false)).join('');
        }
    }
    
    document.querySelector('.products-container')?.scrollIntoView({ 
        behavior: 'smooth', block: 'start' 
    });
}

// ==================== CAROUSEL ====================
function updateCarousel() {
    const container = document.getElementById('carouselContainer');
    const dotsContainer = document.getElementById('carouselDots');

    popularProducts = [...allProducts]
        .sort((a, b) => {
            const aLikes = productLikes[a.id]?.count || 0;
            const bLikes = productLikes[b.id]?.count || 0;
            return bLikes - aLikes;
        })
        .slice(0, 10);

    if (popularProducts.length === 0) {
        document.getElementById('heroCarousel')?.style.setProperty('display', 'none');
        return;
    }

    container.innerHTML = popularProducts.map(product => {
        const likeData = productLikes[product.id] || { count: 0, userLiked: false };
        const commentsCount = (productComments[product.id] || []).length;
        
        return `
        <div class="carousel-item" onclick="goToProduct(${product.id})">
            <img src="${product.mainImage || 'https://via.placeholder.com/1200x400'}" 
                 class="carousel-image" 
                 alt="${product.nom}"
                 onerror="this.src='https://via.placeholder.com/1200x400'">
            <div class="carousel-overlay">
                <div class="carousel-info">
                    <h2>${product.nom}</h2>
                    <p class="shop-name">üè™ ${product.shopName}</p>
                    <p class="product-price">${formatPrice(product.prix)}</p>
                    <div style="display: flex; gap: 16px; margin-top: 8px; font-size: 0.9rem; opacity: 0.9;">
                        <span>‚ù§Ô∏è ${likeData.count} likes</span>
                        <span>üí¨ ${commentsCount} commentaires</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    }).join('');

    dotsContainer.innerHTML = popularProducts.map((_, i) => 
        `<div class="dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></div>`
    ).join('');

    startCarousel(popularProducts.length);
}

function startCarousel(totalSlides) {
    if (carouselInterval) clearInterval(carouselInterval);
    currentSlide = 0;
    carouselInterval = setInterval(() => {
        currentSlide = (currentSlide + 1) % totalSlides;
        updateCarouselPosition();
    }, 5000);
}

function updateCarouselPosition() {
    const container = document.getElementById('carouselContainer');
    if (!container) return;
    
    container.style.transform = `translateX(-${currentSlide * 100}%)`;
    document.querySelectorAll('.dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === currentSlide);
    });
}

window.goToSlide = function(index) {
    currentSlide = index;
    updateCarouselPosition();
    if (carouselInterval) clearInterval(carouselInterval);
    startCarousel(popularProducts.length);
};

function initCarouselControls() {
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    if (btnPrev) {
        btnPrev.addEventListener('click', () => {
            currentSlide = (currentSlide - 1 + popularProducts.length) % popularProducts.length;
            updateCarouselPosition();
            if (carouselInterval) clearInterval(carouselInterval);
            startCarousel(popularProducts.length);
        });
    }

    if (btnNext) {
        btnNext.addEventListener('click', () => {
            currentSlide = (currentSlide + 1) % popularProducts.length;
            updateCarouselPosition();
            if (carouselInterval) clearInterval(carouselInterval);
            startCarousel(popularProducts.length);
        });
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') btnPrev?.click();
        else if (e.key === 'ArrowRight') btnNext?.click();
    });
}

// ==================== RECHERCHE ====================
function initSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (searchTerm.length === 0) {
            displayProducts();
            return;
        }
        
        const filtered = allProducts.filter(p => 
            p.nom.toLowerCase().includes(searchTerm) ||
            p.shopName.toLowerCase().includes(searchTerm) ||
            p.categorie?.toLowerCase().includes(searchTerm)
        );
        
        const grid = document.getElementById('productsGrid');
        const emptyState = document.getElementById('emptyState');
        const productCount = document.getElementById('productCount');
        
        if (filtered.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            if (productCount) productCount.textContent = '0 produits';
        } else {
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            if (productCount) productCount.textContent = `${filtered.length} produits`;
            grid.innerHTML = filtered.map(product => createProductCard(product, false)).join('');
        }
    });
}
// ==================== CHARGEMENT OPTIMIS√â ====================
async function loadAllProductsOptimized() {
    try {
        const dataLoader = new OptimizedDataLoader(supabase);
        const data = await dataLoader.load();
        
        allProducts = data.products;
        productLikes = data.likes;
        productComments = data.comments;
        
        // Convertir les likes au bon format
        Object.keys(productLikes).forEach(productId => {
            const likeData = productLikes[productId];
            productLikes[productId] = {
                count: likeData.count,
                userLiked: likeData.users.includes(currentUserId)
            };
        });
        
        // Initialiser le menu
        window.improvedMenu.init(allProducts);
        
        // Afficher
        displayProducts();
        updateCarousel();
        
        // Stats
        console.log('üìä STATISTIQUES:');
        console.log(`   - Produits: ${allProducts.length}`);
        console.log(`   - Cache: ${window.cacheManager.getStats().size}`);
        
        return data;
    } catch (error) {
        console.error('‚ùå Erreur:', error);
        document.getElementById('emptyState').style.display = 'block';
        showToast('Erreur de chargement', 'error');
        throw error;
    }
}

// ==================== FILTRAGE PAR CAT√âGORIE ====================
function setupCategoryFiltering() {
    window.addEventListener('categorySelected', (e) => {
        filterByCategory(e.detail.category);
    });
}

// ==================== MENU LAT√âRAL ====================
function initSideMenu() {
    const menuBtn = document.getElementById('menuBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const overlay = document.getElementById('overlay');
    
    if (menuBtn) {
        menuBtn.addEventListener('click', () => {
            document.getElementById('sideMenu')?.classList.add('active');
            overlay?.classList.add('active');
            window.improvedMenu.render();
        });
    }
    
    if (closeMenuBtn) {
        closeMenuBtn.addEventListener('click', () => {
            document.getElementById('sideMenu')?.classList.remove('active');
            overlay?.classList.remove('active');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', () => {
            document.getElementById('sideMenu')?.classList.remove('active');
            overlay.classList.remove('active');
        });
    }
    
    // Liens du menu
    const aboutLink = document.getElementById('aboutLink');
    const contactLink = document.getElementById('contactLink');
    const helpLink = document.getElementById('helpLink');
    
    if (aboutLink) {
        aboutLink.addEventListener('click', (e) => {
            e.preventDefault();
            showToast('Page √Ä propos - En construction', 'info');
        });
    }
    
    if (contactLink) {
        contactLink.addEventListener('click', (e) => {
            e.preventDefault();
            showToast('Page Contact - En construction', 'info');
        });
    }
    
    if (helpLink) {
        helpLink.addEventListener('click', (e) => {
            e.preventDefault();
            showToast('Page Aide - En construction', 'info');
        });
    }
}

// ==================== PARAM√àTRES ====================
let userSettings = {
    userName: '',
    lastNameChange: null,
    notifications: {
        newProducts: true,
        promotions: true,
        comments: true,
        popular: true
    },
    preferences: {
        darkMode: false,
        sounds: true
    }
};

function chargerParametresUtilisateur() {
    try {
        const saved = localStorage.getItem('oda_user_settings');
        if (saved) {
            userSettings = { ...userSettings, ...JSON.parse(saved) };
        }
        if (!userSettings.userName) {
            userSettings.userName = localStorage.getItem('oda_user_name') || '';
        }
        appliquerParametres();
    } catch (e) {
        console.error('Erreur chargement param√®tres:', e);
    }
}

function appliquerParametres() {
    const input = document.getElementById('userNameInput');
    if (input) input.value = userSettings.userName || 'Non d√©fini';
    
    const notifNewProducts = document.getElementById('notifNewProducts');
    const notifPromotions = document.getElementById('notifPromotions');
    const notifComments = document.getElementById('notifComments');
    const notifPopular = document.getElementById('notifPopular');
    const darkMode = document.getElementById('darkMode');
    const appSounds = document.getElementById('appSounds');
    
    if (notifNewProducts) notifNewProducts.checked = userSettings.notifications.newProducts;
    if (notifPromotions) notifPromotions.checked = userSettings.notifications.promotions;
    if (notifComments) notifComments.checked = userSettings.notifications.comments;
    if (notifPopular) notifPopular.checked = userSettings.notifications.popular;
    if (darkMode) darkMode.checked = userSettings.preferences.darkMode;
    if (appSounds) appSounds.checked = userSettings.preferences.sounds;
    
    if (userSettings.preferences.darkMode) {
        document.body.classList.add('dark-mode');
    }
}

function sauvegarderParametres() {
    try {
        localStorage.setItem('oda_user_settings', JSON.stringify(userSettings));
        localStorage.setItem('oda_user_name', userSettings.userName);
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
    }
}

window.ouvrirParametres = function() {
    chargerParametresUtilisateur();
    document.getElementById('settingsModal')?.classList.add('active');
};

window.ouvrirChangementNom = function() {
    const newName = prompt('Entrez votre nouveau nom:', userSettings.userName);
    if (newName && newName.trim() && newName.trim() !== userSettings.userName) {
        userSettings.userName = newName.trim();
        userSettings.lastNameChange = new Date().toISOString();
        sauvegarderParametres();
        appliquerParametres();
        showToast('‚úÖ Nom modifi√©', 'success');
    }
};

window.effacerDonnees = function() {
    if (confirm('‚ö†Ô∏è ATTENTION !\n\nSupprimer vos favoris, param√®tres et historique ?')) {
        localStorage.clear();
        sessionStorage.clear();
        showToast('‚úÖ Donn√©es effac√©es', 'success');
        setTimeout(() => window.location.reload(), 1500);
    }
};

function initialiserParametres() {
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', window.ouvrirParametres);
    }
    
    ['notifNewProducts', 'notifPromotions', 'notifComments', 'notifPopular'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            const key = id.replace('notif', '').replace(/^./, str => str.toLowerCase());
            el.addEventListener('change', function() {
                userSettings.notifications[key] = this.checked;
                sauvegarderParametres();
            });
        }
    });
    
    const darkMode = document.getElementById('darkMode');
    if (darkMode) {
        darkMode.addEventListener('change', function() {
            userSettings.preferences.darkMode = this.checked;
            document.body.classList.toggle('dark-mode', this.checked);
            sauvegarderParametres();
        });
    }
    
    const appSounds = document.getElementById('appSounds');
    if (appSounds) {
        appSounds.addEventListener('change', function() {
            userSettings.preferences.sounds = this.checked;
            sauvegarderParametres();
        });
    }
    
    chargerParametresUtilisateur();
}

// ==================== GESTION DU CACHE ====================
function addForceReloadButton() {
    const settingsBody = document.querySelector('.settings-body');
    if (!settingsBody) return;
    
    const cacheSection = document.createElement('div');
    cacheSection.className = 'settings-section';
    cacheSection.innerHTML = `
        <div class="section-header">
            <span class="section-icon">üíæ</span>
            <h3>Cache de l'application</h3>
        </div>
        <div id="cacheInfo" style="background:var(--bg-secondary);padding:16px;border-radius:12px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="color:var(--text-secondary);">Taille:</span>
                <strong id="cacheSize">Calcul...</strong>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="color:var(--text-secondary);">√Çge:</span>
                <strong id="cacheAge">Calcul...</strong>
            </div>
            <div style="display:flex;justify-content:space-between;">
                <span style="color:var(--text-secondary);">Statut:</span>
                <strong id="cacheStatus">Valide</strong>
            </div>
        </div>
        <button class="btn-primary" onclick="window.forceReloadData()" style="width:100%;background:#3B82F6;margin-bottom:12px;">
            üîÑ Forcer le rechargement
        </button>
        <button class="btn-danger" onclick="window.clearAllCache()">
            üóëÔ∏è Vider le cache
        </button>
    `;
    settingsBody.appendChild(cacheSection);
    updateCacheInfo();
}

function updateCacheInfo() {
    const stats = window.cacheManager?.getStats();
    if (!stats) return;
    
    const sizeEl = document.getElementById('cacheSize');
    const ageEl = document.getElementById('cacheAge');
    const statusEl = document.getElementById('cacheStatus');
    
    if (sizeEl) sizeEl.textContent = stats.size;
    if (ageEl) ageEl.textContent = stats.age || 'Nouveau';
    if (statusEl) {
        statusEl.textContent = stats.valid ? 'Valide ‚úì' : 'Expir√© ‚úó';
        statusEl.style.color = stats.valid ? 'var(--success-color)' : 'var(--error-color)';
    }
}

window.forceReloadData = async function() {
    if (confirm('Recharger depuis le serveur ?')) {
        window.loadingProgress.start();
        try {
            const dataLoader = new OptimizedDataLoader(supabase);
            await dataLoader.forceReload();
            allProducts = dataLoader.data.products;
            productLikes = dataLoader.data.likes;
            productComments = dataLoader.data.comments;
            window.improvedMenu.update(allProducts);
            displayProducts();
            updateCarousel();
            showToast('‚úÖ Donn√©es recharg√©es', 'success');
            updateCacheInfo();
        } catch (error) {
            showToast('‚ùå Erreur', 'error');
        }
    }
};

window.clearAllCache = function() {
    if (confirm('Vider le cache ?')) {
        window.cacheManager.clearAll();
        showToast('üóëÔ∏è Cache vid√©', 'success');
        updateCacheInfo();
    }
};

// ==================== SCROLL HEADER ====================
let lastScrollTop = 0;
function initScrollBehavior() {
    window.addEventListener('scroll', () => {
        const header = document.querySelector('.main-header');
        if (!header) return;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        if (scrollTop > lastScrollTop && scrollTop > 100) {
            header.style.transform = 'translateY(-100%)';
        } else {
            header.style.transform = 'translateY(0)';
        }
        lastScrollTop = scrollTop;
    });
}

// ==================== PWA NOTIFICATIONS ====================
window.verifierStatutNotifications = function() {
    const statusText = document.getElementById('notifStatusText');
    const enableBtn = document.getElementById('enableNotifBtn');
    if (!statusText || !enableBtn) return;
    
    if (!('Notification' in window)) {
        statusText.textContent = '‚ùå Non support√©es';
        enableBtn.disabled = true;
        return;
    }
    
    const permission = Notification.permission;
    switch(permission) {
        case 'granted':
            statusText.innerHTML = '‚úÖ <span style="color:var(--success-color);font-weight:600;">Activ√©es</span>';
            enableBtn.style.display = 'none';
            break;
        case 'denied':
            statusText.innerHTML = '‚ùå <span style="color:var(--error-color);font-weight:600;">Bloqu√©es</span>';
            enableBtn.textContent = 'D√©bloquer';
            break;
        default:
            statusText.innerHTML = '‚ö†Ô∏è <span style="color:#F59E0B;font-weight:600;">Non activ√©es</span>';
            enableBtn.style.display = 'block';
    }
};

window.activerNotifications = async function() {
    if (!window.pwaManager) {
        showToast('PWA Manager non disponible', 'error');
        return;
    }
    const granted = await window.pwaManager.requestNotificationPermission();
    if (granted) {
        window.verifierStatutNotifications();
        showToast('üéâ Notifications activ√©es !', 'success');
    }
};

// ==================== INITIALISATION COMPL√àTE ====================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ ODA MARKETPLACE - VERSION OPTIMIS√âE');
    console.log('='.repeat(50));
    
    // Masquer l'ancien loader
    const oldLoader = document.getElementById('loader');
    if (oldLoader) oldLoader.style.display = 'none';
    
    // Chargement
    loadFavorites();
    updateBadges();
    await loadAllProductsOptimized();
    
    // Initialisation
    setupCategoryFiltering();
    initSideMenu();
    initCarouselControls();
    initSearch();
    initScrollBehavior();
    initialiserParametres();
    addForceReloadButton();
    
    // PWA
    if (window.verifierStatutNotifications) {
        window.verifierStatutNotifications();
    }
    
    // Mode PWA
    const isPWA = window.matchMedia('(display-mode: standalone)').matches;
    if (isPWA) {
        console.log('üì± Mode PWA');
        document.body.classList.add('pwa-mode');
    }
    
    console.log('='.repeat(50));
    console.log('‚úÖ PR√äT');
    console.log('üéØ Fonctionnalit√©s:');
    console.log('   ‚úì Cache local optimis√©');
    console.log('   ‚úì Loader avec pourcentage');
    console.log('   ‚úì Menu avec compteurs');
    console.log('   ‚úì Cat√©gorie "Tous"');
    console.log('   ‚úì Chargement instantan√©');
});

// Refresh auto toutes les 30min
setInterval(() => {
    if (document.visibilityState === 'visible') {
        console.log('üîÑ Mise √† jour auto...');
        const dataLoader = new OptimizedDataLoader(supabase);
        dataLoader.updateInBackground();
    }
}, 30 * 60 * 1000);

// Mise √† jour quand l'onglet redevient visible
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && window.cacheManager) {
        const stats = window.cacheManager.getStats();
        if (!stats.valid) {
            console.log('üîÑ Cache expir√©, rechargement...');
            loadAllProductsOptimized();
        }
    }
});

console.log('üéâ Syst√®me optimis√© pr√™t !');
</script>

</body>
</html>

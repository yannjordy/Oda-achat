<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B00">
    <title>D√©tails du Produit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="oda.png">
    <style>
        /* ==================== VARIABLES ==================== */
        :root {
            --primary-color: #FF6B00;
            --primary-dark: #E55D00;
            --secondary-color: #1A1A1A;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --error-color: #EF4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ==================== HEADER ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-back {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-back:active {
            transform: scale(0.95);
            background: var(--border-color);
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
            padding: 0 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn-share {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-share:active {
            transform: scale(0.95);
            background: var(--border-color);
        }

        /* ==================== CARROUSEL VERTICAL ==================== */
        .carousel-container {
            margin-top: 72px;
            background: var(--bg-primary);
            padding-bottom: 20px;
        }

        .main-image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .main-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image.zoom {
            transform: scale(1.5);
        }

        .image-counter {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .thumbnails-container {
            display: flex;
            gap: 8px;
            padding: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .thumbnails-container::-webkit-scrollbar {
            display: none;
        }

        .thumbnail {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: var(--radius-sm);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .thumbnail.active {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* ==================== CONTENU PRODUIT ==================== */
        .product-content {
            padding: 20px 16px 120px;
        }

        .product-header {
            margin-bottom: 24px;
        }

        .product-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .product-category {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.1), rgba(255, 107, 0, 0.05));
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .price-section {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            color: white;
        }

        .product-price {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-weight: 600;
        }

        .description-section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .product-description {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* Engagement Section */
        .engagement-section {
            background: var(--bg-primary);
            padding: 20px 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .engagement-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .engagement-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-like, .btn-comments {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-like:active, .btn-comments:active {
            transform: scale(0.95);
        }

        .btn-like.liked {
            background: #FFE5E5;
            border-color: var(--error-color);
            color: var(--error-color);
        }

        /* Comments Section */
        .comments-section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .comment-form {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .rating-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .rating-input input[type="radio"] {
            display: none;
        }

        .rating-input label {
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 1.5rem;
        }

        .rating-input label:hover {
            transform: scale(1.1);
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
            transition: border-color 0.3s ease;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-submit-comment {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit-comment:active {
            transform: translateY(-2px);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .comment-rating {
            font-size: 0.9rem;
        }

        .comment-text {
            margin: 8px 0;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .comment-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .empty-comments {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* ==================== BOUTONS D'ACTION ==================== */
        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            padding: 16px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .btn-primary, .btn-secondary {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }

        .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }

        .btn-secondary:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
        }

        .btn-boutique {
            width: 100%;
            padding: 14px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-boutique:active {
            transform: scale(0.98);
            border-color: var(--primary-color);
            background: var(--bg-secondary);
        }

        /* ==================== MODAL PAIEMENT ==================== */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 3000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .payment-modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            width: 100%;
            max-height: 85vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: var(--bg-primary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .btn-close-modal {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
        }

        .order-summary {
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.05), rgba(255, 107, 0, 0.1));
            padding: 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            border: 2px solid rgba(255, 107, 0, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            padding-top: 12px;
            margin-top: 12px;
            border-top: 2px solid rgba(255, 107, 0, 0.3);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-option {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-option:active {
            transform: scale(0.98);
        }

        .payment-option.active {
            border-color: var(--primary-color);
            background: rgba(255, 107, 0, 0.05);
        }

        .payment-icon {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .payment-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ==================== LOADER ==================== */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== NOTIFICATIONS ==================== */
        .notification {
            position: fixed;
            top: 80px;
            right: 16px;
            left: 16px;
            background: white;
            padding: 16px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .notification.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (min-width: 768px) {
            .product-content {
                max-width: 600px;
                margin: 0 auto;
            }

            .action-buttons {
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%);
            }

            .modal-content {
                max-width: 500px;
                border-radius: var(--radius-lg);
                max-height: 80vh;
            }

            .payment-modal {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div style="font-weight: 600; color: var(--primary-color);">Chargement...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationIcon">‚úÖ</span>
        <span id="notificationText"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <button class="btn-back" id="btnBack">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <h1 class="header-title" id="headerTitle">D√©tails du produit</h1>
        <button class="btn-share" id="btnShare">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2"/>
                <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2"/>
                <path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
    </header>

    <!-- Carrousel d'images -->
    <div class="carousel-container">
        <div class="main-image-wrapper" id="mainImageWrapper">
            <img src="" alt="Produit" class="main-image" id="mainImage">
            <div class="image-counter" id="imageCounter">1 / 1</div>
        </div>
        <div class="thumbnails-container" id="thumbnailsContainer">
            <!-- Thumbnails g√©n√©r√©es dynamiquement -->
        </div>
    </div>

    <!-- Contenu produit -->
    <div class="product-content">
        <div class="product-header">
            <h2 class="product-name" id="productName">Nom du produit</h2>
            <span class="product-category" id="productCategory">üì¶ Cat√©gorie</span>
        </div>

        <div class="price-section">
            <div class="product-price" id="productPrice">0 FCFA</div>
            <div class="stock-info">
                <span class="stock-badge">
                    <span id="stockIcon">‚úÖ</span>
                    <span id="stockText">En stock</span>
                </span>
                <span id="stockQuantity">‚Ä¢ 10 disponibles</span>
            </div>
        </div>

        <div class="description-section">
            <h3 class="section-title">
                <span>üìù</span>
                Description
            </h3>
            <p class="product-description" id="productDescription">
                Chargement de la description...
            </p>
        </div>

        <!-- Section Engagement (Likes et Commentaires) -->
        <div class="engagement-section">
            <div class="engagement-stats">
                <div class="stat-item">
                    <span class="stat-value" id="likesCount">0</span>
                    <span class="stat-label">Likes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="commentsCount">0</span>
                    <span class="stat-label">Commentaires</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="averageRating">0.0</span>
                    <span class="stat-label">‚≠ê Note</span>
                </div>
            </div>
            
            <div class="engagement-buttons">
                <button class="btn-like" id="btnLike">
                    <span id="likeIcon">ü§ç</span>
                    <span id="likeText">J'aime</span>
                </button>
                <button class="btn-comments" onclick="scrollToComments()">
                    <span>üí¨</span>
                    <span>Commenter</span>
                </button>
            </div>
        </div>

        <!-- Section Commentaires -->
        <div class="comments-section" id="commentsSection">
            <h3 class="section-title">
                <span>üí¨</span>
                Commentaires
            </h3>
            
            <div class="comment-form">
                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 12px;">Donner votre avis</h4>
                <div class="rating-input">
                    <span style="font-size: 0.9rem; color: var(--text-secondary);">Note :</span>
                    <label>
                        <input type="radio" name="rating" value="5" checked>
                        <span>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                    </label>
                    <label>
                        <input type="radio" name="rating" value="4">
                        <span>‚≠ê‚≠ê‚≠ê‚≠ê</span>
                    </label>
                    <label>
                        <input type="radio" name="rating" value="3">
                        <span>‚≠ê‚≠ê‚≠ê</span>
                    </label>
                    <label>
                        <input type="radio" name="rating" value="2">
                        <span>‚≠ê‚≠ê</span>
                    </label>
                    <label>
                        <input type="radio" name="rating" value="1">
                        <span>‚≠ê</span>
                    </label>
                </div>
                <textarea id="commentInput" placeholder="Partagez votre exp√©rience avec ce produit..." rows="3"></textarea>
                <button class="btn-submit-comment" onclick="submitComment()">
                    Publier le commentaire
                </button>
            </div>

            <div class="comments-list" id="commentsList">
                <!-- Commentaires g√©n√©r√©s dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Boutons d'action -->
    <div class="action-buttons">
        <button class="btn-primary" id="btnAcheter">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 2L7.17 4M15 2l1.83 2M9 20c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm6 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
                <path d="M7.17 4H20l-2 9H9L7.17 4zm0 0L6 1"/>
            </svg>
            Acheter maintenant
        </button>

        <button class="btn-secondary" id="btnWhatsApp">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" fill="currentColor"/>
            </svg>
            Contacter sur WhatsApp
        </button>

        <button class="btn-boutique" id="btnBoutique">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            Voir ma boutique
        </button>
    </div>

    <!-- Modal Paiement -->
    <div class="payment-modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí≥ Choisir le paiement</h2>
                <button class="btn-close-modal" id="btnCloseModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="order-summary">
                    <div class="summary-item">
                        <span>Produit</span>
                        <span id="summaryProductName">-</span>
                    </div>
                    <div class="summary-item">
                        <span>Prix unitaire</span>
                        <span id="summaryPrice">-</span>
                    </div>
                    <div class="summary-total">
                        <span>Total</span>
                        <span id="summaryTotal" style="color: var(--primary-color);">-</span>
                    </div>
                </div>

                <h3 style="font-weight: 700; margin-bottom: 16px;">M√©thode de paiement</h3>
                <div class="payment-methods" id="paymentMethods">
                    <!-- Options g√©n√©r√©es dynamiquement -->
                </div>

                <button class="btn-primary" id="btnConfirmPayment" style="margin-top: 24px;">
                    Confirmer le paiement
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>


<script type="module">
    // ==================== PARTIE 1/5 : CONFIGURATION & √âTAT GLOBAL ====================

// Configuration Supabase
const SUPABASE_URL = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ==================== VARIABLES GLOBALES ====================
let currentProduct = null;
let currentUser = null;
let shopConfig = null;
let productLikes = { count: 0, userLiked: false };
let productComments = [];
let currentUserId = getUserId();
let currentImageIndex = 0;
let allImages = [];

// ==================== UTILITAIRES ====================
function getUserId() {
    let userId = localStorage.getItem('oda_user_id');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('oda_user_id', userId);
    }
    return userId;
}

function getUserName() {
    let userName = localStorage.getItem('oda_user_name');
    if (!userName) {
        userName = prompt('Entrez votre nom pour commenter:') || 'Anonyme';
        localStorage.setItem('oda_user_name', userName);
    }
    return userName;
}

function formatPrice(price, devise = 'FCFA') {
    return `${price.toLocaleString('fr-FR')} ${devise}`;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Aujourd\'hui';
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return `Il y a ${diffDays} jours`;
    if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaines`;
    return date.toLocaleDateString('fr-FR');
}

function afficherNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');
    const notificationIcon = document.getElementById('notificationIcon');
    
    if (!notification || !notificationText || !notificationIcon) return;
    
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    notificationIcon.textContent = icons[type] || icons.info;
    notificationText.textContent = message;
    notification.className = `notification show ${type}`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// ==================== CHARGEMENT PRODUIT ====================
async function chargerProduit() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');
        
        if (!productId) {
            throw new Error('ID produit manquant');
        }
        
        console.log('üì¶ Chargement du produit:', productId);
        
        const { data: product, error: productError } = await supabase
            .from('produits')
            .select('*')
            .eq('id', productId)
            .single();
        
        if (productError) throw productError;
        if (!product) throw new Error('Produit non trouv√©');
        
        currentProduct = product;
        console.log('‚úÖ Produit charg√©:', product);
        
        await chargerConfigurationBoutique(product.user_id);
        
        await Promise.all([
            chargerLikes(productId),
            chargerCommentaires(productId)
        ]);
        
        afficherProduit();
        
        document.getElementById('loader').style.display = 'none';
        
    } catch (error) {
        console.error('‚ùå Erreur chargement produit:', error);
        afficherNotification('Erreur lors du chargement du produit', 'error');
        
        setTimeout(() => {
            window.location.href = 'oda-achats.html';
        }, 2000);
    }
}

// ==================== CHARGEMENT CONFIGURATION BOUTIQUE ====================
async function chargerConfigurationBoutique(userId) {
    try {
        console.log(`üîç Chargement config boutique pour user: ${userId}`);
        
        const { data, error } = await supabase
            .from('parametres_boutique')
            .select('config')
            .eq('user_id', userId)
            .single();
        
        if (data && !error) {
            shopConfig = data.config;
            console.log('‚úÖ Configuration boutique charg√©e');
            console.log('üè™ Nom boutique:', shopConfig?.general?.nom);
            console.log('üîó Slug boutique:', shopConfig?.identifiant?.slug);
            appliquerConfigurationBoutique();
        } else {
            console.warn('‚ö†Ô∏è Config boutique non trouv√©e, utilisation config par d√©faut');
            shopConfig = getDefaultShopConfig();
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement config boutique:', error);
        shopConfig = getDefaultShopConfig();
    }
}

function getDefaultShopConfig() {
    return {
        general: {
            nom: 'Ma Boutique',
            telephone: '',
            email: ''
        },
        apparence: {
            couleurPrimaire: '#FF6B00',
            couleurSecondaire: '#1A1A1A'
        },
        paiement: {
            devise: 'FCFA',
            carte: { actif: false },
            mobile: { actif: true },
            cash: { actif: true }
        },
        identifiant: {
            slug: ''
        }
    };
}

function appliquerConfigurationBoutique() {
    if (!shopConfig) return;
    
    const { couleurPrimaire, couleurSecondaire } = shopConfig.apparence || {};
    
    if (couleurPrimaire) {
        document.documentElement.style.setProperty('--primary-color', couleurPrimaire);
        document.documentElement.style.setProperty('--primary-dark', couleurPrimaire + 'dd');
    }
    
    if (couleurSecondaire) {
        document.documentElement.style.setProperty('--text-primary', couleurSecondaire);
    }
    
    console.log('üé® Configuration boutique appliqu√©e');
}

// ==================== CHARGEMENT LIKES ====================
async function chargerLikes(productId) {
    try {
        const { data: likes, error } = await supabase
            .from('product_likes')
            .select('user_id')
            .eq('product_id', productId);
        
        if (error) throw error;
        
        productLikes = {
            count: likes.length,
            userLiked: likes.some(like => like.user_id === currentUserId)
        };
        
        console.log(`üëç ${productLikes.count} likes charg√©s`);
    } catch (error) {
        console.error('Erreur chargement likes:', error);
        productLikes = { count: 0, userLiked: false };
    }
}

// ==================== CHARGEMENT COMMENTAIRES ====================
async function chargerCommentaires(productId) {
    try {
        const { data: comments, error } = await supabase
            .from('product_comments')
            .select('*')
            .eq('product_id', productId)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        productComments = comments || [];
        console.log(`üí¨ ${productComments.length} commentaires charg√©s`);
    } catch (error) {
        console.error('Erreur chargement commentaires:', error);
        productComments = [];
    }
}

// Export des fonctions pour les autres parties
window.chargerProduit = chargerProduit;
window.chargerConfigurationBoutique = chargerConfigurationBoutique;
window.chargerLikes = chargerLikes;
window.chargerCommentaires = chargerCommentaires;
window.afficherNotification = afficherNotification;
window.formatPrice = formatPrice;
window.formatDate = formatDate;
window.getUserName = getUserName;
// ==================== PARTIE 2/5 : AFFICHAGE PRODUIT & CARROUSEL CORRIG√â ====================

// ==================== AFFICHAGE PRODUIT ====================
function afficherProduit() {
    if (!currentProduct) return;
    
    const devise = shopConfig?.paiement?.devise || 'FCFA';
    
    document.title = `${currentProduct.nom} - ODA Marketplace`;
    document.getElementById('headerTitle').textContent = currentProduct.nom;
    
    document.getElementById('productName').textContent = currentProduct.nom;
    document.getElementById('productCategory').textContent = `üì¶ ${currentProduct.categorie || 'Produit'}`;
    document.getElementById('productPrice').textContent = formatPrice(currentProduct.prix, devise);
    document.getElementById('productDescription').textContent = currentProduct.description || 'Aucune description disponible.';
    
    afficherStock();
    initialiserCarousel();
    afficherEngagement();
    afficherCommentaires();
    mettreAJourBoutonBoutique();
    
    console.log('‚úÖ Produit affich√©');
}

// ==================== METTRE √Ä JOUR BOUTON BOUTIQUE ====================
function mettreAJourBoutonBoutique() {
    const btnBoutique = document.getElementById('btnBoutique');
    if (!btnBoutique) return;
    
    const nomBoutique = shopConfig?.general?.nom || 'la boutique';
    btnBoutique.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        Voir ${nomBoutique}
    `;
    
    console.log(`üè™ Bouton boutique mis √† jour: ${nomBoutique}`);
}

// ==================== AFFICHAGE STOCK ====================
function afficherStock() {
    const stock = currentProduct.stock || 0;
    const stockIcon = document.getElementById('stockIcon');
    const stockText = document.getElementById('stockText');
    const stockQuantity = document.getElementById('stockQuantity');
    
    if (stock > 10) {
        stockIcon.textContent = '‚úÖ';
        stockText.textContent = 'En stock';
        stockQuantity.textContent = `‚Ä¢ ${stock} disponibles`;
    } else if (stock > 0) {
        stockIcon.textContent = '‚ö†Ô∏è';
        stockText.textContent = 'Stock limit√©';
        stockQuantity.textContent = `‚Ä¢ Plus que ${stock} !`;
    } else {
        stockIcon.textContent = '‚ùå';
        stockText.textContent = 'Rupture de stock';
        stockQuantity.textContent = '';
    }
}

// ==================== CARROUSEL D'IMAGES OPTIMIS√â - CORRIG√â ‚úÖ ====================

function initialiserCarousel() {
    allImages = [];
    
    console.log('üñºÔ∏è ========== INITIALISATION CARROUSEL ==========');
    console.log('üìã Donn√©es produit:');
    console.log('  main_image:', currentProduct.main_image);
    console.log('  description_images:', currentProduct.description_images);
    console.log('  images:', currentProduct.images);
    
    const mainImageUrl = extraireImagePrincipale();
    const imagesSupplementaires = extraireImagesSupplementaires();
    
    construireTableauImages(mainImageUrl, imagesSupplementaires);
    dedupliquerImagesAvecPriorite(); // ‚úÖ CORRIG√â : Nouvelle fonction qui pr√©serve l'image principale
    ajouterFallbackSiVide();
    afficherCarousel();
    afficherStatistiques();
}

function extraireImagePrincipale() {
    if (!currentProduct.main_image) {
        console.warn('‚ö†Ô∏è Pas de main_image d√©finie');
        return null;
    }
    
    const mainImg = String(currentProduct.main_image).trim();
    
    if (!mainImg || mainImg === '' || mainImg === 'null' || mainImg === 'undefined') {
        console.warn('‚ö†Ô∏è main_image invalide:', mainImg);
        return null;
    }
    
    if (mainImg.startsWith('http') || mainImg.startsWith('/') || mainImg.startsWith('data:')) {
        console.log('‚úÖ Image principale d√©tect√©e:', mainImg.substring(0, 80) + '...');
        return mainImg;
    }
    
    console.warn('‚ö†Ô∏è main_image ne ressemble pas √† une URL:', mainImg.substring(0, 50));
    return null;
}

function extraireImagesSupplementaires() {
    const sources = [
        { nom: 'description_images', data: currentProduct.description_images },
        { nom: 'images', data: currentProduct.images }
    ];
    
    let toutesLesImages = [];
    
    sources.forEach(source => {
        if (!source.data) return;
        
        console.log(`üîç Traitement de "${source.nom}":`, typeof source.data);
        
        const images = parseImages(source.data, source.nom);
        
        if (images.length > 0) {
            console.log(`  ‚úÖ ${images.length} image(s) trouv√©e(s) dans ${source.nom}`);
            toutesLesImages.push(...images);
        }
    });
    
    return toutesLesImages;
}

function parseImages(data, sourceName) {
    if (Array.isArray(data)) {
        console.log(`  üì¶ ${sourceName}: Tableau direct`);
        return filtrerURLsValides(data);
    }
    
    if (typeof data === 'string') {
        const trimmed = data.trim();
        
        if (!trimmed || trimmed === 'null' || trimmed === 'undefined') {
            return [];
        }
        
        if (trimmed.startsWith('[')) {
            console.log(`  üì¶ ${sourceName}: JSON array`);
            return parseJSONArray(trimmed, sourceName);
        }
        
        if (trimmed.startsWith('{')) {
            console.log(`  üì¶ ${sourceName}: JSON object`);
            return parseJSONObject(trimmed, sourceName);
        }
        
        if (estURLValide(trimmed)) {
            console.log(`  üì¶ ${sourceName}: URL unique`);
            return [trimmed];
        }
        
        if (trimmed.includes(',')) {
            console.log(`  üì¶ ${sourceName}: URLs s√©par√©es par virgules`);
            return trimmed.split(',')
                .map(url => url.trim())
                .filter(estURLValide);
        }
        
        console.warn(`  ‚ö†Ô∏è ${sourceName}: Format non reconnu`);
        return [];
    }
    
    if (typeof data === 'object' && data !== null) {
        console.log(`  üì¶ ${sourceName}: Objet`);
        return Object.values(data)
            .filter(v => typeof v === 'string')
            .filter(estURLValide);
    }
    
    return [];
}

function parseJSONArray(jsonString, sourceName) {
    try {
        let parsed = JSON.parse(jsonString);
        
        if (typeof parsed === 'string') {
            try {
                parsed = JSON.parse(parsed);
            } catch (e) {
                console.warn(`  ‚ö†Ô∏è Double parsing √©chou√© pour ${sourceName}`);
            }
        }
        
        if (Array.isArray(parsed)) {
            return filtrerURLsValides(parsed);
        }
        
        console.warn(`  ‚ö†Ô∏è ${sourceName}: Parse JSON OK mais pas un array`);
        return [];
        
    } catch (error) {
        console.error(`  ‚ùå ${sourceName}: Erreur parse JSON:`, error.message);
        return [];
    }
}

function parseJSONObject(jsonString, sourceName) {
    try {
        const parsed = JSON.parse(jsonString);
        
        if (typeof parsed === 'object' && parsed !== null) {
            return Object.values(parsed)
                .filter(v => typeof v === 'string')
                .filter(estURLValide);
        }
        
        return [];
        
    } catch (error) {
        console.error(`  ‚ùå ${sourceName}: Erreur parse object:`, error.message);
        return [];
    }
}

function filtrerURLsValides(array) {
    return array
        .filter(item => item && typeof item === 'string')
        .map(item => item.trim())
        .filter(item => item !== '' && item !== 'null' && item !== 'undefined')
        .filter(estURLValide);
}

function estURLValide(str) {
    if (!str || typeof str !== 'string') return false;
    const trimmed = str.trim();
    return trimmed.startsWith('http') || 
           trimmed.startsWith('/') || 
           trimmed.startsWith('data:');
}

function construireTableauImages(mainImageUrl, imagesSupplementaires) {
    allImages = [];
    
    if (mainImageUrl) {
        allImages.push(mainImageUrl);
        console.log('üéØ Image principale ajout√©e en position 1');
        console.log(`   URL: ${mainImageUrl.substring(0, 80)}...`);
        
        // ‚úÖ CORRIG√â : Retirer la principale des suppl√©mentaires AVANT de les ajouter
        imagesSupplementaires = imagesSupplementaires.filter(img => img !== mainImageUrl);
        console.log(`   ‚úÖ Image principale retir√©e des suppl√©mentaires (${imagesSupplementaires.length} restantes)`);
    } else {
        console.warn('‚ö†Ô∏è Aucune image principale, utilisation images suppl√©mentaires');
    }
    
    imagesSupplementaires.forEach((img, index) => {
        allImages.push(img);
        console.log(`  ‚úÖ [${allImages.length}] Image suppl√©mentaire ajout√©e`);
    });
    
    console.log(`üìä Total avant d√©duplication: ${allImages.length} images`);
}

// ‚úÖ CORRIG√â : Nouvelle fonction qui pr√©serve toujours l'image principale en position 1
function dedupliquerImagesAvecPriorite() {
    if (allImages.length === 0) return;
    
    const imagePrincipale = allImages[0]; // Sauvegarder l'image principale
    const autresImages = allImages.slice(1); // Les autres images
    
    // D√©dupliquer les autres images (sans toucher √† la principale)
    const autresImagesDedupliquees = [...new Set(autresImages)];
    
    // Retirer l'image principale des autres si elle appara√Æt (s√©curit√© suppl√©mentaire)
    const autresImagesSansPrincipale = autresImagesDedupliquees.filter(
        img => img !== imagePrincipale
    );
    
    // Reconstruire le tableau : principale + autres
    const avant = allImages.length;
    allImages = [imagePrincipale, ...autresImagesSansPrincipale];
    const apres = allImages.length;
    
    if (avant !== apres) {
        console.log(`üîÑ D√©duplication avec priorit√©: ${avant} ‚Üí ${apres} images`);
    }
    console.log(`   ‚úÖ Image principale pr√©serv√©e en position 1`);
}

function ajouterFallbackSiVide() {
    if (allImages.length === 0) {
        console.warn('‚ö†Ô∏è Aucune image valide, ajout placeholder');
        allImages.push('https://via.placeholder.com/600x600?text=Produit');
    }
}

function afficherCarousel() {
    currentImageIndex = 0; // ‚úÖ TOUJOURS commencer √† 0 (image principale)
    afficherImageCourante();
    genererThumbnails();
    ajouterGestionZoom();
    
    console.log('üéØ Carrousel initialis√© - Image principale affich√©e');
}

function afficherImageCourante() {
    const mainImage = document.getElementById('mainImage');
    const imageCounter = document.getElementById('imageCounter');
    
    if (!mainImage || allImages.length === 0) return;
    
    const currentUrl = allImages[currentImageIndex];
    
    console.log(`üñºÔ∏è Affichage image ${currentImageIndex + 1}/${allImages.length}`);
    if (currentImageIndex === 0) {
        console.log('  üéØ ‚úÖ IMAGE PRINCIPALE AFFICH√âE');
    }
    
    // ‚úÖ MISE √Ä JOUR IMM√âDIATE DU COMPTEUR
    if (imageCounter) {
        imageCounter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
        imageCounter.style.display = allImages.length > 1 ? 'block' : 'none';
    }
    
    const preloadImg = new Image();
    preloadImg.onload = () => {
        mainImage.src = currentUrl;
        console.log('  ‚úÖ Image charg√©e avec succ√®s');
    };
    preloadImg.onerror = () => {
        console.error('  ‚ùå Erreur chargement:', currentUrl.substring(0, 100));
        mainImage.src = 'https://via.placeholder.com/600x600?text=Image+non+disponible';
    };
    preloadImg.src = currentUrl;
}

function genererThumbnails() {
    const container = document.getElementById('thumbnailsContainer');
    if (!container) return;
    
    if (allImages.length <= 1) {
        container.style.display = 'none';
        console.log('üì∏ Une seule image, masquage miniatures');
        return;
    }
    
    container.style.display = 'flex';
    
    container.innerHTML = allImages.map((img, index) => `
        <img src="${img}" 
             class="thumbnail ${index === 0 ? 'active' : ''}" 
             onclick="changerImage(${index})"
             alt="Miniature ${index + 1}${index === 0 ? ' (üéØ Principale)' : ''}"
             title="${index === 0 ? 'üéØ Image principale' : `Image ${index + 1}`}"
             loading="lazy"
             onerror="this.src='https://via.placeholder.com/70x70?text=${index + 1}'"
             data-index="${index}"
             ${index === 0 ? 'style="border-color: var(--primary-color); box-shadow: 0 0 8px rgba(255,107,0,0.5);"' : ''}>
    `).join('');
    
    console.log(`‚úÖ ${allImages.length} miniatures g√©n√©r√©es (premi√®re = üéØ principale)`);
}

window.changerImage = function(index) {
    if (index < 0 || index >= allImages.length) {
        console.warn(`‚ö†Ô∏è Index invalide: ${index}`);
        return;
    }
    
    currentImageIndex = index;
    afficherImageCourante();
    
    document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
        
        // ‚úÖ Mise en valeur de la principale
        if (i === 0) {
            thumb.style.borderColor = 'var(--primary-color)';
            thumb.style.boxShadow = '0 0 8px rgba(255,107,0,0.5)';
        } else if (i === index && i !== 0) {
            thumb.style.borderColor = 'var(--primary-color)';
            thumb.style.boxShadow = 'none';
        } else {
            thumb.style.borderColor = 'transparent';
            thumb.style.boxShadow = 'none';
        }
    });
    
    console.log(`üìç Image ${index + 1}/${allImages.length} s√©lectionn√©e${index === 0 ? ' (üéØ Principale)' : ''}`);
};

function ajouterGestionZoom() {
    const mainImageWrapper = document.getElementById('mainImageWrapper');
    const mainImage = document.getElementById('mainImage');
    
    if (!mainImageWrapper || !mainImage) return;
    
    const newWrapper = mainImageWrapper.cloneNode(true);
    mainImageWrapper.parentNode.replaceChild(newWrapper, mainImageWrapper);
    
    document.getElementById('mainImageWrapper').addEventListener('click', () => {
        document.getElementById('mainImage').classList.toggle('zoom');
    });
}

function afficherStatistiques() {
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log(`üì∏ R√âSULTAT: ${allImages.length} image(s) dans le carrousel`);
    console.log('   Ordre des images:');
    
    allImages.forEach((img, i) => {
        const isMain = i === 0;
        const prefix = isMain ? 'üéØ [PRINCIPALE]' : `   [${i + 1}]`;
        const preview = img.length > 80 ? img.substring(0, 80) + '...' : img;
        console.log(`${prefix} ${preview}`);
    });
    
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
}

// ‚úÖ FONCTION DE V√âRIFICATION POUR DEBUG
window.verifierImagePrincipale = function() {
    console.log('üîç V√âRIFICATION IMAGE PRINCIPALE');
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log(`üìä √âtat actuel :`);
    console.log(`   - Total images : ${allImages.length}`);
    console.log(`   - Index actuel : ${currentImageIndex}`);
    console.log(`   - Image affich√©e : ${currentImageIndex === 0 ? 'üéØ PRINCIPALE' : `Suppl√©mentaire #${currentImageIndex + 1}`}`);
    console.log('');
    console.log('üìã Donn√©es produit :');
    console.log(`   - main_image : ${currentProduct?.main_image?.substring(0, 80)}...`);
    console.log('');
    console.log('üñºÔ∏è Premi√®re image du carrousel :');
    console.log(`   ${allImages[0]?.substring(0, 80)}...`);
    console.log('');
    console.log(`‚úÖ Correspondance : ${currentProduct?.main_image === allImages[0] ? 'OUI ‚úì' : 'NON ‚úó'}`);
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
    
    return currentProduct?.main_image === allImages[0];
};

// Export des fonctions
window.afficherProduit = afficherProduit;
window.initialiserCarousel = initialiserCarousel;
window.afficherImageCourante = afficherImageCourante;
window.genererThumbnails = genererThumbnails;
window.dedupliquerImagesAvecPriorite = dedupliquerImagesAvecPriorite;
// ==================== PARTIE 3/5 : ENGAGEMENT & COMMENTAIRES ====================

// ==================== AFFICHAGE ENGAGEMENT ====================
function afficherEngagement() {
    document.getElementById('likesCount').textContent = productLikes.count;
    
    const btnLike = document.getElementById('btnLike');
    const likeIcon = document.getElementById('likeIcon');
    const likeText = document.getElementById('likeText');
    
    if (productLikes.userLiked) {
        btnLike.classList.add('liked');
        likeIcon.textContent = '‚ù§Ô∏è';
        likeText.textContent = 'Aim√©';
    } else {
        btnLike.classList.remove('liked');
        likeIcon.textContent = 'ü§ç';
        likeText.textContent = 'J\'aime';
    }
    
    document.getElementById('commentsCount').textContent = productComments.length;
    
    const averageRating = calculerNoteMoyenne();
    document.getElementById('averageRating').textContent = averageRating;
}

function calculerNoteMoyenne() {
    if (productComments.length === 0) return '0.0';
    
    const sum = productComments.reduce((acc, comment) => acc + (comment.rating || 0), 0);
    return (sum / productComments.length).toFixed(1);
}

// ==================== TOGGLE LIKE ====================
async function toggleLike() {
    if (!currentProduct) return;
    
    const btnLike = document.getElementById('btnLike');
    btnLike.disabled = true;
    
    try {
        if (productLikes.userLiked) {
            const { error } = await supabase
                .from('product_likes')
                .delete()
                .eq('product_id', currentProduct.id)
                .eq('user_id', currentUserId);
            
            if (error) throw error;
            
            productLikes.count = Math.max(0, productLikes.count - 1);
            productLikes.userLiked = false;
            afficherNotification('Like retir√©', 'info');
        } else {
            const { error } = await supabase
                .from('product_likes')
                .insert({
                    product_id: currentProduct.id,
                    user_id: currentUserId
                });
            
            if (error) throw error;
            
            productLikes.count++;
            productLikes.userLiked = true;
            afficherNotification('Produit lik√© !', 'success');
        }
        
        afficherEngagement();
    } catch (error) {
        console.error('Erreur toggle like:', error);
        afficherNotification('Erreur lors du like', 'error');
    } finally {
        btnLike.disabled = false;
    }
}

// ==================== AFFICHAGE COMMENTAIRES ====================
function afficherCommentaires() {
    const commentsList = document.getElementById('commentsList');
    
    if (!commentsList) return;
    
    if (productComments.length === 0) {
        commentsList.innerHTML = `
            <div class="empty-comments">
                <p style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">
                    Aucun commentaire pour l'instant
                </p>
                <p>Soyez le premier √† donner votre avis !</p>
            </div>
        `;
        return;
    }
    
    commentsList.innerHTML = productComments.map(comment => `
        <div class="comment-item">
            <div class="comment-header">
                <div class="comment-user">
                    <div class="user-avatar">${comment.user_name.charAt(0).toUpperCase()}</div>
                    <span class="user-name">${comment.user_name}</span>
                </div>
                <div class="comment-rating">${'‚≠ê'.repeat(comment.rating || 5)}</div>
            </div>
            <p class="comment-text">${comment.comment}</p>
            <span class="comment-date">${formatDate(comment.created_at)}</span>
        </div>
    `).join('');
}

// ==================== SOUMETTRE COMMENTAIRE ====================
async function submitComment() {
    const commentInput = document.getElementById('commentInput');
    const ratingInput = document.querySelector('input[name="rating"]:checked');
    
    if (!commentInput || !ratingInput) return;
    
    const comment = commentInput.value.trim();
    const rating = parseInt(ratingInput.value);
    
    if (!comment) {
        afficherNotification('Le commentaire ne peut pas √™tre vide', 'error');
        return;
    }
    
    if (!currentProduct) return;
    
    const userName = getUserName();
    
    try {
        const { data, error } = await supabase
            .from('product_comments')
            .insert({
                product_id: currentProduct.id,
                user_id: currentUserId,
                user_name: userName,
                comment: comment,
                rating: rating
            })
            .select()
            .single();
        
        if (error) throw error;
        
        productComments.unshift(data);
        
        commentInput.value = '';
        document.querySelector('input[name="rating"][value="5"]').checked = true;
        
        afficherCommentaires();
        afficherEngagement();
        
        afficherNotification('Commentaire ajout√© !', 'success');
    } catch (error) {
        console.error('Erreur ajout commentaire:', error);
        afficherNotification('Erreur lors de l\'ajout du commentaire', 'error');
    }
}

window.scrollToComments = function() {
    const commentsSection = document.getElementById('commentsSection');
    if (commentsSection) {
        commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};

// ==================== INITIALISER BOUTONS D'ACTION ====================
function initialiserBoutonsAction() {
    const btnBack = document.getElementById('btnBack');
    if (btnBack) {
        btnBack.addEventListener('click', () => {
            window.history.back();
        });
    }
    
    const btnShare = document.getElementById('btnShare');
    if (btnShare) {
        btnShare.addEventListener('click', partagerProduit);
    }
    
    const btnLike = document.getElementById('btnLike');
    if (btnLike) {
        btnLike.addEventListener('click', toggleLike);
    }
    
    const btnAcheter = document.getElementById('btnAcheter');
    if (btnAcheter) {
        btnAcheter.addEventListener('click', ouvrirModalPaiement);
    }
    
    const btnWhatsApp = document.getElementById('btnWhatsApp');
    if (btnWhatsApp) {
        btnWhatsApp.addEventListener('click', contacterWhatsApp);
    }
    
    const btnBoutique = document.getElementById('btnBoutique');
    if (btnBoutique) {
        btnBoutique.addEventListener('click', allerBoutique);
    }
    
    console.log('‚úÖ Boutons d\'action initialis√©s');
}

// ==================== PARTAGER PRODUIT ====================
async function partagerProduit() {
    if (!currentProduct) return;
    
    const url = window.location.href;
    const text = `D√©couvrez ${currentProduct.nom} sur ODA Marketplace`;
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: currentProduct.nom,
                text: text,
                url: url
            });
            console.log('‚úÖ Partage r√©ussi');
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Erreur partage:', error);
            }
        }
    } else {
        try {
            await navigator.clipboard.writeText(url);
            afficherNotification('Lien copi√© dans le presse-papiers !', 'success');
        } catch (error) {
            afficherNotification('Impossible de copier le lien', 'error');
        }
    }
}

// ==================== CONTACTER SUR WHATSAPP ====================
function contacterWhatsApp() {
    if (!currentProduct) return;
    
    const telephone = shopConfig?.general?.telephone || '';
    
    if (!telephone) {
        afficherNotification('Num√©ro WhatsApp non disponible', 'error');
        return;
    }
    
    const phoneNumber = telephone.replace(/\D/g, '');
    
    const message = encodeURIComponent(
        `Bonjour, je suis int√©ress√©(e) par ce produit :\n\n` +
        `üì¶ ${currentProduct.nom}\n` +
        `üí∞ ${formatPrice(currentProduct.prix, shopConfig?.paiement?.devise || 'FCFA')}\n\n` +
        `Lien : ${window.location.href}`
    );
    
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
    window.open(whatsappUrl, '_blank');
    
    console.log('üì± WhatsApp ouvert');
}

// ==================== ALLER √Ä LA BOUTIQUE ====================
async function allerBoutique() {
    if (!currentProduct) {
        afficherNotification('Impossible de charger la boutique', 'error');
        return;
    }
    
    try {
        console.log('üè™ Redirection vers la boutique...');
        console.log('User ID du vendeur:', currentProduct.user_id);
        
        let slug = null;
        
        if (shopConfig?.identifiant?.slug) {
            slug = shopConfig.identifiant.slug;
            console.log('‚úÖ Slug trouv√© dans shopConfig:', slug);
        }
        
        if (!slug) {
            console.log('üîç Recherche du slug dans Supabase...');
            
            const { data, error } = await supabase
                .from('parametres_boutique')
                .select('config')
                .eq('user_id', currentProduct.user_id)
                .single();
            
            if (data && !error && data.config?.identifiant?.slug) {
                slug = data.config.identifiant.slug;
                console.log('‚úÖ Slug trouv√© dans Supabase:', slug);
            } else if (data && !error && data.config?.slug) {
                slug = data.config.slug;
                console.log('‚úÖ Slug trouv√© (ancienne structure):', slug);
            } else {
                console.warn('‚ö†Ô∏è Aucun slug trouv√© dans Supabase');
            }
        }
        
        if (!slug) {
            console.log('‚ö†Ô∏è Aucun slug trouv√©, utilisation du user_id comme fallback');
            slug = currentProduct.user_id;
        }
        
        const urlBoutique = `${window.location.origin}/boutique.html?shop=${slug}`;
        console.log('üîó URL de redirection:', urlBoutique);
        
        afficherNotification('Redirection vers la boutique...', 'info');
        
        setTimeout(() => {
            window.location.href = urlBoutique;
        }, 500);
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la redirection vers la boutique:', error);
        afficherNotification('Erreur lors de l\'acc√®s √† la boutique', 'error');
    }
}

// ==================== MODAL PAIEMENT ====================
async function ouvrirModalPaiement() {
    if (!currentProduct) return;
    
    if (currentProduct.stock <= 0) {
        afficherNotification('Ce produit n\'est plus en stock', 'error');
        return;
    }
    
    const modal = document.getElementById('paymentModal');
    const devise = shopConfig?.paiement?.devise || 'FCFA';
    
    await chargerParametresLivraison();
    mettreAJourResumePaiement(devise);
    genererOptionsPaiement();
    
    if (modal) {
        modal.classList.add('active');
        console.log('üí≥ Modal paiement ouverte');
    }
}

function mettreAJourResumePaiement(devise) {
    const fraisLivraison = calculerFraisLivraison();
    const total = calculerTotalAvecLivraison();
    
    const orderSummary = document.querySelector('.order-summary');
    if (orderSummary) {
        orderSummary.innerHTML = `
            <div class="summary-item">
                <span>Produit</span>
                <span>${currentProduct.nom}</span>
            </div>
            <div class="summary-item">
                <span>Prix unitaire</span>
                <span>${formatPrice(currentProduct.prix, devise)}</span>
            </div>
            <div class="summary-item">
                <span>Frais de livraison</span>
                <span style="color: ${fraisLivraison === 0 ? 'var(--success-color)' : 'var(--text-primary)'}">
                    ${fraisLivraison === 0 ? 'GRATUIT üéÅ' : formatPrice(fraisLivraison, devise)}
                </span>
            </div>
            ${fraisLivraison === 0 ? `
                <div class="summary-item" style="color: var(--success-color); font-size: 0.85rem;">
                    <span colspan="2">‚ú® Livraison gratuite activ√©e !</span>
                </div>
            ` : ''}
            <div class="summary-total">
                <span>Total</span>
                <span style="color: var(--primary-color);">${formatPrice(total, devise)}</span>
            </div>
        `;
    }
}

function fermerModalPaiement() {
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

async function chargerParametresLivraison() {
    try {
        if (shopConfig?.livraison) {
            window.parametresLivraison = shopConfig.livraison;
            console.log('üì¶ Param√®tres livraison depuis shopConfig');
            return;
        }
        
        const { data, error } = await supabase
            .from('parametres_boutique')
            .select('config')
            .eq('user_id', currentProduct.user_id)
            .single();
        
        if (data && !error) {
            window.parametresLivraison = data.config.livraison || getDefaultLivraisonConfig();
            console.log('üì¶ Param√®tres livraison depuis Supabase');
        } else {
            window.parametresLivraison = getDefaultLivraisonConfig();
            console.log('üì¶ Param√®tres livraison par d√©faut');
        }
    } catch (error) {
        console.error('Erreur chargement param√®tres livraison:', error);
        window.parametresLivraison = getDefaultLivraisonConfig();
    }
}

function getDefaultLivraisonConfig() {
    return {
        fraisDouala: 1000,
        fraisAutres: 2500,
        delai: '2-5 jours',
        gratuit: false,
        montantMin: 50000,
        zonesPersonnalisees: []
    };
}

function calculerTotalAvecLivraison() {
    if (!currentProduct) return 0;
    
    const prixProduit = currentProduct.prix;
    const livraison = window.parametresLivraison || getDefaultLivraisonConfig();
    
    if (livraison.gratuit && prixProduit >= livraison.montantMin) {
        console.log('üéÅ Livraison gratuite appliqu√©e');
        return prixProduit;
    }
    
    const fraisLivraison = livraison.fraisDouala || 1000;
    const total = prixProduit + fraisLivraison;
    
    console.log(`üì¶ Total: ${prixProduit} + ${fraisLivraison} = ${total}`);
    return total;
}

function calculerFraisLivraison() {
    const livraison = window.parametresLivraison || getDefaultLivraisonConfig();
    const prixProduit = currentProduct?.prix || 0;
    
    if (livraison.gratuit && prixProduit >= livraison.montantMin) {
        return 0;
    }
    
    return livraison.fraisDouala || 1000;
}

function genererOptionsPaiement() {
    const container = document.getElementById('paymentMethods');
    if (!container) return;
    
    const paiementConfig = shopConfig?.paiement || {};
    
    const options = [];
    
    if (paiementConfig.mobile?.actif) {
        options.push({
            id: 'mobile',
            icon: 'üì±',
            name: 'Mobile Money',
            desc: 'Orange Money, MTN MoMo'
        });
    }
    
    if (paiementConfig.carte?.actif) {
        options.push({
            id: 'carte',
            icon: 'üí≥',
            name: 'Carte bancaire',
            desc: 'Visa, Mastercard'
        });
    }
    
    if (paiementConfig.cash?.actif) {
        options.push({
            id: 'cash',
            icon: 'üíµ',
            name: '√Ä la livraison',
            desc: 'Paiement en esp√®ces'
        });
    }
    
    if (options.length === 0) {
        options.push(
            { id: 'mobile', icon: 'üì±', name: 'Mobile Money', desc: 'Orange Money, MTN MoMo' },
            { id: 'cash', icon: 'üíµ', name: '√Ä la livraison', desc: 'Paiement en esp√®ces' }
        );
    }
    
    container.innerHTML = options.map((option, index) => `
        <div class="payment-option ${index === 0 ? 'active' : ''}" 
             data-payment-id="${option.id}"
             onclick="selectionnerPaiement('${option.id}')">
            <div class="payment-icon">${option.icon}</div>
            <div class="payment-info">
                <div class="payment-name">${option.name}</div>
                <div class="payment-desc">${option.desc}</div>
            </div>
        </div>
    `).join('');
}

window.selectionnerPaiement = function(paymentId) {
    document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.toggle('active', option.dataset.paymentId === paymentId);
    });
};

async function confirmerPaiement() {
    const selectedPayment = document.querySelector('.payment-option.active');
    
    if (!selectedPayment) {
        afficherNotification('Veuillez s√©lectionner un mode de paiement', 'error');
        return;
    }
    
    const paymentId = selectedPayment.dataset.paymentId;
    
    const commandeData = {
        produit: {
            id: currentProduct.id,
            nom: currentProduct.nom,
            prix: currentProduct.prix,
            image: currentProduct.main_image,
            vendeur_id: currentProduct.user_id
        },
        paiement: {
            methode: paymentId,
            devise: shopConfig?.paiement?.devise || 'FCFA'
        },
        livraison: {
            frais: calculerFraisLivraison(),
            delai: window.parametresLivraison?.delai || '2-5 jours'
        },
        total: calculerTotalAvecLivraison(),
        boutique: {
            nom: shopConfig?.general?.nom || 'Boutique',
            slug: shopConfig?.identifiant?.slug,
            telephone: shopConfig?.general?.telephone,
            email: shopConfig?.general?.email
        },
        timestamp: new Date().toISOString()
    };
    
    sessionStorage.setItem('commande_en_cours', JSON.stringify(commandeData));
    
    console.log('üì¶ Commande pr√©par√©e:', commandeData);
    
    afficherNotification('Redirection vers le paiement...', 'info');
    
    setTimeout(() => {
        window.location.href = `payment.html?product=${currentProduct.id}&method=${paymentId}`;
    }, 500);
}

function initialiserModal() {
    const btnCloseModal = document.getElementById('btnCloseModal');
    const btnConfirmPayment = document.getElementById('btnConfirmPayment');
    const modal = document.getElementById('paymentModal');
    
    if (btnCloseModal) {
        btnCloseModal.addEventListener('click', fermerModalPaiement);
    }
    
    if (btnConfirmPayment) {
        btnConfirmPayment.addEventListener('click', confirmerPaiement);
    }
    
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                fermerModalPaiement();
            }
        });
    }
    
    console.log('‚úÖ Modal paiement initialis√©e');
}

// Export des fonctions
window.afficherEngagement = afficherEngagement;
window.toggleLike = toggleLike;
window.submitComment = submitComment;
window.afficherCommentaires = afficherCommentaires;
window.initialiserBoutonsAction = initialiserBoutonsAction;
window.initialiserModal = initialiserModal;
window.ouvrirModalPaiement = ouvrirModalPaiement;
window.fermerModalPaiement = fermerModalPaiement;
window.confirmerPaiement = confirmerPaiement;
window.partagerProduit = partagerProduit;
window.contacterWhatsApp = contacterWhatsApp;
window.allerBoutique = allerBoutique;
// ==================== PARTIE 4/5 : INITIALISATION COMPL√àTE & UTILITAIRES ====================

// ==================== INITIALISATION PRINCIPALE ====================
async function initialiserPageProduit() {
    try {
        console.log('üöÄ Initialisation de la page produit...');
        console.log('‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì');
        
        await chargerProduit();
        console.log('‚úÖ 1/4 - Produit charg√©');
        
        initialiserBoutonsAction();
        console.log('‚úÖ 2/4 - Boutons d\'action initialis√©s');
        
        initialiserModal();
        console.log('‚úÖ 3/4 - Modal paiement initialis√©e');
        
        initialiserEvenementsSupplementaires();
        console.log('‚úÖ 4/4 - √âv√©nements suppl√©mentaires initialis√©s');
        
        console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
        console.log('‚ú® Page produit compl√®tement initialis√©e !');
        console.log('üì¶ Produit:', currentProduct?.nom || 'Non charg√©');
        console.log('üè™ Boutique:', shopConfig?.general?.nom || 'Non configur√©e');
        console.log('üîó Slug boutique:', shopConfig?.identifiant?.slug || 'Non d√©fini');
        console.log('üñºÔ∏è Total images:', allImages.length);
        console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        afficherNotification('Erreur lors de l\'initialisation de la page', 'error');
    }
}

// ==================== √âV√âNEMENTS SUPPL√âMENTAIRES ====================
function initialiserEvenementsSupplementaires() {
    // Gestion du bouton Escape pour fermer la modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('paymentModal');
            if (modal && modal.classList.contains('active')) {
                fermerModalPaiement();
            }
        }
    });
    
    // Pr√©venir le zoom lors du double tap sur mobile
    let lastTap = 0;
    document.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        
        if (tapLength < 300 && tapLength > 0) {
            e.preventDefault();
        }
        
        lastTap = currentTime;
    });
    
    // Lazy loading des images
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        imageObserver.unobserve(img);
                    }
                }
            });
        });
        
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }
    
    console.log('‚úÖ √âv√©nements suppl√©mentaires initialis√©s');
}

// ==================== GESTION DES ERREURS GLOBALES ====================
window.addEventListener('error', (event) => {
    console.error('‚ùå Erreur globale:', event.error);
    
    if (event.target.tagName === 'IMG') {
        return;
    }
});

// ==================== GESTION DE LA NAVIGATION ====================
window.addEventListener('popstate', () => {
    const modal = document.getElementById('paymentModal');
    if (modal && modal.classList.contains('active')) {
        fermerModalPaiement();
        history.pushState(null, null, window.location.href);
    }
});

// ==================== ANALYTICS ====================
function enregistrerVueProduit() {
    if (!currentProduct) return;
    
    try {
        const vues = JSON.parse(localStorage.getItem('product_views') || '{}');
        const productId = currentProduct.id;
        
        if (!vues[productId]) {
            vues[productId] = {
                count: 0,
                firstView: new Date().toISOString(),
                lastView: new Date().toISOString()
            };
        }
        
        vues[productId].count++;
        vues[productId].lastView = new Date().toISOString();
        
        localStorage.setItem('product_views', JSON.stringify(vues));
        
        console.log(`üìä Vue enregistr√©e (${vues[productId].count} vues)`);
    } catch (error) {
        console.error('Erreur analytics:', error);
    }
}

// ==================== RAFRA√éCHISSEMENT AUTOMATIQUE ====================
let refreshInterval;

function demarrerRafraichissement() {
    refreshInterval = setInterval(async () => {
        if (currentProduct) {
            await Promise.all([
                chargerLikes(currentProduct.id),
                chargerCommentaires(currentProduct.id)
            ]);
            
            afficherEngagement();
            afficherCommentaires();
            
            console.log('üîÑ Donn√©es rafra√Æchies');
        }
    }, 30000);
}

function arreterRafraichissement() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

window.addEventListener('beforeunload', arreterRafraichissement);

// ==================== FONCTIONS DE DEBUG ====================
window.debugProduit = function() {
    console.log('üîç DEBUG PRODUIT');
    console.log('‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì');
    console.log('Produit actuel:', currentProduct);
    console.log('Configuration boutique:', shopConfig);
    console.log('Slug boutique:', shopConfig?.identifiant?.slug);
    console.log('Likes:', productLikes);
    console.log('Commentaires:', productComments.length);
    console.log('User ID:', currentUserId);
    console.log('Images totales:', allImages.length);
    console.log('Images:', allImages);
    console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
};

window.forceReload = async function() {
    console.log('üîÑ Rechargement forc√©...');
    await chargerProduit();
    afficherNotification('Donn√©es recharg√©es', 'success');
};

window.testBoutique = function() {
    console.log('üß™ TEST REDIRECTION BOUTIQUE');
    console.log('‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì');
    console.log('User ID vendeur:', currentProduct?.user_id);
    console.log('Slug dans shopConfig:', shopConfig?.identifiant?.slug);
    console.log('URL qui sera g√©n√©r√©e:', `${window.location.origin}/boutique.html?shop=${shopConfig?.identifiant?.slug || currentProduct?.user_id}`);
    console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
};

window.verifierCarrousel = function() {
    console.log('üîç V√âRIFICATION CARROUSEL');
    console.log('‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì');
    console.log('üìä Statistiques:');
    console.log('  - Total images:', allImages.length);
    console.log('  - Image actuelle:', currentImageIndex + 1);
    console.log('  - Image principale:', currentProduct?.main_image?.substring(0, 80));
    console.log('');
    console.log('üìã Liste compl√®te:');
    
    allImages.forEach((img, i) => {
        const isMain = i === 0;
        const isCurrent = i === currentImageIndex;
        const markers = [];
        if (isMain) markers.push('PRINCIPALE');
        if (isCurrent) markers.push('ACTUELLE');
        const label = markers.length > 0 ? ` [${markers.join(', ')}]` : '';
        console.log(`  ${i + 1}.${label} ${img.substring(0, 80)}`);
    });
    
    console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
};

window.rechargerCarrousel = function() {
    console.log('üîÑ Rechargement forc√© du carrousel...');
    initialiserCarousel();
    console.log('‚úÖ Carrousel recharg√©');
};

window.debugCompteur = function() {
    const imageCounter = document.getElementById('imageCounter');
    const mainImage = document.getElementById('mainImage');
    
    console.log('üîç DEBUG COMPTEUR D\'IMAGES');
    console.log('‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì');
    console.log('üìä √âtat actuel :');
    console.log(`  - Total images : ${allImages.length}`);
    console.log(`  - Index actuel : ${currentImageIndex}`);
    console.log(`  - Compteur existe : ${!!imageCounter}`);
    console.log(`  - Compteur texte : "${imageCounter?.textContent}"`);
    console.log(`  - Compteur visible : ${imageCounter?.style.display !== 'none'}`);
    console.log(`  - Image charg√©e : ${mainImage?.src?.substring(0, 80)}...`);
    console.log('‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ');
};

// ==================== D√âTECTION MODE PWA ====================
function detecterModePWA() {
    const isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                  window.navigator.standalone === true;
    
    if (isPWA) {
        console.log('üì± Application lanc√©e en mode PWA');
        document.body.classList.add('pwa-mode');
        
        const btnShare = document.getElementById('btnShare');
        if (btnShare && navigator.share) {
            btnShare.style.display = 'flex';
        }
    }
}

// ==================== V√âRIFIER COMPATIBILIT√â ====================
function verifierCompatibilite() {
    const features = {
        webShare: 'share' in navigator,
        clipboard: 'clipboard' in navigator,
        serviceWorker: 'serviceWorker' in navigator,
        localStorage: typeof Storage !== 'undefined'
    };
    
    console.log('üîç Fonctionnalit√©s disponibles:');
    Object.entries(features).forEach(([feature, available]) => {
        console.log(`  ${available ? '‚úÖ' : '‚ùå'} ${feature}`);
    });
    
    if (!features.localStorage) {
        console.warn('‚ö†Ô∏è localStorage non disponible, certaines fonctionnalit√©s seront limit√©es');
    }
}

// ==================== INITIALISATION AU CHARGEMENT DU DOM ====================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÑ DOM charg√©, d√©marrage de l\'initialisation...');
    
    verifierCompatibilite();
    detecterModePWA();
    
    await initialiserPageProduit();
    
    enregistrerVueProduit();
    demarrerRafraichissement();
});

// ==================== GESTION DU CYCLE DE VIE ====================
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        arreterRafraichissement();
        console.log('‚è∏Ô∏è Rafra√Æchissement en pause');
    } else {
        demarrerRafraichissement();
        console.log('‚ñ∂Ô∏è Rafra√Æchissement repris');
    }
});

// ==================== CONSOLE LOG STYLIS√â FINAL ====================
console.log('%cüõí PAGE PRODUIT CHARG√âE', 'color: #FF6B00; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);');
console.log('%c‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì', 'color: #FF6B00;');
console.log('%c‚ú® Tapez debugProduit() pour voir les d√©tails', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%cüîÑ Tapez forceReload() pour recharger', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%cüß™ Tapez testBoutique() pour tester la redirection', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%cüñºÔ∏è Tapez verifierCarrousel() pour voir les images', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%cüìä Tapez debugCompteur() pour voir le compteur', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%cüéØ Tapez verifierImagePrincipale() pour v√©rifier l\'image', 'color: #34C759; font-size: 12px; font-weight: 500;');
console.log('%c‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ', 'color: #FF6B00;');

// ==================== EXPORT FINAL ====================
window.initialiserPageProduit = initialiserPageProduit;
window.enregistrerVueProduit = enregistrerVueProduit;
window.demarrerRafraichissement = demarrerRafraichissement;
window.arreterRafraichissement = arreterRafraichissement;

console.log('üì¶ Tous les modules JavaScript charg√©s avec succ√®s');

</script>
</body>
</html>

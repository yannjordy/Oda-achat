<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B00">
    <title>D√©tails du Produit - ODA Marketplace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" type="image/png" href="oda.png">
    <style>
        /* ==================== VARIABLES CSS ==================== */
        :root {
            --primary-color: #FF6B00;
            --primary-dark: #E55D00;
            --secondary-color: #1A1A1A;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --error-color: #EF4444;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ==================== LOADER ==================== */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== HEADER ==================== */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-back, .btn-share {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-back:active, .btn-share:active {
            transform: scale(0.95);
            background: var(--border-color);
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
            padding: 0 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ==================== CARROUSEL VERTICAL ==================== */
        .carousel-container {
            margin-top: 72px;
            background: var(--bg-primary);
            padding-bottom: 20px;
        }

        .main-image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background: var(--bg-secondary);
            overflow: hidden;
            cursor: zoom-in;
        }

        .main-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .main-image.zoom {
            transform: scale(1.5);
            cursor: zoom-out;
        }

        .image-counter {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .thumbnails-container {
            display: flex;
            gap: 8px;
            padding: 16px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .thumbnails-container::-webkit-scrollbar {
            display: none;
        }

        .thumbnail {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: var(--radius-sm);
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .thumbnail.active {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* ==================== CONTENU PRODUIT ==================== */
        .product-content {
            padding: 20px 16px 120px;
        }

        .product-header {
            margin-bottom: 24px;
        }

        .product-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .product-category {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.1), rgba(255, 107, 0, 0.05));
            color: var(--primary-color);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .price-section {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            color: white;
        }

        .product-price {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .stock-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-weight: 600;
        }

        .description-section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .product-description {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        /* ==================== ENGAGEMENT ==================== */
        .engagement-section {
            background: var(--bg-primary);
            padding: 20px 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .engagement-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .engagement-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-like, .btn-comments {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-like:active, .btn-comments:active {
            transform: scale(0.95);
        }

        .btn-like.liked {
            background: #FFE5E5;
            border-color: var(--error-color);
            color: var(--error-color);
        }

        /* ==================== COMMENTAIRES ==================== */
        .comments-section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .comment-form {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .rating-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .rating-input input[type="radio"] {
            display: none;
        }

        .rating-input label {
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 1.5rem;
        }

        .rating-input label:hover {
            transform: scale(1.1);
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
            transition: border-color 0.3s ease;
        }

        .comment-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-submit-comment {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit-comment:hover {
            background: var(--primary-dark);
        }

        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .comment-rating {
            font-size: 0.9rem;
        }

        .comment-text {
            margin: 8px 0;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .comment-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .empty-comments {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* ==================== BOUTIQUE ==================== */
        .shop-section {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            color: white;
        }

        .shop-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .shop-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .shop-details h3 {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .shop-details p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .btn-visit-shop {
            width: 100%;
            padding: 14px;
            background: white;
            color: var(--primary-color);
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-visit-shop:active {
            transform: translateY(-2px);
        }

        /* ==================== BOUTONS D'ACTION ==================== */
        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            padding: 16px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .btn-primary, .btn-secondary {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }

        .btn-primary:active {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #25D366;
            color: white;
        }

        .btn-secondary:active {
            transform: translateY(-2px);
        }

        /* ==================== NOTIFICATION ==================== */
        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--error-color);
        }

        .notification.info {
            border-left: 4px solid var(--primary-color);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .product-name {
                font-size: 1.3rem;
            }

            .product-price {
                font-size: 1.7rem;
            }

            .stat-value {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader">
        <div class="loader-spinner"></div>
        <p style="margin-top: 16px; color: var(--text-secondary);">Chargement...</p>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationIcon"></span>
        <span id="notificationText"></span>
    </div>

    <!-- Header -->
    <header class="header">
        <button id="btnBack" class="btn-back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
        </button>
        <h1 id="headerTitle" class="header-title">Produit</h1>
        <button id="btnShare" class="btn-share">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
        </button>
    </header>

    <!-- Carrousel d'images -->
    <div class="carousel-container">
        <div id="mainImageWrapper" class="main-image-wrapper">
            <img id="mainImage" class="main-image" src="" alt="Produit">
            <div id="imageCounter" class="image-counter">1 / 1</div>
        </div>
        <div id="thumbnailsContainer" class="thumbnails-container"></div>
    </div>

    <!-- Contenu produit -->
    <div class="product-content">
        <!-- En-t√™te produit -->
        <div class="product-header">
            <h2 id="productName" class="product-name">Nom du produit</h2>
            <span id="productCategory" class="product-category">üì¶ Cat√©gorie</span>
        </div>

        <!-- Prix -->
        <div class="price-section">
            <div id="productPrice" class="product-price">0 FCFA</div>
            <div class="stock-info">
                <div class="stock-badge">
                    <span id="stockIcon">‚úÖ</span>
                    <span id="stockText">En stock</span>
                </div>
                <span id="stockQuantity"></span>
            </div>
        </div>

        <!-- Description -->
        <div class="description-section">
            <h3 class="section-title">üìù Description</h3>
            <p id="productDescription" class="product-description">Chargement...</p>
        </div>

        <!-- Engagement -->
        <div class="engagement-section">
            <div class="engagement-stats">
                <div class="stat-item">
                    <div id="likesCount" class="stat-value">0</div>
                    <div class="stat-label">J'aime</div>
                </div>
                <div class="stat-item">
                    <div id="commentsCount" class="stat-value">0</div>
                    <div class="stat-label">Commentaires</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">‚≠ê <span id="averageRating">0.0</span></div>
                    <div class="stat-label">Note</div>
                </div>
            </div>
            <div class="engagement-buttons">
                <button id="btnLike" class="btn-like">
                    <span id="likeIcon">ü§ç</span>
                    <span id="likeText">J'aime</span>
                </button>
                <button onclick="scrollToComments()" class="btn-comments">
                    <span>üí¨</span>
                    <span>Commenter</span>
                </button>
            </div>
        </div>

        <!-- Boutique -->
        <div id="shopSection" class="shop-section">
            <div class="shop-info">
                <div class="shop-icon">üè™</div>
                <div class="shop-details">
                    <h3 id="shopName">Ma Boutique</h3>
                    <p>Visitez la boutique pour plus de produits</p>
                </div>
            </div>
            <button id="btnBoutique" class="btn-visit-shop">
                üè™ Voir la boutique
            </button>
        </div>

        <!-- Commentaires -->
        <div id="commentsSection" class="comments-section">
            <h3 class="section-title">üí¨ Commentaires</h3>
            
            <!-- Formulaire -->
            <div class="comment-form">
                <div class="rating-input">
                    <span>Note :</span>
                    <input type="radio" name="rating" value="1" id="star1">
                    <label for="star1">‚≠ê</label>
                    <input type="radio" name="rating" value="2" id="star2">
                    <label for="star2">‚≠ê</label>
                    <input type="radio" name="rating" value="3" id="star3">
                    <label for="star3">‚≠ê</label>
                    <input type="radio" name="rating" value="4" id="star4">
                    <label for="star4">‚≠ê</label>
                    <input type="radio" name="rating" value="5" id="star5" checked>
                    <label for="star5">‚≠ê</label>
                </div>
                <textarea id="commentInput" placeholder="Partagez votre avis sur ce produit..."></textarea>
                <button onclick="submitComment()" class="btn-submit-comment">
                    Publier le commentaire
                </button>
            </div>

            <!-- Liste des commentaires -->
            <div id="commentsList" class="comments-list"></div>
        </div>
    </div>

    <!-- Boutons d'action -->
    <div class="action-buttons">
        <button id="btnAcheter" class="btn-primary">
            üõí Acheter maintenant
        </button>
        <button id="btnWhatsApp" class="btn-secondary">
            üì± Contacter sur WhatsApp
        </button>
    </div>
    <script type="module">
        // ==================== PARTIE 2/4 : CONFIGURATION & CHARGEMENT DES DONN√âES ====================
        
        // Configuration Supabase
        const SUPABASE_URL = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== VARIABLES GLOBALES ====================
        let currentProduct = null;
        let currentUser = null;
        let shopConfig = null;
        let productLikes = { count: 0, userLiked: false };
        let productComments = [];
        let currentUserId = getUserId();
        let currentImageIndex = 0;
        let allImages = [];
        
        
        // ==================== FONCTIONS UTILITAIRES ====================
        
        function getUserId() {
            let userId = localStorage.getItem('oda_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('oda_user_id', userId);
            }
            return userId;
        }
        
        function getUserName() {
            let userName = localStorage.getItem('oda_user_name');
            if (!userName) {
                userName = prompt('Entrez votre nom pour commenter:') || 'Anonyme';
                localStorage.setItem('oda_user_name', userName);
            }
            return userName;
        }
        
        function formatPrice(price, devise = 'FCFA') {
            return `${price.toLocaleString('fr-FR')} ${devise}`;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Aujourd\'hui';
            if (diffDays === 1) return 'Hier';
            if (diffDays < 7) return `Il y a ${diffDays} jours`;
            if (diffDays < 30) return `Il y a ${Math.floor(diffDays / 7)} semaines`;
            return date.toLocaleDateString('fr-FR');
        }
        
        function afficherNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            const notificationIcon = document.getElementById('notificationIcon');
            
            if (!notification || !notificationText || !notificationIcon) return;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notificationIcon.textContent = icons[type] || icons.info;
            notificationText.textContent = message;
            notification.className = `notification show ${type}`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ==================== CHARGEMENT PRODUIT ====================
        
        async function chargerProduit() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                if (!productId) {
                    throw new Error('ID produit manquant');
                }
                
                console.log('üì¶ Chargement du produit:', productId);
                
                const { data: product, error: productError } = await supabase
                    .from('produits')
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (productError) throw productError;
                if (!product) throw new Error('Produit non trouv√©');
                
                currentProduct = product;
                console.log('‚úÖ Produit charg√©:', product);
                
                // Charger la configuration de la boutique
                await chargerConfigurationBoutique(product.user_id);
                
                // Charger les likes et commentaires en parall√®le
                await Promise.all([
                    chargerLikes(productId),
                    chargerCommentaires(productId)
                ]);
                
                // Afficher le produit
                afficherProduit();
                
                // Masquer le loader
                document.getElementById('loader').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Erreur chargement produit:', error);
                afficherNotification('Erreur lors du chargement du produit', 'error');
                
                setTimeout(() => {
                    window.location.href = 'oda-achats.html';
                }, 2000);
            }
        }
        
        // ==================== CHARGEMENT CONFIGURATION BOUTIQUE ====================
        
        async function chargerConfigurationBoutique(userId) {
            try {
                console.log(`üîç Chargement config boutique pour user: ${userId}`);
                
                const { data, error } = await supabase
                    .from('parametres_boutique')
                    .select('config')
                    .eq('user_id', userId)
                    .single();
                
                if (data && !error) {
                    shopConfig = data.config;
                    console.log('‚úÖ Configuration boutique charg√©e');
                    console.log('üè™ Nom boutique:', shopConfig?.general?.nom);
                    console.log('üîó Slug boutique:', shopConfig?.identifiant?.slug);
                    appliquerConfigurationBoutique();
                } else {
                    console.warn('‚ö†Ô∏è Config boutique non trouv√©e, utilisation config par d√©faut');
                    shopConfig = getDefaultShopConfig();
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement config boutique:', error);
                shopConfig = getDefaultShopConfig();
            }
        }
        
        function getDefaultShopConfig() {
            return {
                general: {
                    nom: 'Ma Boutique',
                    telephone: '',
                    email: ''
                },
                apparence: {
                    couleurPrimaire: '#FF6B00',
                    couleurSecondaire: '#1A1A1A'
                },
                paiement: {
                    devise: 'FCFA',
                    carte: { actif: false },
                    mobile: { actif: true },
                    cash: { actif: true }
                },
                identifiant: {
                    slug: ''
                }
            };
        }
        
        function appliquerConfigurationBoutique() {
            if (!shopConfig) return;
            
            const { couleurPrimaire, couleurSecondaire } = shopConfig.apparence || {};
            
            if (couleurPrimaire) {
                document.documentElement.style.setProperty('--primary-color', couleurPrimaire);
                document.documentElement.style.setProperty('--primary-dark', couleurPrimaire + 'dd');
            }
            
            if (couleurSecondaire) {
                document.documentElement.style.setProperty('--text-primary', couleurSecondaire);
            }
            
            console.log('üé® Configuration boutique appliqu√©e');
        }
        
        // ==================== CHARGEMENT LIKES ====================
        
        async function chargerLikes(productId) {
            try {
                const { data: likes, error } = await supabase
                    .from('product_likes')
                    .select('user_id')
                    .eq('product_id', productId);
                
                if (error) throw error;
                
                productLikes = {
                    count: likes.length,
                    userLiked: likes.some(like => like.user_id === currentUserId)
                };
                
                console.log(`üëç ${productLikes.count} likes charg√©s`);
            } catch (error) {
                console.error('Erreur chargement likes:', error);
                productLikes = { count: 0, userLiked: false };
            }
        }
        
        // ==================== CHARGEMENT COMMENTAIRES ====================
        
        async function chargerCommentaires(productId) {
            try {
                const { data: comments, error } = await supabase
                    .from('product_comments')
                    .select('*')
                    .eq('product_id', productId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                productComments = comments || [];
                console.log(`üí¨ ${productComments.length} commentaires charg√©s`);
            } catch (error) {
                console.error('Erreur chargement commentaires:', error);
                productComments = [];
            }
        }
        
        // ==================== AFFICHAGE PRODUIT ====================
        
        function afficherProduit() {
            if (!currentProduct) return;
            
            const devise = shopConfig?.paiement?.devise || 'FCFA';
            
            // Mise √† jour des informations
            document.title = `${currentProduct.nom} - ODA Marketplace`;
            document.getElementById('headerTitle').textContent = currentProduct.nom;
            document.getElementById('productName').textContent = currentProduct.nom;
            document.getElementById('productCategory').textContent = `üì¶ ${currentProduct.categorie || 'Produit'}`;
            document.getElementById('productPrice').textContent = formatPrice(currentProduct.prix, devise);
            document.getElementById('productDescription').textContent = currentProduct.description || 'Aucune description disponible.';
            
            // Afficher les diff√©rentes sections
            afficherStock();
            initialiserCarousel();
            afficherEngagement();
            afficherCommentaires();
            mettreAJourBoutonBoutique();
            
            console.log('‚úÖ Produit affich√©');
        }
        
        function afficherStock() {
            const stock = currentProduct.stock || 0;
            const stockIcon = document.getElementById('stockIcon');
            const stockText = document.getElementById('stockText');
            const stockQuantity = document.getElementById('stockQuantity');
            
            if (stock > 10) {
                stockIcon.textContent = '‚úÖ';
                stockText.textContent = 'En stock';
                stockQuantity.textContent = `‚Ä¢ ${stock} disponibles`;
            } else if (stock > 0) {
                stockIcon.textContent = '‚ö†Ô∏è';
                stockText.textContent = 'Stock limit√©';
                stockQuantity.textContent = `‚Ä¢ Plus que ${stock} !`;
            } else {
                stockIcon.textContent = '‚ùå';
                stockText.textContent = 'Rupture de stock';
                stockQuantity.textContent = '';
            }
        }
        
        function mettreAJourBoutonBoutique() {
            const shopNameEl = document.getElementById('shopName');
            if (shopNameEl && shopConfig?.general?.nom) {
                shopNameEl.textContent = shopConfig.general.nom;
            }
        }
        
        // ==================== EXPORTS ====================
        
        window.chargerProduit = chargerProduit;
        window.chargerConfigurationBoutique = chargerConfigurationBoutique;
        window.chargerLikes = chargerLikes;
        window.chargerCommentaires = chargerCommentaires;
        window.afficherNotification = afficherNotification;
        window.formatPrice = formatPrice;
        window.formatDate = formatDate;
        window.getUserName = getUserName;
        window.afficherProduit = afficherProduit;
        
        console.log('‚úÖ Module 2: Configuration et chargement des donn√©es - Charg√©');


// ==================== INITIALISATION CARROUSEL ====================

function initialiserCarousel() {
    allImages = [];
    
    console.log('üñºÔ∏è ========== INITIALISATION CARROUSEL ==========');
    console.log('üìã Donn√©es produit:');
    console.log('  main_image:', currentProduct.main_image);
    console.log('  description_images:', currentProduct.description_images);
    console.log('  images:', currentProduct.images);
    console.log('  additional_images:', currentProduct.additional_images);
    
    // √âtape 1: Extraire l'image principale
    const mainImageUrl = extraireImagePrincipale();
    
    // √âtape 2: Extraire les images suppl√©mentaires
    const imagesSupplementaires = extraireImagesSupplementaires();
    
    // √âtape 3: Construire le tableau dans le bon ordre
    construireTableauImages(mainImageUrl, imagesSupplementaires);
    
    // √âtape 4: D√©dupliquer en pr√©servant la principale
    dedupliquerImagesAvecPriorite();
    
    // √âtape 5: Ajouter fallback si vide (CORRECTION ICI ‚úÖ)
    ajouterFallbackSiVide();
    
    // √âtape 6: Afficher le carrousel (M√äME AVEC 1 IMAGE ‚úÖ)
    afficherCarousel();
    
    // √âtape 7: Afficher les statistiques
    afficherStatistiques();
}

// ==================== EXTRACTION IMAGE PRINCIPALE ====================

function extraireImagePrincipale() {
    if (!currentProduct.main_image) {
        console.warn('‚ö†Ô∏è Pas de main_image d√©finie');
        return null;
    }
    
    const mainImg = String(currentProduct.main_image).trim();
    
    if (!mainImg || mainImg === '' || mainImg === 'null' || mainImg === 'undefined') {
        console.warn('‚ö†Ô∏è main_image invalide:', mainImg);
        return null;
    }
    
    if (mainImg.startsWith('http') || mainImg.startsWith('/') || mainImg.startsWith('data:')) {
        console.log('‚úÖ Image principale d√©tect√©e:', mainImg.substring(0, 80) + '...');
        return mainImg;
    }
    
    console.warn('‚ö†Ô∏è main_image ne ressemble pas √† une URL:', mainImg.substring(0, 50));
    return null;
}

// ==================== EXTRACTION IMAGES SUPPL√âMENTAIRES ====================

function extraireImagesSupplementaires() {
    const sources = [
        { nom: 'additional_images', data: currentProduct.additional_images },
        { nom: 'description_images', data: currentProduct.description_images },
        { nom: 'images', data: currentProduct.images }
    ];
    
    let toutesLesImages = [];
    
    sources.forEach(source => {
        if (!source.data) return;
        
        console.log(`üîç Traitement de "${source.nom}":`, typeof source.data);
        
        const images = parseImages(source.data, source.nom);
        
        if (images.length > 0) {
            console.log(`  ‚úÖ ${images.length} image(s) trouv√©e(s) dans ${source.nom}`);
            toutesLesImages.push(...images);
        }
    });
    
    return toutesLesImages;
}

// ==================== PARSING DES IMAGES ====================

function parseImages(data, sourceName) {
    // Format: Tableau direct
    if (Array.isArray(data)) {
        console.log(`  üì¶ ${sourceName}: Tableau direct`);
        return filtrerURLsValides(data);
    }
    
    // Format: String
    if (typeof data === 'string') {
        const trimmed = data.trim();
        
        if (!trimmed || trimmed === 'null' || trimmed === 'undefined') {
            return [];
        }
        
        // Format: JSON array
        if (trimmed.startsWith('[')) {
            console.log(`  üì¶ ${sourceName}: JSON array`);
            return parseJSONArray(trimmed, sourceName);
        }
        
        // Format: JSON object
        if (trimmed.startsWith('{')) {
            console.log(`  üì¶ ${sourceName}: JSON object`);
            return parseJSONObject(trimmed, sourceName);
        }
        
        // Format: URL unique
        if (estURLValide(trimmed)) {
            console.log(`  üì¶ ${sourceName}: URL unique`);
            return [trimmed];
        }
        
        // Format: URLs s√©par√©es par virgules
        if (trimmed.includes(',')) {
            console.log(`  üì¶ ${sourceName}: URLs s√©par√©es par virgules`);
            return trimmed.split(',')
                .map(url => url.trim())
                .filter(estURLValide);
        }
        
        console.warn(`  ‚ö†Ô∏è ${sourceName}: Format non reconnu`);
        return [];
    }
    
    // Format: Objet
    if (typeof data === 'object' && data !== null) {
        console.log(`  üì¶ ${sourceName}: Objet`);
        return Object.values(data)
            .filter(v => typeof v === 'string')
            .filter(estURLValide);
    }
    
    return [];
}

function parseJSONArray(jsonString, sourceName) {
    try {
        let parsed = JSON.parse(jsonString);
        
        // Double parsing si n√©cessaire
        if (typeof parsed === 'string') {
            try {
                parsed = JSON.parse(parsed);
            } catch (e) {
                console.warn(`  ‚ö†Ô∏è Double parsing √©chou√© pour ${sourceName}`);
            }
        }
        
        if (Array.isArray(parsed)) {
            return filtrerURLsValides(parsed);
        }
        
        console.warn(`  ‚ö†Ô∏è ${sourceName}: Parse JSON OK mais pas un array`);
        return [];
        
    } catch (error) {
        console.error(`  ‚ùå ${sourceName}: Erreur parse JSON:`, error.message);
        return [];
    }
}

function parseJSONObject(jsonString, sourceName) {
    try {
        const parsed = JSON.parse(jsonString);
        
        if (typeof parsed === 'object' && parsed !== null) {
            return Object.values(parsed)
                .filter(v => typeof v === 'string')
                .filter(estURLValide);
        }
        
        return [];
        
    } catch (error) {
        console.error(`  ‚ùå ${sourceName}: Erreur parse object:`, error.message);
        return [];
    }
}

function filtrerURLsValides(array) {
    return array
        .filter(item => item && typeof item === 'string')
        .map(item => item.trim())
        .filter(item => item !== '' && item !== 'null' && item !== 'undefined')
        .filter(estURLValide);
}

function estURLValide(str) {
    if (!str || typeof str !== 'string') return false;
    const trimmed = str.trim();
    return trimmed.startsWith('http') || 
           trimmed.startsWith('/') || 
           trimmed.startsWith('data:');
}

// ==================== CONSTRUCTION DU TABLEAU ====================

function construireTableauImages(mainImageUrl, imagesSupplementaires) {
    allImages = [];
    
    if (mainImageUrl) {
        allImages.push(mainImageUrl);
        console.log('üéØ Image principale ajout√©e en position 1');
        console.log(`   URL: ${mainImageUrl.substring(0, 80)}...`);
        
        // Retirer la principale des suppl√©mentaires
        imagesSupplementaires = imagesSupplementaires.filter(img => img !== mainImageUrl);
        console.log(`   ‚úÖ Image principale retir√©e des suppl√©mentaires (${imagesSupplementaires.length} restantes)`);
    } else {
        console.warn('‚ö†Ô∏è Aucune image principale');
    }
    
    // Ajouter les images suppl√©mentaires
    imagesSupplementaires.forEach((img, index) => {
        allImages.push(img);
        console.log(`  ‚úÖ [${allImages.length}] Image suppl√©mentaire ajout√©e`);
    });
    
    console.log(`üìä Total avant d√©duplication: ${allImages.length} images`);
}

// ==================== D√âDUPLICATION AVEC PRIORIT√â ====================

function dedupliquerImagesAvecPriorite() {
    if (allImages.length === 0) return;
    
    // ‚úÖ CAS SP√âCIAL : Une seule image, pas besoin de d√©dupliquer
    if (allImages.length === 1) {
        console.log('‚úÖ Une seule image, pas de d√©duplication n√©cessaire');
        return;
    }
    
    const imagePrincipale = allImages[0];
    const autresImages = allImages.slice(1);
    
    // D√©dupliquer les autres images
    const autresImagesDedupliquees = [...new Set(autresImages)];
    
    // Retirer l'image principale des autres si elle appara√Æt
    const autresImagesSansPrincipale = autresImagesDedupliquees.filter(
        img => img !== imagePrincipale
    );
    
    // Reconstruire le tableau
    const avant = allImages.length;
    allImages = [imagePrincipale, ...autresImagesSansPrincipale];
    const apres = allImages.length;
    
    if (avant !== apres) {
        console.log(`üîÑ D√©duplication avec priorit√©: ${avant} ‚Üí ${apres} images`);
    }
    console.log(`   ‚úÖ Image principale pr√©serv√©e en position 1`);
}

// ==================== FALLBACK ====================

function ajouterFallbackSiVide() {
    if (allImages.length === 0) {
        console.warn('‚ö†Ô∏è Aucune image valide, ajout placeholder');
        allImages.push('https://via.placeholder.com/600x600?text=Aucune+Image');
    }
}

// ==================== AFFICHAGE ====================

function afficherCarousel() {
    currentImageIndex = 0;
    
    // ‚úÖ CORRECTION : Toujours afficher l'image, m√™me si une seule
    afficherImageCourante();
    
    // ‚úÖ CORRECTION : Miniatures uniquement si plusieurs images
    if (allImages.length > 1) {
        genererThumbnails();
    } else {
        masquerThumbnails();
    }
    
    ajouterGestionZoom();
    
    const imageText = allImages.length === 1 ? 'image unique' : `${allImages.length} images`;
    console.log(`üéØ Carrousel initialis√© - ${imageText}`);
}

function afficherImageCourante() {
    const mainImage = document.getElementById('mainImage');
    const imageCounter = document.getElementById('imageCounter');
    
    if (!mainImage) {
        console.error('‚ùå √âl√©ment #mainImage introuvable !');
        return;
    }
    
    if (allImages.length === 0) {
        console.error('‚ùå Aucune image √† afficher !');
        return;
    }
    
    const currentUrl = allImages[currentImageIndex];
    
    console.log(`üñºÔ∏è Affichage image ${currentImageIndex + 1}/${allImages.length}`);
    if (currentImageIndex === 0) {
        console.log('  üéØ ‚úÖ IMAGE PRINCIPALE AFFICH√âE');
    }
    
    // ‚úÖ CORRECTION : Mise √† jour du compteur (masqu√© si 1 seule image)
    if (imageCounter) {
        if (allImages.length > 1) {
            imageCounter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
            imageCounter.style.display = 'block';
        } else {
            imageCounter.style.display = 'none';
        }
    }
    
    // ‚úÖ CORRECTION : Affichage IMM√âDIAT puis pr√©chargement
    mainImage.style.opacity = '0.5';
    mainImage.src = currentUrl;
    
    // Pr√©chargement pour v√©rifier si l'image charge
    const preloadImg = new Image();
    preloadImg.onload = () => {
        mainImage.style.opacity = '1';
        console.log('  ‚úÖ Image charg√©e avec succ√®s');
    };
    preloadImg.onerror = () => {
        console.error('  ‚ùå Erreur chargement:', currentUrl.substring(0, 100));
        mainImage.src = 'https://via.placeholder.com/600x600?text=Image+non+disponible';
        mainImage.style.opacity = '1';
    };
    preloadImg.src = currentUrl;
}

function genererThumbnails() {
    const container = document.getElementById('thumbnailsContainer');
    if (!container) return;
    
    container.style.display = 'flex';
    
    container.innerHTML = allImages.map((img, index) => `
        <img src="${img}" 
             class="thumbnail ${index === 0 ? 'active' : ''}" 
             onclick="changerImage(${index})"
             alt="Miniature ${index + 1}${index === 0 ? ' (üéØ Principale)' : ''}"
             title="${index === 0 ? 'üéØ Image principale' : `Image ${index + 1}`}"
             loading="lazy"
             onerror="this.src='https://via.placeholder.com/70x70?text=${index + 1}'"
             data-index="${index}"
             ${index === 0 ? 'style="border-color: var(--primary-color); box-shadow: 0 0 8px rgba(255,107,0,0.5);"' : ''}>
    `).join('');
    
    console.log(`‚úÖ ${allImages.length} miniatures g√©n√©r√©es`);
}

function masquerThumbnails() {
    const container = document.getElementById('thumbnailsContainer');
    if (container) {
        container.style.display = 'none';
        console.log('üì∏ Une seule image, miniatures masqu√©es');
    }
}

window.changerImage = function(index) {
    if (index < 0 || index >= allImages.length) {
        console.warn(`‚ö†Ô∏è Index invalide: ${index}`);
        return;
    }
    
    currentImageIndex = index;
    afficherImageCourante();
    
    // Mise √† jour des miniatures
    document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
        
        // Mise en valeur de la principale
        if (i === 0) {
            thumb.style.borderColor = 'var(--primary-color)';
            thumb.style.boxShadow = '0 0 8px rgba(255,107,0,0.5)';
        } else if (i === index && i !== 0) {
            thumb.style.borderColor = 'var(--primary-color)';
            thumb.style.boxShadow = 'none';
        } else {
            thumb.style.borderColor = 'transparent';
            thumb.style.boxShadow = 'none';
        }
    });
    
    console.log(`üìç Image ${index + 1}/${allImages.length} s√©lectionn√©e${index === 0 ? ' (üéØ Principale)' : ''}`);
};

function ajouterGestionZoom() {
    const mainImageWrapper = document.getElementById('mainImageWrapper');
    const mainImage = document.getElementById('mainImage');
    
    if (!mainImageWrapper || !mainImage) return;
    
    // Supprimer les anciens √©v√©nements
    const newWrapper = mainImageWrapper.cloneNode(true);
    mainImageWrapper.parentNode.replaceChild(newWrapper, mainImageWrapper);
    
    // Ajouter le nouvel √©v√©nement
    document.getElementById('mainImageWrapper').addEventListener('click', () => {
        document.getElementById('mainImage').classList.toggle('zoom');
    });
}

// ==================== STATISTIQUES ====================

function afficherStatistiques() {
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log(`üì∏ R√âSULTAT: ${allImages.length} image(s) dans le carrousel`);
    
    if (allImages.length === 1) {
        console.log('   ‚úÖ IMAGE UNIQUE (comportement normal)');
    } else {
        console.log('   Ordre des images:');
    }
    
    allImages.forEach((img, i) => {
        const isMain = i === 0;
        const prefix = isMain ? 'üéØ [PRINCIPALE]' : `   [${i + 1}]`;
        const preview = img.length > 80 ? img.substring(0, 80) + '...' : img;
        console.log(`${prefix} ${preview}`);
    });
    
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
}

// ==================== FONCTION DE V√âRIFICATION POUR DEBUG ====================

window.verifierImagePrincipale = function() {
    console.log('üîç V√âRIFICATION IMAGE PRINCIPALE');
    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log(`üìä √âtat actuel :`);
    console.log(`   - Total images : ${allImages.length}`);
    console.log(`   - Index actuel : ${currentImageIndex}`);
    console.log(`   - Image affich√©e : ${currentImageIndex === 0 ? 'üéØ PRINCIPALE' : `Suppl√©mentaire #${currentImageIndex + 1}`}`);
    console.log('');
    console.log('üìã Donn√©es produit :');
    console.log(`   - main_image : ${currentProduct?.main_image?.substring(0, 80)}...`);
    console.log('');
    
    if (allImages.length > 0) {
        console.log('üñºÔ∏è Premi√®re image du carrousel :');
        console.log(`   ${allImages[0]?.substring(0, 80)}...`);
        console.log('');
        console.log(`‚úÖ Correspondance : ${currentProduct?.main_image === allImages[0] ? 'OUI ‚úì' : 'NON ‚úó'}`);
    } else {
        console.log('‚ùå AUCUNE IMAGE dans le carrousel !');
    }
    
    console.log('');
    console.log('üîç V√©rification DOM :');
    const mainImage = document.getElementById('mainImage');
    console.log(`   - √âl√©ment #mainImage existe : ${!!mainImage}`);
    console.log(`   - Source actuelle : ${mainImage?.src?.substring(0, 80)}...`);
    console.log(`   - Visible : ${mainImage?.style.display !== 'none'}`);
    
    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
    
    return currentProduct?.main_image === allImages[0];
};

// ==================== EXPORTS ====================

window.initialiserCarousel = initialiserCarousel;
window.afficherImageCourante = afficherImageCourante;
window.genererThumbnails = genererThumbnails;
window.dedupliquerImagesAvecPriorite = dedupliquerImagesAvecPriorite;

console.log('‚úÖ Module Carrousel (version corrig√©e 1 image) - Charg√©');
// ==================== AFFICHAGE ENGAGEMENT ====================

function afficherEngagement() {
    document.getElementById('likesCount').textContent = productLikes.count;
    
    const btnLike = document.getElementById('btnLike');
    const likeIcon = document.getElementById('likeIcon');
    const likeText = document.getElementById('likeText');
    
    if (productLikes.userLiked) {
        btnLike.classList.add('liked');
        likeIcon.textContent = '‚ù§Ô∏è';
        likeText.textContent = 'Aim√©';
    } else {
        btnLike.classList.remove('liked');
        likeIcon.textContent = 'ü§ç';
        likeText.textContent = 'J\'aime';
    }
    
    document.getElementById('commentsCount').textContent = productComments.length;
    
    const averageRating = calculerNoteMoyenne();
    document.getElementById('averageRating').textContent = averageRating;
}

function calculerNoteMoyenne() {
    if (productComments.length === 0) return '0.0';
    
    const sum = productComments.reduce((acc, comment) => acc + (comment.rating || 0), 0);
    return (sum / productComments.length).toFixed(1);
}

// ==================== TOGGLE LIKE ====================

async function toggleLike() {
    if (!currentProduct) return;
    
    const btnLike = document.getElementById('btnLike');
    btnLike.disabled = true;
    
    try {
        if (productLikes.userLiked) {
            const { error } = await supabase
                .from('product_likes')
                .delete()
                .eq('product_id', currentProduct.id)
                .eq('user_id', currentUserId);
            
            if (error) throw error;
            
            productLikes.count = Math.max(0, productLikes.count - 1);
            productLikes.userLiked = false;
            afficherNotification('Like retir√©', 'info');
        } else {
            const { error } = await supabase
                .from('product_likes')
                .insert({
                    product_id: currentProduct.id,
                    user_id: currentUserId
                });
            
            if (error) throw error;
            
            productLikes.count++;
            productLikes.userLiked = true;
            afficherNotification('Produit lik√© !', 'success');
        }
        
        afficherEngagement();
    } catch (error) {
        console.error('Erreur toggle like:', error);
        afficherNotification('Erreur lors du like', 'error');
    } finally {
        btnLike.disabled = false;
    }
}

// ==================== AFFICHAGE COMMENTAIRES ====================

function afficherCommentaires() {
    const commentsList = document.getElementById('commentsList');
    
    if (!commentsList) return;
    
    if (productComments.length === 0) {
        commentsList.innerHTML = `
            <div class="empty-comments">
                <p style="font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">
                    Aucun commentaire pour l'instant
                </p>
                <p>Soyez le premier √† donner votre avis !</p>
            </div>
        `;
        return;
    }
    
    commentsList.innerHTML = productComments.map(comment => `
        <div class="comment-item">
            <div class="comment-header">
                <div class="comment-user">
                    <div class="user-avatar">${comment.user_name.charAt(0).toUpperCase()}</div>
                    <span class="user-name">${comment.user_name}</span>
                </div>
                <div class="comment-rating">${'‚≠ê'.repeat(comment.rating || 5)}</div>
            </div>
            <p class="comment-text">${comment.comment}</p>
            <span class="comment-date">${formatDate(comment.created_at)}</span>
        </div>
    `).join('');
}

// ==================== SOUMETTRE COMMENTAIRE ====================

async function submitComment() {
    const commentInput = document.getElementById('commentInput');
    const ratingInput = document.querySelector('input[name="rating"]:checked');
    
    if (!commentInput || !ratingInput) return;
    
    const comment = commentInput.value.trim();
    const rating = parseInt(ratingInput.value);
    
    if (!comment) {
        afficherNotification('Le commentaire ne peut pas √™tre vide', 'error');
        return;
    }
    
    if (!currentProduct) return;
    
    const userName = getUserName();
    
    try {
        const { data, error } = await supabase
            .from('product_comments')
            .insert({
                product_id: currentProduct.id,
                user_id: currentUserId,
                user_name: userName,
                comment: comment,
                rating: rating
            })
            .select()
            .single();
        
        if (error) throw error;
        
        productComments.unshift(data);
        
        commentInput.value = '';
        document.querySelector('input[name="rating"][value="5"]').checked = true;
        
        afficherCommentaires();
        afficherEngagement();
        
        afficherNotification('Commentaire ajout√© !', 'success');
    } catch (error) {
        console.error('Erreur ajout commentaire:', error);
        afficherNotification('Erreur lors de l\'ajout du commentaire', 'error');
    }
}

window.scrollToComments = function() {
    const commentsSection = document.getElementById('commentsSection');
    if (commentsSection) {
        commentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
};

window.submitComment = submitComment;

// ==================== BOUTONS D'ACTION ====================

function initialiserBoutonsAction() {
    const btnBack = document.getElementById('btnBack');
    if (btnBack) {
        btnBack.addEventListener('click', () => {
            window.history.back();
        });
    }
    
    const btnShare = document.getElementById('btnShare');
    if (btnShare) {
        btnShare.addEventListener('click', partagerProduit);
    }
    
    const btnLike = document.getElementById('btnLike');
    if (btnLike) {
        btnLike.addEventListener('click', toggleLike);
    }
    
    const btnAcheter = document.getElementById('btnAcheter');
    if (btnAcheter) {
        btnAcheter.addEventListener('click', () => {
            afficherNotification('Fonctionnalit√© d\'achat √† venir !', 'info');
        });
    }
    
    const btnWhatsApp = document.getElementById('btnWhatsApp');
    if (btnWhatsApp) {
        btnWhatsApp.addEventListener('click', contacterWhatsApp);
    }
    
    const btnBoutique = document.getElementById('btnBoutique');
    if (btnBoutique) {
        btnBoutique.addEventListener('click', allerBoutique);
    }
    
    console.log('‚úÖ Boutons d\'action initialis√©s');
}

// ==================== PARTAGER PRODUIT ====================

async function partagerProduit() {
    if (!currentProduct) return;
    
    const url = window.location.href;
    const text = `D√©couvrez ${currentProduct.nom} sur ODA Marketplace`;
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: currentProduct.nom,
                text: text,
                url: url
            });
            console.log('‚úÖ Partage r√©ussi');
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Erreur partage:', error);
            }
        }
    } else {
        try {
            await navigator.clipboard.writeText(url);
            afficherNotification('Lien copi√© dans le presse-papiers !', 'success');
        } catch (error) {
            afficherNotification('Impossible de copier le lien', 'error');
        }
    }
}

// ==================== CONTACTER SUR WHATSAPP ====================

function contacterWhatsApp() {
    if (!currentProduct) return;
    
    const telephone = shopConfig?.general?.telephone || '';
    
    if (!telephone) {
        afficherNotification('Num√©ro WhatsApp non disponible', 'error');
        return;
    }
    
    const phoneNumber = telephone.replace(/\D/g, '');
    
    const message = encodeURIComponent(
        `Bonjour, je suis int√©ress√©(e) par ce produit :\n\n` +
        `üì¶ ${currentProduct.nom}\n` +
        `üí∞ ${formatPrice(currentProduct.prix, shopConfig?.paiement?.devise || 'FCFA')}\n\n` +
        `Lien : ${window.location.href}`
    );
    
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
    window.open(whatsappUrl, '_blank');
    
    console.log('üì± WhatsApp ouvert');
}

// ==================== ALLER √Ä LA BOUTIQUE ====================

async function allerBoutique() {
    if (!currentProduct) {
        afficherNotification('Impossible de charger la boutique', 'error');
        return;
    }
    
    try {
        console.log('üè™ Redirection vers la boutique...');
        console.log('User ID du vendeur:', currentProduct.user_id);
        
        let slug = null;
        
        // Essayer de r√©cup√©rer le slug depuis shopConfig
        if (shopConfig?.identifiant?.slug) {
            slug = shopConfig.identifiant.slug;
            console.log('‚úÖ Slug trouv√© dans shopConfig:', slug);
        }
        
        // Si pas de slug, le chercher dans Supabase
        if (!slug) {
            console.log('üîç Recherche du slug dans Supabase...');
            
            const { data, error } = await supabase
                .from('parametres_boutique')
                .select('config')
                .eq('user_id', currentProduct.user_id)
                .single();
            
            if (data && !error && data.config?.identifiant?.slug) {
                slug = data.config.identifiant.slug;
                console.log('‚úÖ Slug trouv√© dans Supabase:', slug);
            } else if (data && !error && data.config?.slug) {
                slug = data.config.slug;
                console.log('‚úÖ Slug trouv√© (ancienne structure):', slug);
            } else {
                console.warn('‚ö†Ô∏è Aucun slug trouv√© dans Supabase');
            }
        }
        
        // Fallback : utiliser le user_id
        if (!slug) {
            console.log('‚ö†Ô∏è Aucun slug trouv√©, utilisation du user_id comme fallback');
            slug = currentProduct.user_id;
        }
        
        const urlBoutique = `${window.location.origin}/boutique.html?shop=${slug}`;
        console.log('üîó URL de redirection:', urlBoutique);
        
        afficherNotification('Redirection vers la boutique...', 'info');
        
        setTimeout(() => {
            window.location.href = urlBoutique;
        }, 500);
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la redirection vers la boutique:', error);
        afficherNotification('Erreur lors de l\'acc√®s √† la boutique', 'error');
    }
}

// ==================== INITIALISATION COMPL√àTE ====================

async function initialiserPageProduit() {
    console.log('üöÄ ========== INITIALISATION PAGE PRODUIT ==========');
    
    try {
        // Charger le produit
        await chargerProduit();
        
        // Initialiser les boutons
        initialiserBoutonsAction();
        
        console.log('‚úÖ ========== PAGE PRODUIT INITIALIS√âE ==========');
        
    } catch (error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        afficherNotification('Erreur de chargement', 'error');
    }
}

// ==================== LANCEMENT AU CHARGEMENT DU DOM ====================

document.addEventListener('DOMContentLoaded', async () => {
    console.log('üìÑ DOM charg√©');
    console.log('üéØ Lancement de l\'initialisation...');
    
    await initialiserPageProduit();
    
    console.log('üéâ Application pr√™te !');
});

// ==================== EXPORTS ====================

window.afficherEngagement = afficherEngagement;
window.afficherCommentaires = afficherCommentaires;
window.toggleLike = toggleLike;
window.partagerProduit = partagerProduit;
window.contacterWhatsApp = contacterWhatsApp;
window.allerBoutique = allerBoutique;
window.initialiserPageProduit = initialiserPageProduit;

// ==================== CONSOLE LOG FINAL ====================

console.log('%cüõí MODULE PAGE PRODUIT CHARG√â', 'color: #FF6B00; font-size: 24px; font-weight: bold;');
console.log('%c‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì', 'color: #FF6B00;');
console.log('%c‚ú® Tapez debugProduit() pour voir les d√©tails', 'color: #34C759; font-size: 12px;');
console.log('%cüîÑ Tapez forceReload() pour recharger', 'color: #34C759; font-size: 12px;');
console.log('%cüñºÔ∏è Tapez verifierImagePrincipale() pour v√©rifier le carrousel', 'color: #34C759; font-size: 12px;');
console.log('%c‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ', 'color: #FF6B00;');

console.log('‚úÖ Module 4: Engagement, commentaires et actions - Charg√©');

        
    </script>
</body>
</html>
